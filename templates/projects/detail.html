{% extends 'base.html' %}
{% load coordinate_filters %}
{% block title %}{{ project.name }} ‚Äî –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞{% endblock %}
{% block content %}
<div class="py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li>
                                <a href="/" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-home"></i>
                                    –ì–ª–∞–≤–Ω–∞—è
                                </a>
                            </li>
                            <li>
                                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                                <a href="/projects/" class="text-gray-500 hover:text-gray-700">–û–±—ä–µ–∫—Ç—ã</a>
                            </li>
                            <li>
                                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                                <span class="text-gray-900">{{ project.name }}</span>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-3xl font-bold text-gray-900">{{ project.name }}</h1>
                    <p class="mt-2 text-sm text-gray-600">{{ project.address }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-3 py-1 text-sm rounded-full 
                        {% if project.status == 'active' %}bg-blue-100 text-blue-800
                        {% elif project.status == 'completed' %}bg-green-100 text-green-800
                        {% elif project.status == 'suspended' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ project.get_status_display }}
                    </span>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary-blue">{{ project.completion_percentage }}%</div>
                        <div class="text-sm text-gray-500">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-boxes text-2xl text-accent-peach"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ stats.materials_delivered }} / {{ stats.materials_total }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-2xl text-accent-red"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–û—Ç–∫—Ä—ã—Ç—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ stats.violations_open }} / {{ stats.violations_total }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar text-2xl text-primary-blue"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–ü–ª–∞–Ω–æ–≤–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.planned_end_date|date:"d.m.Y"|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-user-tie text-2xl text-secondary-blue"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–ü—Ä–æ—Ä–∞–±</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.foreman.get_full_name|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- –ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-map-marked-alt text-primary-blue mr-2"></i>
                            –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                        </h3>
                        <div class="flex space-x-2">
                            <select id="map-provider" class="text-sm border border-gray-300 rounded px-3 py-1 bg-white">
                                <option value="osm" selected>üó∫Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="satellite">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div id="map-loading" class="flex items-center justify-center h-96 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue mb-2"></div>
                            <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                        </div>
                    </div>
                    <div id="map" class="h-96 rounded-lg" style="display: none;"></div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-info-circle text-accent-peach mr-2"></i>
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
                    </h3>
                </div>
                <div class="p-6">
                    <dl class="space-y-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–û–ø–∏—Å–∞–Ω–∏–µ</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ project.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–ü–ª–∞–Ω–æ–≤–æ–µ –Ω–∞—á–∞–ª–æ</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.planned_start_date|date:"d.m.Y"|default:"‚Äî" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∞–ª–æ</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.actual_start_date|date:"d.m.Y"|default:"‚Äî" }}</dd>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–ü–ª–∞–Ω–æ–≤–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.planned_end_date|date:"d.m.Y"|default:"‚Äî" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.actual_end_date|date:"d.m.Y"|default:"‚Äî" }}</dd>
                            </div>
                        </div>
                        
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞</dt>
                            <dd class="mt-1">
                                <div class="flex items-center">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                                        <div class="bg-primary-blue h-2 rounded-full" style="width: {{ project.completion_percentage }}%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900">{{ project.completion_percentage }}%</span>
                                </div>
                            </dd>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–ö–æ–Ω—Ç—Ä–æ–ª—å</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.control_service.get_full_name|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">–ü—Ä–æ—Ä–∞–±</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ project.foreman.get_full_name|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}</dd>
                            </div>
                        </div>
                    </dl>
                </div>
            </div>
        </div>


        <!-- –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
        <div class="mt-8">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 shadow-lg rounded-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="h-10 w-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-cloud-sun text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-white">–ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</h3>
                            <p class="text-blue-100 text-sm">{{ project.address }}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <a href="{% url 'projects:weather_analysis_detail' project.id %}" 
                           class="inline-flex items-center px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm font-medium rounded-lg transition-all duration-200 hover:scale-105 backdrop-blur-sm border border-white/20">
                            <i class="fas fa-analytics mr-2"></i>
                            <span>ü§ñ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                        </a>
                        <div id="weather-loading" class="text-white/80">
                            <i class="fas fa-spinner fa-spin mr-1"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>
                
                <div id="weather-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="text-center">
                            <div class="text-4xl mb-2" id="weather-icon">üå§Ô∏è</div>
                            <div class="text-3xl font-bold" id="weather-temp">--¬∞</div>
                            <div class="text-blue-100 text-sm" id="weather-desc">--</div>
                        </div>
                        
                        <!-- –û—â—É—â–∞–µ—Ç—Å—è -->
                        <div>
                            <div class="flex items-center mb-3">
                                <i class="fas fa-thermometer-half text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–û—â—É—â–∞–µ—Ç—Å—è</div>
                                    <div class="font-semibold" id="weather-feels">--¬∞</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-tint text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                                    <div class="font-semibold" id="weather-humidity">--%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –í–µ—Ç–µ—Ä -->
                        <div>
                            <div class="flex items-center mb-3">
                                <i class="fas fa-wind text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–í–µ—Ç–µ—Ä</div>
                                    <div class="font-semibold" id="weather-wind">-- –º/—Å</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-eye text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–í–∏–¥–∏–º–æ—Å—Ç—å</div>
                                    <div class="font-semibold" id="weather-visibility">-- –∫–º</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –î–∞–≤–ª–µ–Ω–∏–µ -->
                        <div>
                            <div class="flex items-center mb-3">
                                <i class="fas fa-weight text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–î–∞–≤–ª–µ–Ω–∏–µ</div>
                                    <div class="font-semibold" id="weather-pressure">-- –≥–ü–∞</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-arrows-alt-v text-white/80 mr-2"></i>
                                <div>
                                    <div class="text-sm text-blue-100">–û–±–ª–∞—á–Ω–æ—Å—Ç—å</div>
                                    <div class="font-semibold" id="weather-clouds">--%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="mt-4 pt-4 border-t border-white/20">
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-sun text-yellow-300 mr-1"></i>
                                <span class="text-blue-100 mr-2">–í–æ—Å—Ö–æ–¥:</span>
                                <span class="font-medium" id="weather-sunrise">--:--</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-moon text-yellow-200 mr-1"></i>
                                <span class="text-blue-100 mr-2">–ó–∞–∫–∞—Ç:</span>
                                <span class="font-medium" id="weather-sunset">--:--</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-white/80 mr-1"></i>
                                <span class="text-blue-100 mr-2">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                                <span class="font-medium" id="weather-updated">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="weather-error" class="hidden text-center py-4">
                    <div class="text-white/80">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ</p>
                        <button onclick="loadWeatherData()" class="mt-2 px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs transition-colors">
                            üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–∑ Excel -->
        {% if electronic_specification and specification_items %}
        <div class="mt-8">
            <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-file-excel text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg leading-6 font-semibold text-gray-900">
                                    –°–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç (–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)
                                </h3>
                                <p class="text-sm text-gray-600">–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç –∏–∑ {{ electronic_specification.source_file }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: {{ specification_items|length }}</div>
                            <div class="text-xs text-gray-600">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {{ electronic_specification.imported_at|date:"d.m.Y" }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–¥</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–ª-–≤–æ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ï–¥.–∏–∑–º.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¶–µ–Ω–∞ –∑–∞ –µ–¥.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in specification_items|slice:":20" %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono">{{ item.code|default:"‚Äî" }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        <div class="font-medium">{{ item.name|truncatechars:60 }}</div>
                                        {% if item.notes %}
                                            <div class="text-xs text-gray-500 mt-1">{{ item.notes|truncatechars:80 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right font-medium">{{ item.quantity|default:"‚Äî" }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ item.unit|default:"‚Äî" }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right">{% if item.unit_price %}{{ item.unit_price }} ‚ÇΩ{% else %}‚Äî{% endif %}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-right font-medium">{% if item.total_price %}{{ item.total_price }} ‚ÇΩ{% else %}‚Äî{% endif %}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                        {% if item.category %}
                                            <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">{{ item.category }}</span>
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                {% if specification_items|length > 20 %}
                                <tr>
                                    <td colspan="7" class="px-4 py-4 text-center text-sm text-gray-500">
                                        ... –∏ –µ—â—ë {{ specification_items|length|add:"-20" }} –ø–æ–∑–∏—Ü–∏–π
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- –°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ –∏–∑ Excel -->
        {% if network_schedule and network_tasks %}
        <div class="mt-8">
            <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-teal-50 to-cyan-50 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-gradient-to-r from-teal-600 to-cyan-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-sitemap text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg leading-6 font-semibold text-gray-900">
                                    –°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
                                </h3>
                                <p class="text-sm text-gray-600">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç –∏–∑ {{ network_schedule.source_file }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {{ network_tasks|length }}</div>
                            <div class="text-xs text-gray-600">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: {{ critical_path_tasks|length }}</div>
                            {% if network_schedule.project_duration_days %}
                                <div class="text-xs text-gray-600 mt-1">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ network_schedule.project_duration_days }} –¥–Ω–µ–π</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ -->
                    <div id="excel-gantt-chart" class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-900">–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</h4>
                            <div class="flex space-x-2">
                                <button id="toggle-critical-path" class="px-3 py-1 bg-red-100 text-red-800 text-sm rounded hover:bg-red-200 transition-colors">
                                    <i class="fas fa-route mr-1"></i>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å
                                </button>
                            </div>
                        </div>
                        <div id="excel-gantt-container" class="h-96 border border-gray-200 rounded-lg bg-white"></div>
                    </div>
                    
                    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–∞–Ω–Ω–µ–µ –Ω–∞—á–∞–ª–æ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–µ–∑–µ—Ä–≤ –≤—Ä–µ–º–µ–Ω–∏</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–µ—Å—É—Ä—Å—ã</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for task in network_tasks|slice:":15" %}
                                <tr class="hover:bg-gray-50 {% if task.is_critical %}bg-red-50 border-l-4 border-l-red-500{% endif %}">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono">{{ task.task_id }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        <div class="font-medium">{{ task.name|truncatechars:50 }}</div>
                                        {% if task.work_type %}
                                            <div class="text-xs text-gray-500 mt-1">–¢–∏–ø: {{ task.work_type.name }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center font-medium">{{ task.duration_days }} –¥–Ω.</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">–î–µ–Ω—å {{ task.early_start }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">–î–µ–Ω—å {{ task.early_finish }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                        {% if task.float_days > 0 %}
                                            <span class="text-gray-600">{{ task.float_days }} –¥–Ω.</span>
                                        {% elif task.is_critical %}
                                            <span class="text-red-600 font-medium">0 –¥–Ω.</span>
                                        {% else %}
                                            <span class="text-gray-400">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        {% if task.is_critical %}
                                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
                                            </span>
                                        {% else %}
                                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                                –û–±—ã—á–Ω–∞—è
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500">
                                        {% if task.get_resource_list %}
                                            <div class="flex flex-wrap gap-1">
                                                {% for resource in task.get_resource_list|slice:":3" %}
                                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">{{ resource }}</span>
                                                {% endfor %}
                                                {% if task.get_resource_list|length > 3 %}
                                                    <span class="text-xs text-gray-400">+{{ task.get_resource_list|length|add:"-3" }}</span>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-gray-400">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                {% if network_tasks|length > 15 %}
                                <tr>
                                    <td colspan="8" class="px-4 py-4 text-center text-sm text-gray-500">
                                        ... –∏ –µ—â—ë {{ network_tasks|length|add:"-15" }} –∑–∞–¥–∞—á
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="mt-8">
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-chart-bar text-primary-blue mr-2"></i>
                    –ö—Ä–∞—Ç–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
                        <p class="text-gray-600 text-sm">{{ materials|length }} –ø–æ—Å—Ç–∞–≤–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">–†–∞–±–æ—Ç—ã</h4>
                        <p class="text-gray-600 text-sm">{{ works|length }} –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">–ù–∞—Ä—É—à–µ–Ω–∏—è</h4>
                        <p class="text-gray-600 text-sm">{{ violations|length }} –∑–∞–º–µ—á–∞–Ω–∏–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç -->
        <div class="mt-8">
            <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-gradient-to-r from-green-600 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-tasks text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg leading-6 font-semibold text-gray-900">
                                    –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç
                                </h3>
                                <p class="text-sm text-gray-600">–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">–í—Å–µ–≥–æ —Ä–∞–±–æ—Ç: {{ works|length }}</div>
                            <div class="text-xs text-gray-600">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ project.completion_percentage }}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    {% if works %}
                        <div class="space-y-4">
                            {% for work in works|slice:":8" %}
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                                <div class="flex items-center">
                                    <div class="h-3 w-3 rounded-full mr-3 
                                        {% if work.status == 'completed' or work.status == 'verified' %}bg-green-500
                                        {% elif work.status == 'in_progress' %}bg-yellow-500 animate-pulse
                                        {% elif work.is_delayed %}bg-red-500
                                        {% else %}bg-gray-400{% endif %}"></div>
                                    <div>
                                        <h4 class="font-medium text-gray-900">{{ work.work_type|default:"–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç" }}</h4>
                                        <p class="text-sm text-gray-600">{{ work.volume|default:"1" }} {{ work.unit|default:"—à—Ç" }}</p>
                                        <div class="flex items-center mt-1">
                                            <span class="text-xs text-gray-500 mr-3">
                                                <i class="fas fa-calendar mr-1"></i>
                                                {{ work.planned_start_date|date:"d.m.Y"|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }} - {{ work.planned_end_date|date:"d.m.Y"|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                            </span>
                                            {% if work.is_delayed %}
                                                <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="w-20 bg-gray-200 rounded-full h-2 mb-1">
                                        <div class="h-2 rounded-full {% if work.status == 'completed' %}bg-green-500{% elif work.status == 'in_progress' %}bg-yellow-500{% elif work.is_delayed %}bg-red-500{% else %}bg-blue-500{% endif %}" 
                                             style="width: {{ work.progress_percentage|default:0 }}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-600">{{ work.progress_percentage|default:0 }}%</div>
                                    <div class="text-xs font-medium text-gray-900 mt-1">
                                        {% if work.status == 'completed' %}–ó–∞–≤–µ—Ä—à–µ–Ω–æ
                                        {% elif work.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ
                                        {% elif work.is_delayed %}–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                                        {% else %}–ù–µ –Ω–∞—á–∞—Ç–æ{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if works|length > 8 %}
                                <div class="text-center pt-4">
                                    <p class="text-sm text-gray-500 mb-3">–ò –µ—â—ë {{ works|length|add:"-8" }} —Ä–∞–±–æ—Ç...</p>
                                    <a href="{% url 'projects:work_schedule' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-list mr-2"></i>
                                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–∞–±–æ—Ç—ã
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-tasks text-gray-300 text-4xl mb-4"></i>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                            <p class="text-gray-500">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç –µ—â—ë –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –ó–∞–º–µ—á–∞–Ω–∏—è –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è -->
        <div class="mt-8">
            <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-orange-50 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-gradient-to-r from-red-600 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg leading-6 font-semibold text-gray-900">
                                    –ó–∞–º–µ—á–∞–Ω–∏—è –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è
                                </h3>
                                <p class="text-sm text-gray-600">–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">–í—Å–µ–≥–æ: {{ violations|length }}</div>
                                <div class="text-xs text-gray-600">–û—Ç–∫—Ä—ã—Ç—ã—Ö: {{ open_violations_count|default:"0" }}</div>
                            </div>
                            <a href="{% url 'projects:create_comment' project.id %}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    {% if violations %}
                        <div class="space-y-4">
                            {% for violation in violations|slice:":6" %}
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow{% if violation.status == 'detected' or violation.status == 'notified' or violation.status == 'pending' %} border-l-4 border-l-red-500{% endif %}">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center mb-2">
                                            <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                                            <span class="px-2 py-1 text-xs rounded-full font-medium mr-3 
                                                {% if violation.priority == 'critical' %}bg-red-100 text-red-800
                                                {% elif violation.priority == 'high' %}bg-orange-100 text-orange-800
                                                {% elif violation.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                                {% elif violation.priority == 'low' %}bg-blue-100 text-blue-800
                                                {% elif violation.severity == 'critical' %}bg-red-100 text-red-800
                                                {% elif violation.severity == 'high' %}bg-orange-100 text-orange-800
                                                {% elif violation.severity == 'medium' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                                {% if violation.priority == 'critical' %}–ö—Ä–∏—Ç–∏—á–Ω–æ
                                                {% elif violation.priority == 'high' %}–í—ã—Å–æ–∫–∏–π
                                                {% elif violation.priority == 'medium' %}–°—Ä–µ–¥–Ω–∏–π
                                                {% elif violation.priority == 'low' %}–ù–∏–∑–∫–∏–π
                                                {% elif violation.severity == 'critical' %}–ö—Ä–∏—Ç–∏—á–Ω–æ
                                                {% elif violation.severity == 'high' %}–í—ã—Å–æ–∫–∞—è
                                                {% elif violation.severity == 'medium' %}–°—Ä–µ–¥–Ω—è—è
                                                {% else %}–ù–∏–∑–∫–∞—è{% endif %}
                                            </span>
                                            <!-- –¢–∏–ø –∑–∞–º–µ—á–∞–Ω–∏—è/–Ω–∞—Ä—É—à–µ–Ω–∏—è -->
                                            {% if violation.inspector %}
                                                <span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-800 mr-3">
                                                    <i class="fas fa-user-shield mr-1"></i>–ù–∞—Ä—É—à–µ–Ω–∏–µ
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-1 text-xs rounded bg-orange-100 text-orange-800 mr-3">
                                                    <i class="fas fa-comment mr-1"></i>–ó–∞–º–µ—á–∞–Ω–∏–µ
                                                </span>
                                            {% endif %}
                                            <span class="text-xs text-gray-500">
                                                <i class="fas fa-calendar mr-1"></i>
                                                {% if violation.detected_at %}
                                                    {{ violation.detected_at|date:"–¥.m.Y H:i" }}
                                                {% else %}
                                                    {{ violation.created_at|date:"–¥.m.Y H:i" }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <h4 class="font-medium text-gray-900 mb-2">{{ violation.title|default:"–ó–∞–º–µ—á–∞–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç—É" }}</h4>
                                        <p class="text-sm text-gray-600 mb-3">{{ violation.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ" |truncatechars:150 }}</p>
                                        
                                        <div class="flex items-center text-xs text-gray-500 space-x-4">
                                            {% if violation.inspector %}
                                                <span>
                                                    <i class="fas fa-user-shield mr-1"></i>
                                                    {{ violation.inspector.get_full_name }}
                                                </span>
                                            {% elif violation.created_by %}
                                                <span>
                                                    <i class="fas fa-user-tie mr-1"></i>
                                                    {{ violation.created_by.get_full_name }}
                                                </span>
                                            {% endif %}
                                            {% if violation.assigned_to %}
                                                <span>
                                                    <i class="fas fa-user-check mr-1"></i>
                                                    –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {{ violation.assigned_to.get_full_name }}
                                                </span>
                                            {% endif %}
                                            {% if violation.location_description or violation.location_lat %}
                                                <span>
                                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                                    –ú–µ—Å—Ç–æ
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <span class="px-2 py-1 text-xs rounded 
                                            {% if violation.status == 'detected' or violation.status == 'notified' or violation.status == 'pending' %}bg-red-100 text-red-800
                                            {% elif violation.status == 'in_correction' or violation.status == 'accepted' %}bg-yellow-100 text-yellow-800
                                            {% elif violation.status == 'corrected' or violation.status == 'verified' or violation.status == 'closed' or violation.status == 'resolved' %}bg-green-100 text-green-800
                                            {% elif violation.status == 'open' %}bg-red-100 text-red-800
                                            {% elif violation.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                            {% elif violation.status == 'rejected' %}bg-gray-100 text-gray-800
                                            {% else %}bg-green-100 text-green-800{% endif %}">
                                            {% if violation.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç
                                            {% elif violation.status == 'accepted' %}–ü—Ä–∏–Ω—è—Ç–æ
                                            {% elif violation.status == 'resolved' %}–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ
                                            {% elif violation.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                            {% else %}{{ violation.get_status_display|default:violation.status|title }}{% endif %}
                                        </span>
                                        {% if violation.inspector %}
                                            <a href="{% url 'inspector:violation_detail' violation.id %}" class="text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        {% else %}
                                            <a href="{% url 'projects:comment_detail' violation.id %}" class="text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if violations|length > 6 %}
                                <div class="text-center pt-4">
                                    <p class="text-sm text-gray-500 mb-3">–ò –µ—â—ë {{ violations|length|add:"-6" }} –∑–∞–º–µ—á–∞–Ω–∏–π...</p>
                                    <a href="{% url 'projects:comments_list' %}?project={{ project.id }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                                        <i class="fas fa-list mr-2"></i>
                                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-green-300 text-4xl mb-4"></i>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">–ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç</h4>
                            <p class="text-gray-500 mb-4">–ù–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –ø—Ä–æ–µ–∫—Ç—É –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã</p>
                            <a href="{% url 'projects:create_comment' project.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-red-600 bg-red-50 hover:bg-red-100 transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç -->
        <div class="mt-8">
            <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-clipboard-check text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-lg leading-6 font-semibold text-gray-900">
                                    –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç
                                </h3>
                                <p class="text-sm text-gray-600">–ü—Ä–∏—ë–º–∫–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ: {{ verified_works_count|default:"0" }}</div>
                                <div class="text-xs text-gray-600">–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏—ë–º–∫–∏: {{ pending_verification_count|default:"0" }}</div>
                            </div>
                            {% if project.status == 'active' %}
                                <button onclick="startVerification()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors">
                                    <i class="fas fa-search mr-2"></i>
                                    –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">{{ verified_works_count|default:"0" }}</div>
                            <div class="text-sm text-gray-600">–ü—Ä–∏–Ω—è—Ç–æ</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600">{{ pending_verification_count|default:"0" }}</div>
                            <div class="text-sm text-gray-600">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-600">{{ rejected_works_count|default:"0" }}</div>
                            <div class="text-sm text-gray-600">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">{{ total_verification_percentage|default:"0" }}%</div>
                            <div class="text-sm text-gray-600">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                        </div>
                    </div>
                    
                    {% if verifications %}
                        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                        <h4 class="font-medium text-gray-900 mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h4>
                        <div class="space-y-3">
                            {% for verification in verifications|slice:":5" %}
                            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                <div class="flex items-center">
                                    <div class="h-3 w-3 rounded-full mr-3 
                                        {% if verification.status == 'approved' %}bg-green-500
                                        {% elif verification.status == 'rejected' %}bg-red-500
                                        {% else %}bg-yellow-500{% endif %}"></div>
                                    <div>
                                        <h5 class="font-medium text-gray-900">{{ verification.work_type|default:"–†–∞–±–æ—Ç—ã" }}</h5>
                                        <p class="text-sm text-gray-600">{{ verification.description|default:"–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç" |truncatechars:80 }}</p>
                                        <div class="flex items-center text-xs text-gray-500 mt-1">
                                            <span class="mr-3">
                                                <i class="fas fa-calendar mr-1"></i>
                                                {{ verification.verified_at|date:"d.m.Y H:i"|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                            </span>
                                            {% if verification.inspector %}
                                                <span>
                                                    <i class="fas fa-user-check mr-1"></i>
                                                    {{ verification.inspector.get_full_name }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 text-xs rounded font-medium
                                        {% if verification.status == 'approved' %}bg-green-100 text-green-800
                                        {% elif verification.status == 'rejected' %}bg-red-100 text-red-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {% if verification.status == 'approved' %}–ü—Ä–∏–Ω—è—Ç–æ
                                        {% elif verification.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                        {% else %}–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if verifications|length > 5 %}
                            <div class="text-center pt-4">
                                <a href="/verification/?project={{ project.id }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors">
                                    <i class="fas fa-list mr-2"></i>
                                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-clipboard-list text-gray-300 text-4xl mb-4"></i>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å</h4>
                            <p class="text-gray-500 mb-4">–ü—Ä–∏—ë–º–∫–∞ —Ä–∞–±–æ—Ç –µ—â—ë –Ω–µ –Ω–∞—á–∞—Ç–∞</p>
                            {% if project.status == 'active' %}
                                <button onclick="startVerification()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-green-600 bg-green-50 hover:bg-green-100 transition-colors">
                                    <i class="fas fa-search mr-2"></i>
                                    –ù–∞—á–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π (–≤ –Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã) -->
<div class="mt-8">
    <div class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-history text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-lg leading-6 font-semibold text-gray-900">
                            –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π
                        </h3>
                        <p class="text-sm text-gray-600">–ü–æ–ª–Ω–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π –ø–æ –ø—Ä–æ–µ–∫—Ç—É</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-900">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: {{ events|length }}</div>
                    <div class="text-xs text-gray-600">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3</div>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            {% if events %}
                <!-- –ö–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–±—ã—Ç–∏—è) -->
                <div id="events-preview">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for event in events|slice:":3" %}
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all duration-200">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <span class="h-10 w-10 rounded-full flex items-center justify-center
                                        {% if event.event_type == 'created' %}bg-blue-500
                                        {% elif event.event_type == 'status_changed' %}bg-purple-500
                                        {% elif event.event_type == 'foreman_assigned' %}bg-orange-500
                                        {% elif event.event_type == 'foreman_changed' %}bg-orange-400
                                        {% elif event.event_type == 'work_started' %}bg-green-500
                                        {% elif event.event_type == 'work_completed' %}bg-green-600
                                        {% elif event.event_type == 'comment_added' %}bg-yellow-500
                                        {% elif event.event_type == 'violation_added' %}bg-red-500
                                        {% elif event.event_type == 'material_delivered' %}bg-indigo-500
                                        {% elif event.event_type == 'inspection_passed' %}bg-teal-500
                                        {% elif event.event_type == 'document_uploaded' %}bg-pink-500
                                        {% elif event.event_type == 'schedule_changed' %}bg-amber-500
                                        {% elif event.event_type == 'milestone_reached' %}bg-emerald-500
                                        {% elif event.event_type == 'completion_updated' %}bg-cyan-500
                                        {% else %}bg-gray-500{% endif %}">
                                        {% if event.event_type == 'created' %}
                                            <i class="fas fa-plus text-white text-sm"></i>
                                        {% elif event.event_type == 'status_changed' %}
                                            <i class="fas fa-exchange-alt text-white text-sm"></i>
                                        {% elif event.event_type == 'foreman_assigned' or event.event_type == 'foreman_changed' %}
                                            <i class="fas fa-user-tie text-white text-sm"></i>
                                        {% elif event.event_type == 'work_started' %}
                                            <i class="fas fa-play text-white text-sm"></i>
                                        {% elif event.event_type == 'work_completed' %}
                                            <i class="fas fa-check text-white text-sm"></i>
                                        {% elif event.event_type == 'comment_added' %}
                                            <i class="fas fa-comment text-white text-sm"></i>
                                        {% elif event.event_type == 'violation_added' %}
                                            <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                                        {% elif event.event_type == 'material_delivered' %}
                                            <i class="fas fa-truck text-white text-sm"></i>
                                        {% elif event.event_type == 'inspection_passed' %}
                                            <i class="fas fa-search text-white text-sm"></i>
                                        {% elif event.event_type == 'document_uploaded' %}
                                            <i class="fas fa-file text-white text-sm"></i>
                                        {% elif event.event_type == 'schedule_changed' %}
                                            <i class="fas fa-calendar text-white text-sm"></i>
                                        {% elif event.event_type == 'milestone_reached' %}
                                            <i class="fas fa-flag text-white text-sm"></i>
                                        {% elif event.event_type == 'completion_updated' %}
                                            <i class="fas fa-chart-bar text-white text-sm"></i>
                                        {% else %}
                                            <i class="fas fa-circle text-white text-sm"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="text-sm font-medium text-gray-900 mb-1">
                                        {{ event.get_event_type_display }}
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        {{ event.description|truncatechars:80 }}
                                    </div>
                                    {% if event.old_value and event.new_value %}
                                        <div class="text-xs text-gray-500 mb-2">
                                            <span class="line-through">{{ event.old_value }}</span> ‚Üí <strong>{{ event.new_value }}</strong>
                                        </div>
                                    {% endif %}
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span>
                                            <i class="fas fa-user mr-1"></i>
                                            {{ event.user.get_full_name }}
                                        </span>
                                        <span>
                                            <i class="fas fa-clock mr-1"></i>
                                            {{ event.created_at|date:"d.m H:i" }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if events|length > 3 %}
                    <div class="text-center mt-6">
                        <button id="show-all-events" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200">
                            <i class="fas fa-chevron-down mr-2"></i>
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è ({{ events|length|add:"-3" }} –µ—â—ë)
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="events-full" class="hidden">
                    <div class="flow-root">
                        <ul class="-mb-8">
                            {% for event in events %}
                            <li>
                                <div class="relative pb-8">
                                    {% if not forloop.last %}
                                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                    {% endif %}
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span class="h-8 w-8 rounded-full flex items-center justify-center
                                                {% if event.event_type == 'created' %}bg-blue-500
                                                {% elif event.event_type == 'status_changed' %}bg-purple-500
                                                {% elif event.event_type == 'foreman_assigned' %}bg-orange-500
                                                {% elif event.event_type == 'foreman_changed' %}bg-orange-400
                                                {% elif event.event_type == 'work_started' %}bg-green-500
                                                {% elif event.event_type == 'work_completed' %}bg-green-600
                                                {% elif event.event_type == 'comment_added' %}bg-yellow-500
                                                {% elif event.event_type == 'violation_added' %}bg-red-500
                                                {% elif event.event_type == 'material_delivered' %}bg-indigo-500
                                                {% elif event.event_type == 'inspection_passed' %}bg-teal-500
                                                {% elif event.event_type == 'document_uploaded' %}bg-pink-500
                                                {% elif event.event_type == 'schedule_changed' %}bg-amber-500
                                                {% elif event.event_type == 'milestone_reached' %}bg-emerald-500
                                                {% elif event.event_type == 'completion_updated' %}bg-cyan-500
                                                {% else %}bg-gray-500{% endif %}">
                                                {% if event.event_type == 'created' %}
                                                    <i class="fas fa-plus text-white text-xs"></i>
                                                {% elif event.event_type == 'status_changed' %}
                                                    <i class="fas fa-exchange-alt text-white text-xs"></i>
                                                {% elif event.event_type == 'foreman_assigned' or event.event_type == 'foreman_changed' %}
                                                    <i class="fas fa-user-tie text-white text-xs"></i>
                                                {% elif event.event_type == 'work_started' %}
                                                    <i class="fas fa-play text-white text-xs"></i>
                                                {% elif event.event_type == 'work_completed' %}
                                                    <i class="fas fa-check text-white text-xs"></i>
                                                {% elif event.event_type == 'comment_added' %}
                                                    <i class="fas fa-comment text-white text-xs"></i>
                                                {% elif event.event_type == 'violation_added' %}
                                                    <i class="fas fa-exclamation-triangle text-white text-xs"></i>
                                                {% elif event.event_type == 'material_delivered' %}
                                                    <i class="fas fa-truck text-white text-xs"></i>
                                                {% elif event.event_type == 'inspection_passed' %}
                                                    <i class="fas fa-search text-white text-xs"></i>
                                                {% elif event.event_type == 'document_uploaded' %}
                                                    <i class="fas fa-file text-white text-xs"></i>
                                                {% elif event.event_type == 'schedule_changed' %}
                                                    <i class="fas fa-calendar text-white text-xs"></i>
                                                {% elif event.event_type == 'milestone_reached' %}
                                                    <i class="fas fa-flag text-white text-xs"></i>
                                                {% elif event.event_type == 'completion_updated' %}
                                                    <i class="fas fa-chart-bar text-white text-xs"></i>
                                                {% else %}
                                                    <i class="fas fa-circle text-white text-xs"></i>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">{{ event.get_event_type_display }}</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    {{ event.created_at|date:"d.m.Y H:i" }}
                                                </p>
                                            </div>
                                            <div class="mt-2 text-sm text-gray-700">
                                                {{ event.description }}
                                                {% if event.old_value and event.new_value %}
                                                    <div class="mt-1 text-xs text-gray-500">
                                                        <span class="line-through">{{ event.old_value }}</span> ‚Üí <strong>{{ event.new_value }}</strong>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="mt-1 text-xs text-gray-500">
                                                <i class="fas fa-user mr-1"></i>
                                                {{ event.user.get_full_name }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button id="hide-all-events" class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-chevron-up mr-2"></i>
                            –°–≤–µ—Ä–Ω—É—Ç—å
                        </button>
                    </div>
                </div>
                
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-history text-gray-300 text-5xl mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</h4>
                    <p class="text-gray-500">–°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ –º–µ—Ä–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// üá∫üá∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ –±—Ä–µ–Ω–¥–∏–Ω–≥–∞
document.addEventListener('DOMContentLoaded', function() {
    console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã...');
    
    let map = null;
    
    try {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
        let projectsData = [];
        try {
            projectsData = {{ project_for_map|default:"[]"|safe }};
            console.log('üìä –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç—ã:', projectsData);
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞:', e);
            projectsData = [];
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã
        window.onMapReady = function(mapInstance) {
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!');
            map = mapInstance;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
            if (projectsData && projectsData.length > 0) {
                console.log(`üè¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${projectsData.length} –ø—Ä–æ–µ–∫—Ç(–æ–≤) –Ω–∞ –∫–∞—Ä—Ç–µ`);
                
                projectsData.forEach((project, index) => {
                    console.log(`üè† –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ${index + 1}:`, project);
                    
                    if (project.coordinates && project.coordinates.coordinates) {
                        let color = '#2942F9';
                        if (project.status === 'active') color = '#2563EB';
                        else if (project.status === 'completed') color = '#059669';
                        else if (project.status === 'suspended') color = '#DC2626';
                        else if (project.status === 'planned') color = '#6B7280';
                        
                        try {
                            // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –ø–æ–ª–∏–≥–æ–Ω–∞
                            let coords = project.coordinates.coordinates[0];
                            if (project.coordinates.type === 'MultiPolygon') {
                                coords = project.coordinates.coordinates[0][0];
                            }
                            
                            const centerLng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                            const centerLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                            
                            console.log(`üéØ –¶–µ–Ω—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞: [${centerLat}, ${centerLng}]`);
                            
                            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Å –±–æ–ª—å—à–∏–º –∑—É–º–æ–º
                            map.setCenter([centerLng, centerLat], 17); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 17 –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                            map.addMarker([centerLng, centerLat], {
                                title: project.name,
                                color: color,
                                popup: `
                                    <div class="p-3">
                                        <h3 class="font-bold text-gray-900 mb-2">${project.name}</h3>
                                        <p class="text-sm text-gray-700 mb-1">üìç ${project.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                                        <p class="text-xs text-gray-600 mb-1">–°—Ç–∞—Ç—É—Å: ${project.status}</p>
                                        <p class="text-xs text-gray-600">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${project.completion}%</p>
                                    </div>
                                `,
                                data: project
                            });
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
                            map.addPolygon(coords, {
                                title: project.name,
                                strokeColor: color,
                                fillColor: color + '44', // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                                strokeWidth: 3, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—â–∏–Ω—É –æ–±–≤–æ–¥–∫–∏
                                data: project
                            });
                            
                            console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –∏ –ø–æ–ª–∏–≥–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É');
                        } catch (coordError) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', coordError);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:', project);
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –Ω–∞ –ú–æ—Å–∫–≤–µ');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –ú–æ—Å–∫–≤—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                map.addMarker([37.6176, 55.7558], {
                    title: '–ú–æ—Å–∫–≤–∞',
                    color: '#2942F9',
                    popup: `
                        <div class="p-3">
                            <h3 class="font-bold text-gray-900 mb-2">üè≤ –ú–æ—Å–∫–≤–∞</h3>
                            <p class="text-sm text-gray-700">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</p>
                        </div>
                    `
                });
            }
        };
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∑—É–º–æ–º
        map = createRussianMap('map', {
            center: [37.6176, 55.7558], // –ú–æ—Å–∫–≤–∞ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω)
            zoom: 17, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑—É–º –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            debug: true,
            defaultProvider: 'osm'
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∫–∞—Ä—Ç
        document.getElementById('map-provider').addEventListener('change', function(e) {
            const provider = e.target.value;
            if (map && map.changeProvider) {
                const success = map.changeProvider(provider);
                if (success) {
                    console.log(`üîÑ –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–º–µ–Ω–µ–Ω –Ω–∞: ${provider}`);
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞');
                }
            }
        });
        
        console.log('‚úÖ –†–æ—Å—Å–∏–π—Å–∫–∞—è –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–∞–Ω—Ç-–¥–∏–∞–≥—Ä–∞–º–º—É
        setTimeout(() => {
            initializeGanttChart();
            setupGanttViewHandlers();
            initializeExcelGanttChart();
        }, 500);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        setTimeout(() => {
            loadWeatherData();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        document.getElementById('map-loading').innerHTML = `
            <div class="flex items-center justify-center h-96 bg-gray-100">
                <div class="text-center">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã</h3>
                    <p class="text-sm text-gray-600 mb-4">${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    <button onclick="location.reload()" class="px-4 py-2 bg-primary-blue text-white rounded hover:bg-blue-600">
                        üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>
        `;
    }
});

// üìà –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
function initializeGanttChart() {
    const scheduleData = {{ schedule_json|safe }};
    
    if (!scheduleData || scheduleData.length === 0) {
        console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–∞–Ω—Ç-–¥–∏–∞–≥—Ä–∞–º–º—ã');
        return;
    }
    
    console.log('üìà –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–Ω—Ç-–¥–∏–∞–≥—Ä–∞–º–º—ã...', scheduleData);
    
    // –ü—Ä–æ—Å—Ç–∞—è SVG-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    createSimpleGanttChart('gantt-container', scheduleData);
}

function createSimpleGanttChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–∞–Ω—Ç-–¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –û—á–∏—Å—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = '';
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—ã
    let minDate = null, maxDate = null;
    data.forEach(work => {
        if (work.planned_start) {
            const startDate = new Date(work.planned_start.split('.').reverse().join('-'));
            if (!minDate || startDate < minDate) minDate = startDate;
        }
        if (work.planned_end) {
            const endDate = new Date(work.planned_end.split('.').reverse().join('-'));
            if (!maxDate || endDate > maxDate) maxDate = endDate;
        }
    });
    
    if (!minDate || !maxDate) {
        container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–∞—Ç–∞—Ö</div>';
        return;
    }
    
    // –†–∞–∑–º–µ—Ä—ã
    const svgWidth = container.offsetWidth;
    const svgHeight = Math.max(300, data.length * 40 + 100);
    const margin = { top: 50, right: 50, bottom: 50, left: 200 };
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // –°–æ–∑–¥–∞—ë–º SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', svgWidth);
    svg.setAttribute('height', svgHeight);
    svg.style.backgroundColor = 'white';
    
    // –®–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏
    const timeScale = chartWidth / (maxDate - minDate);
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—ã
    data.forEach((work, index) => {
        if (!work.planned_start || !work.planned_end) return;
        
        const startDate = new Date(work.planned_start.split('.').reverse().join('-'));
        const endDate = new Date(work.planned_end.split('.').reverse().join('-'));
        
        const x = margin.left + (startDate - minDate) * timeScale;
        const y = margin.top + index * 35;
        const width = (endDate - startDate) * timeScale;
        const height = 25;
        
        // –¶–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
        let color = '#3b82f6'; // —Å–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (work.status === 'completed' || work.status === 'verified') {
            color = '#10b981'; // –∑–µ–ª—ë–Ω—ã–π
        } else if (work.status === 'in_progress') {
            color = '#f59e0b'; // –∂—ë–ª—Ç—ã–π
        } else if (work.is_delayed) {
            color = '#ef4444'; // –∫—Ä–∞—Å–Ω—ã–π
        }
        
        // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∑–∞–¥–∞—á–∏
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', Math.max(width, 5));
        rect.setAttribute('height', height);
        rect.setAttribute('fill', color);
        rect.setAttribute('rx', 3);
        rect.setAttribute('opacity', 0.8);
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${work.name}\n${work.planned_start} - ${work.planned_end}\n–ü—Ä–æ–≥—Ä–µ—Å—Å: ${work.progress_percentage}%`;
        rect.appendChild(title);
        
        svg.appendChild(rect);
        
        // –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        if (work.progress_percentage > 0) {
            const progressRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            progressRect.setAttribute('x', x);
            progressRect.setAttribute('y', y + height - 4);
            progressRect.setAttribute('width', Math.max(width, 5) * (work.progress_percentage / 100));
            progressRect.setAttribute('height', 4);
            progressRect.setAttribute('fill', '#059669'); // —Ç—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π
            progressRect.setAttribute('rx', 2);
            svg.appendChild(progressRect);
        }
        
        // –ü–æ–¥–ø–∏—Å—å
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', margin.left - 10);
        text.setAttribute('y', y + height / 2 + 4);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('font-size', '12');
        text.setAttribute('fill', '#374151');
        text.textContent = work.name.length > 25 ? work.name.substring(0, 25) + '...' : work.name;
        svg.appendChild(text);
    });
    
    // –û—Å—å –≤—Ä–µ–º–µ–Ω–∏
    const monthNames = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
    const currentDate = new Date(minDate);
    while (currentDate <= maxDate) {
        const x = margin.left + (currentDate - minDate) * timeScale;
        
        // –õ–∏–Ω–∏—è —Å–µ—Ç–∫–∏
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('y1', margin.top);
        line.setAttribute('x2', x);
        line.setAttribute('y2', margin.top + chartHeight);
        line.setAttribute('stroke', '#e5e7eb');
        line.setAttribute('stroke-width', 1);
        svg.appendChild(line);
        
        // –ü–æ–¥–ø–∏—Å—å –¥–∞—Ç—ã
        const dateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        dateText.setAttribute('x', x);
        dateText.setAttribute('y', margin.top - 10);
        dateText.setAttribute('text-anchor', 'middle');
        dateText.setAttribute('font-size', '11');
        dateText.setAttribute('fill', '#6b7280');
        dateText.textContent = `${currentDate.getDate()} ${monthNames[currentDate.getMonth()]}`;
        svg.appendChild(dateText);
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ
        currentDate.setDate(currentDate.getDate() + 7);
    }
    
    container.appendChild(svg);
    console.log('‚ú® –ì–∞–Ω—Ç-–¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ–∑–¥–∞–Ω–∞');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–æ–≤
function setupGanttViewHandlers() {
    const ganttBtn = document.getElementById('gantt-view-btn');
    const timelineBtn = document.getElementById('timeline-view-btn');
    const ganttChart = document.getElementById('gantt-chart');
    const worksTable = document.getElementById('works-table');
    
    if (!ganttBtn || !timelineBtn) return;
    
    ganttBtn.addEventListener('click', () => {
        ganttBtn.classList.remove('bg-gray-200', 'text-gray-700');
        ganttBtn.classList.add('bg-primary-blue', 'text-white');
        timelineBtn.classList.remove('bg-primary-blue', 'text-white');
        timelineBtn.classList.add('bg-gray-200', 'text-gray-700');
        
        if (ganttChart) ganttChart.style.display = 'block';
        if (worksTable) worksTable.style.display = 'block';
    });
    
    timelineBtn.addEventListener('click', () => {
        timelineBtn.classList.remove('bg-gray-200', 'text-gray-700');
        timelineBtn.classList.add('bg-primary-blue', 'text-white');
        ganttBtn.classList.remove('bg-primary-blue', 'text-white');
        ganttBtn.classList.add('bg-gray-200', 'text-gray-700');
        
        if (ganttChart) ganttChart.style.display = 'none';
        if (worksTable) worksTable.style.display = 'block';
    });
}

// üå¶Ô∏è –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function loadWeatherData() {
    console.log('üå§Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
    
    const projectAddress = '{{ project.address|escapejs }}';
    const projectCoords = {{ project_for_map|safe }};
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('weather-loading').classList.remove('hidden');
    document.getElementById('weather-content').classList.add('hidden');
    document.getElementById('weather-error').classList.add('hidden');
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
    let lat, lon;
    
    if (projectCoords && projectCoords.length > 0 && projectCoords[0].coordinates) {
        try {
            const coords = projectCoords[0].coordinates.coordinates[0];
            if (projectCoords[0].coordinates.type === 'MultiPolygon') {
                coords = projectCoords[0].coordinates.coordinates[0][0];
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä
            lon = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
            lat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
            
            console.log(`üó∫Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞: ${lat}, ${lon}`);
        } catch (e) {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', e);
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞
            lat = 55.7558;
            lon = 37.6176;
        }
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞
        lat = 55.7558;
        lon = 37.6176;
        console.log('üèôÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ú–æ—Å–∫–≤—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    }
    
    // üåç –†–µ–∞–ª—å–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Open-Meteo API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
    loadRealWeatherFromOpenMeteo(lat, lon);
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function displayWeatherData(weather) {
    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    document.getElementById('weather-icon').textContent = weather.icon;
    document.getElementById('weather-temp').textContent = weather.temp + '¬∞C';
    document.getElementById('weather-desc').textContent = weather.description;
    
    // –î–µ—Ç–∞–ª–∏
    document.getElementById('weather-feels').textContent = weather.feels_like + '¬∞C';
    document.getElementById('weather-humidity').textContent = weather.humidity + '%';
    document.getElementById('weather-wind').textContent = weather.wind_speed + ' –º/—Å';
    document.getElementById('weather-visibility').textContent = weather.visibility + ' –∫–º';
    document.getElementById('weather-pressure').textContent = weather.pressure + ' –≥–ü–∞';
    document.getElementById('weather-clouds').textContent = weather.clouds + '%';
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
    document.getElementById('weather-sunrise').textContent = weather.sunrise;
    document.getElementById('weather-sunset').textContent = weather.sunset;
    document.getElementById('weather-updated').textContent = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    document.getElementById('weather-loading').classList.add('hidden');
    document.getElementById('weather-content').classList.remove('hidden');
    document.getElementById('weather-error').classList.add('hidden');
    
    console.log('‚ú® –ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
}

// üåç –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã —á–µ—Ä–µ–∑ Open-Meteo API
function loadRealWeatherFromOpenMeteo(lat, lon) {
    console.log(`üå§Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ –¥–ª—è ${lat}, ${lon}`);
    
    // Open-Meteo API - –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    const currentWeatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,surface_pressure,wind_speed_10m,wind_direction_10m,visibility&daily=sunrise,sunset&timezone=auto&forecast_days=1`;
    
    fetch(currentWeatherUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ Open-Meteo –ø–æ–ª—É—á–µ–Ω—ã:', data);
            
            const current = data.current;
            const daily = data.daily;
            
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º WMO weather codes –≤ –∏–∫–æ–Ω–∫–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è
            const weatherInfo = getWeatherInfoFromWMOCode(current.weather_code);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ä–µ–º—è –≤–æ—Å—Ö–æ–¥–∞/–∑–∞–∫–∞—Ç–∞
            const sunrise = new Date(daily.sunrise[0]).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const sunset = new Date(daily.sunset[0]).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            const weather = {
                temp: Math.round(current.temperature_2m),
                feels_like: Math.round(current.apparent_temperature),
                humidity: current.relative_humidity_2m,
                pressure: Math.round(current.surface_pressure),
                visibility: Math.round(current.visibility / 1000), // –º–µ—Ç—Ä—ã –≤ –∫–º
                wind_speed: Math.round(current.wind_speed_10m * 10) / 10,
                clouds: weatherInfo.clouds,
                icon: weatherInfo.icon,
                description: weatherInfo.description,
                sunrise: sunrise,
                sunset: sunset
            };
            
            console.log('‚ú® –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ:', weather);
            displayWeatherData(weather);
            
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ:', error);
            
            // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
            showWeatherErrorWithFallback(error.message);
        });
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ WMO weather codes –≤ —Ä—É—Å—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ –∏–∫–æ–Ω–∫–∏
function getWeatherInfoFromWMOCode(code) {
    const weatherCodes = {
        0: { icon: '‚òÄÔ∏è', description: '–Ø—Å–Ω–æ–µ –Ω–µ–±–æ', clouds: 0 },
        1: { icon: 'üå§Ô∏è', description: '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ', clouds: 10 },
        2: { icon: '‚õÖ', description: '–ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ', clouds: 25 },
        3: { icon: '‚òÅÔ∏è', description: '–û–±–ª–∞—á–Ω–æ', clouds: 75 },
        45: { icon: 'üå´Ô∏è', description: '–¢—É–º–∞–Ω', clouds: 100 },
        48: { icon: 'üå´Ô∏è', description: '–ò–Ω–µ–π', clouds: 100 },
        51: { icon: 'üåßÔ∏è', description: '–õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å', clouds: 80 },
        53: { icon: 'üåßÔ∏è', description: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –º–æ—Ä–æ—Å—å', clouds: 85 },
        55: { icon: 'üåßÔ∏è', description: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –º–æ—Ä–æ—Å—å', clouds: 90 },
        56: { icon: 'üåßÔ∏è', description: '–õ–µ–≥–∫–∞—è –ª–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å', clouds: 90 },
        57: { icon: 'üåßÔ∏è', description: '–õ–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å', clouds: 90 },
        61: { icon: 'üå¶Ô∏è', description: '–°–ª–∞–±—ã–π –¥–æ–∂–¥—å', clouds: 70 },
        63: { icon: 'üåßÔ∏è', description: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å', clouds: 80 },
        65: { icon: 'üåßÔ∏è', description: '–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å', clouds: 90 },
        66: { icon: 'üåßÔ∏è', description: '–õ–µ–≥–∫–∏–π –ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å', clouds: 85 },
        67: { icon: 'üåßÔ∏è', description: '–õ–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å', clouds: 90 },
        71: { icon: '‚ùÑÔ∏è', description: '–õ–µ–≥–∫–∏–π —Å–Ω–µ–≥', clouds: 80 },
        73: { icon: 'üå®Ô∏è', description: '–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥', clouds: 85 },
        75: { icon: '‚ùÑÔ∏è', description: '–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥', clouds: 90 },
        77: { icon: '‚ùÑÔ∏è', description: '–°–Ω–µ–∂–Ω–∞—è –∫—Ä—É–ø–∞', clouds: 85 },
        80: { icon: 'üå¶Ô∏è', description: '–õ–µ–≥–∫–∏–µ –ª–∏–≤–Ω–∏', clouds: 75 },
        81: { icon: 'üåßÔ∏è', description: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏', clouds: 80 },
        82: { icon: '‚õàÔ∏è', description: '–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏', clouds: 90 },
        85: { icon: 'üå®Ô∏è', description: '–õ–µ–≥–∫–∏–µ —Å–Ω–µ–∂–Ω—ã–µ –ª–∏–≤–Ω–∏', clouds: 80 },
        86: { icon: '‚ùÑÔ∏è', description: '–°–∏–ª—å–Ω—ã–µ —Å–Ω–µ–∂–Ω—ã–µ –ª–∏–≤–Ω–∏', clouds: 85 },
        95: { icon: '‚õàÔ∏è', description: '–ì—Ä–æ–∑–∞', clouds: 90 },
        96: { icon: '‚õàÔ∏è', description: '–ì—Ä–æ–∑–∞ —Å –ª–µ–≥–∫–∏–º –≥—Ä–∞–¥–æ–º', clouds: 90 },
        99: { icon: '‚õàÔ∏è', description: '–ì—Ä–æ–∑–∞ —Å —Å–∏–ª—å–Ω—ã–º –≥—Ä–∞–¥–æ–º', clouds: 95 }
    };
    
    return weatherCodes[code] || { icon: 'üå§Ô∏è', description: '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ', clouds: 50 };
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º
function showWeatherErrorWithFallback(errorMessage) {
    document.getElementById('weather-loading').classList.add('hidden');
    document.getElementById('weather-content').classList.add('hidden');
    
    const errorElement = document.getElementById('weather-error');
    errorElement.innerHTML = `
        <div class="text-center py-4">
            <div class="text-white/80">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p class="text-sm mb-2">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ</p>
                <p class="text-xs mb-3 opacity-75">–û—à–∏–±–∫–∞: ${errorMessage}</p>
                <button onclick="loadWeatherData()" class="mt-2 px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs transition-colors">
                    üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        </div>
    `;
    errorElement.classList.remove('hidden');
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
function showWeatherError() {
    document.getElementById('weather-loading').classList.add('hidden');
    document.getElementById('weather-content').classList.add('hidden');
    document.getElementById('weather-error').classList.remove('hidden');
}

// –†–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è OpenWeatherMap API (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
/*
function loadRealWeatherData(lat, lon) {
    // –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞: https://openweathermap.org/api
    const API_KEY = 'YOUR_API_KEY_HERE';
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=ru`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const weather = {
                temp: Math.round(data.main.temp),
                feels_like: Math.round(data.main.feels_like),
                humidity: data.main.humidity,
                pressure: data.main.pressure,
                visibility: Math.round(data.visibility / 1000),
                wind_speed: data.wind.speed,
                clouds: data.clouds.all,
                icon: getWeatherIcon(data.weather[0].id),
                description: data.weather[0].description,
                sunrise: new Date(data.sys.sunrise * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                sunset: new Date(data.sys.sunset * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };
            
            displayWeatherData(weather);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã:', error);
            showWeatherError();
        });
}

function getWeatherIcon(weatherId) {
    if (weatherId >= 200 && weatherId < 300) return '‚õàÔ∏è';
    if (weatherId >= 300 && weatherId < 400) return 'üåßÔ∏è';
    if (weatherId >= 500 && weatherId < 600) return 'üåßÔ∏è';
    if (weatherId >= 600 && weatherId < 700) return '‚ùÑÔ∏è';
    if (weatherId >= 700 && weatherId < 800) return 'üå´Ô∏è';
    if (weatherId === 800) return '‚òÄÔ∏è';
    if (weatherId > 800) return '‚òÅÔ∏è';
    return 'üå§Ô∏è';
}
*/

// üìã –§—É–Ω–∫—Ü–∏—è –Ω–∞—á–∞–ª–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
function startVerification() {
    console.log('üìã –ù–∞—á–∞–ª–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç...');
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            console.log(`üìç –ü–æ–ª—É—á–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lng}`);
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
            const projectId = {{ project.id }};
            const verificationUrl = `/verification/?project=${projectId}&lat=${lat}&lng=${lng}`;
            
            console.log(`üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${verificationUrl}`);
            window.location.href = verificationUrl;
            
        }, function(error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–π—Ç–∏ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const result = confirm('–î–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏?');
            
            if (result) {
                const projectId = {{ project.id }};
                window.location.href = `/verification/?project=${projectId}`;
            }
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        });
    } else {
        console.error('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏...');
        
        const projectId = {{ project.id }};
        window.location.href = `/verification/?project=${projectId}`;
    }
}

// üìä –§—É–Ω–∫—Ü–∏—è –¥–ª—è Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã
function initializeExcelGanttChart() {
    const ganttData = {{ gantt_json|safe }};
    
    if (!ganttData || ganttData.length === 0) {
        console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã');
        return;
    }
    
    console.log('üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã...', ganttData);
    
    createExcelGanttChart('excel-gantt-container', ganttData);
    setupExcelGanttHandlers();
}

function createExcelGanttChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –û—á–∏—Å—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = '';
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –¥–Ω–∏
    let minDay = Math.min(...data.map(task => task.start));
    let maxDay = Math.max(...data.map(task => task.start + task.duration));
    
    // –†–∞–∑–º–µ—Ä—ã
    const svgWidth = container.offsetWidth;
    const svgHeight = Math.max(400, data.length * 35 + 100);
    const margin = { top: 60, right: 50, bottom: 50, left: 250 };
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // –°–æ–∑–¥–∞—ë–º SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', svgWidth);
    svg.setAttribute('height', svgHeight);
    svg.style.backgroundColor = 'white';
    
    // –®–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏
    const timeScale = chartWidth / (maxDay - minDay + 1);
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏
    data.forEach((task, index) => {
        const x = margin.left + (task.start - minDay) * timeScale;
        const y = margin.top + index * 32;
        const width = task.duration * timeScale;
        const height = 24;
        
        // –¶–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
        let color = '#3b82f6'; // —Å–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (task.critical) {
            color = '#ef4444'; // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö
        }
        
        // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∑–∞–¥–∞—á–∏
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', Math.max(width, 5));
        rect.setAttribute('height', height);
        rect.setAttribute('fill', color);
        rect.setAttribute('rx', 3);
        rect.setAttribute('opacity', task.critical ? 0.9 : 0.7);
        rect.setAttribute('stroke', task.critical ? '#dc2626' : 'none');
        rect.setAttribute('stroke-width', task.critical ? 2 : 0);
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${task.name}\n–ù–∞—á–∞–ª–æ: –¥–µ–Ω—å ${task.start}\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${task.duration} –¥–Ω.\n${task.critical ? '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞!' : ''}`;
        rect.appendChild(title);
        
        svg.appendChild(rect);
        
        // –ü–æ–¥–ø–∏—Å—å
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', margin.left - 10);
        text.setAttribute('y', y + height / 2 + 4);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('font-size', '11');
        text.setAttribute('fill', task.critical ? '#dc2626' : '#374151');
        text.setAttribute('font-weight', task.critical ? 'bold' : 'normal');
        text.textContent = task.name.length > 30 ? task.name.substring(0, 30) + '...' : task.name;
        svg.appendChild(text);
        
        // –ú–∞—Ä–∫–µ—Ä –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
        if (task.critical) {
            const criticalIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            criticalIcon.setAttribute('x', margin.left - 15);
            criticalIcon.setAttribute('y', y + height / 2 + 4);
            criticalIcon.setAttribute('text-anchor', 'end');
            criticalIcon.setAttribute('font-size', '12');
            criticalIcon.setAttribute('fill', '#dc2626');
            criticalIcon.textContent = '‚ö†Ô∏è';
            svg.appendChild(criticalIcon);
        }
    });
    
    // –û—Å—å –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ –¥–Ω—è–º)
    for (let day = minDay; day <= maxDay; day += Math.max(1, Math.floor((maxDay - minDay) / 10))) {
        const x = margin.left + (day - minDay) * timeScale;
        
        // –õ–∏–Ω–∏—è —Å–µ—Ç–∫–∏
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('y1', margin.top);
        line.setAttribute('x2', x);
        line.setAttribute('y2', margin.top + chartHeight);
        line.setAttribute('stroke', '#e5e7eb');
        line.setAttribute('stroke-width', 1);
        svg.appendChild(line);
        
        // –ü–æ–¥–ø–∏—Å—å –¥–Ω—è
        const dayText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        dayText.setAttribute('x', x);
        dayText.setAttribute('y', margin.top - 15);
        dayText.setAttribute('text-anchor', 'middle');
        dayText.setAttribute('font-size', '11');
        dayText.setAttribute('fill', '#6b7280');
        dayText.textContent = `–î–µ–Ω—å ${day}`;
        svg.appendChild(dayText);
    }
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const headerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    headerText.setAttribute('x', svgWidth / 2);
    headerText.setAttribute('y', 25);
    headerText.setAttribute('text-anchor', 'middle');
    headerText.setAttribute('font-size', '14');
    headerText.setAttribute('font-weight', 'bold');
    headerText.setAttribute('fill', '#1f2937');
    headerText.textContent = `–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞ (–¥–Ω–∏ ${minDay}-${maxDay})`;
    svg.appendChild(headerText);
    
    // –õ–µ–≥–µ–Ω–¥–∞
    const legend = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
    // –û–±—ã—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
    const normalRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    normalRect.setAttribute('x', margin.left);
    normalRect.setAttribute('y', svgHeight - 35);
    normalRect.setAttribute('width', 15);
    normalRect.setAttribute('height', 12);
    normalRect.setAttribute('fill', '#3b82f6');
    normalRect.setAttribute('opacity', 0.7);
    legend.appendChild(normalRect);
    
    const normalText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    normalText.setAttribute('x', margin.left + 20);
    normalText.setAttribute('y', svgHeight - 26);
    normalText.setAttribute('font-size', '12');
    normalText.setAttribute('fill', '#374151');
    normalText.textContent = '–û–±—ã—á–Ω—ã–µ –∑–∞–¥–∞—á–∏';
    legend.appendChild(normalText);
    
    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
    const criticalRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    criticalRect.setAttribute('x', margin.left + 150);
    criticalRect.setAttribute('y', svgHeight - 35);
    criticalRect.setAttribute('width', 15);
    criticalRect.setAttribute('height', 12);
    criticalRect.setAttribute('fill', '#ef4444');
    criticalRect.setAttribute('opacity', 0.9);
    criticalRect.setAttribute('stroke', '#dc2626');
    criticalRect.setAttribute('stroke-width', 2);
    legend.appendChild(criticalRect);
    
    const criticalText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    criticalText.setAttribute('x', margin.left + 170);
    criticalText.setAttribute('y', svgHeight - 26);
    criticalText.setAttribute('font-size', '12');
    criticalText.setAttribute('fill', '#374151');
    criticalText.textContent = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å';
    legend.appendChild(criticalText);
    
    svg.appendChild(legend);
    
    container.appendChild(svg);
    console.log('‚ú® Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ–∑–¥–∞–Ω–∞');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Excel –ì–∞–Ω—Ç –¥–∏–∞–≥—Ä–∞–º–º—ã
function setupExcelGanttHandlers() {
    const criticalPathBtn = document.getElementById('toggle-critical-path');
    
    if (criticalPathBtn) {
        criticalPathBtn.addEventListener('click', () => {
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
            const criticalRows = document.querySelectorAll('tr.bg-red-50');
            criticalRows.forEach(row => {
                row.style.backgroundColor = row.style.backgroundColor === 'rgb(254, 226, 226)' ? '' : '#fef2f2';
            });
        });
    }
}

// üìã –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π
function setupEventHistoryHandlers() {
    const showAllBtn = document.getElementById('show-all-events');
    const hideAllBtn = document.getElementById('hide-all-events');
    const eventsPreview = document.getElementById('events-preview');
    const eventsFull = document.getElementById('events-full');
    
    if (showAllBtn && hideAllBtn && eventsPreview && eventsFull) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
        showAllBtn.addEventListener('click', () => {
            console.log('üìã –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è...');
            
            eventsPreview.style.display = 'none';
            eventsFull.style.display = 'block';
            
            // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            eventsFull.style.opacity = '0';
            eventsFull.style.transform = 'translateY(20px)';
            eventsFull.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            
            setTimeout(() => {
                eventsFull.style.opacity = '1';
                eventsFull.style.transform = 'translateY(0)';
            }, 10);
            
            // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            setTimeout(() => {
                eventsFull.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 150);
        });
        
        // –°–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é
        hideAllBtn.addEventListener('click', () => {
            console.log('üìã –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é...');
            
            // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è
            eventsFull.style.opacity = '0';
            eventsFull.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                eventsFull.style.display = 'none';
                eventsPreview.style.display = 'block';
                
                // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ–π –≤–µ—Ä—Å–∏–∏
                eventsPreview.style.opacity = '0';
                eventsPreview.style.transform = 'translateY(-10px)';
                eventsPreview.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                
                setTimeout(() => {
                    eventsPreview.style.opacity = '1';
                    eventsPreview.style.transform = 'translateY(0)';
                }, 10);
                
                // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ –Ω–∞—á–∞–ª—É –±–ª–æ–∫–∞
                eventsPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        });
        
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    } else {
        console.log('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
setTimeout(() => {
    setupEventHistoryHandlers();
}, 100);

</script>
{% endblock %}
