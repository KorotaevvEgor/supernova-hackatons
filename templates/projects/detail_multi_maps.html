{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white overflow-hidden shadow rounded-lg mb-8">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex-1">
                    <h1 class="mt-2 text-3xl font-bold text-gray-900">{{ project.name }}</h1>
                    <p class="mt-2 text-sm text-gray-600">{{ project.address }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-3 py-1 text-sm rounded-full 
                        {% if project.status == 'active' %}bg-blue-100 text-blue-800
                        {% elif project.status == 'completed' %}bg-green-100 text-green-800
                        {% elif project.status == 'suspended' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ project.get_status_display }}
                    </span>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-primary-blue">{{ project.completion_percentage }}%</div>
                        <div class="text-sm text-gray-500">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-map-marked-alt text-primary-blue mr-2"></i>
                        –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    </h3>
                    <div class="flex space-x-2">
                        <select id="map-provider" class="text-sm border border-gray-300 rounded px-3 py-1">
                            <option value="osm" selected>üó∫Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                            <option value="satellite">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div id="map-loading" class="flex items-center justify-center h-96 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue mb-2"></div>
                        <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                    </div>
                </div>
                <div id="map" class="h-96 rounded-lg" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∫–∞—Ä—Ç –±–µ–∑ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–º–≤–æ–ª–∏–∫–∏
const mapProviders = {
    satellite: {
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attribution: '¬© ESRI, DigitalGlobe, GeoEye, Earthstar Geographics',
        name: 'ESRI –°–ø—É—Ç–Ω–∏–∫'
    },
    yandex: {
        url: 'https://core-sat.maps.yandex.net/tiles?l=sat&v=3.1025.0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU',
        attribution: '¬© –Ø–Ω–¥–µ–∫—Å',
        name: '–Ø–Ω–¥–µ–∫—Å –°–ø—É—Ç–Ω–∏–∫'
    },
    '2gis': {
        url: 'https://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1.1',
        attribution: '¬© 2–ì–ò–°',
        name: '2–ì–ò–°'
    },
    osm: {
        url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
        attribution: '¬© OpenStreetMap contributors',
        name: 'OpenStreetMap'
    }
};

let map;
let currentLayer;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–Ω–æ–≥–æ–ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–æ–π –∫–∞—Ä—Ç—ã...');
    
    if (typeof L === 'undefined') {
        console.error('‚ùå Leaflet –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        document.getElementById('map-loading').innerHTML = `
            <div class="text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold mb-2">–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                <p class="text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∫–∞—Ä—Ç</p>
                <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-primary-blue text-white rounded hover:bg-blue-600">
                    –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
        `;
        return;
    }
    
    console.log('‚úÖ Leaflet –¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É...');
    
    try {
        // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É
        map = L.map('map').setView([55.7558, 37.6176], 12); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ª–æ–π (2–ì–ò–° –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        loadMapProvider('2gis');
        
        console.log('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
        
        // –°–∫—Ä—ã–≤–∞–µ–º loading –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
        document.getElementById('map-loading').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
        let projectsData = [];
        try {
            projectsData = {{ project_for_map|default:"[]"|safe }};
            console.log('üìä –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç—ã:', projectsData);
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞:', e);
            projectsData = [];
        }
        
        if (projectsData && projectsData.length > 0) {
            console.log(`üè¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${projectsData.length} –ø—Ä–æ–µ–∫—Ç(–æ–≤) –Ω–∞ –∫–∞—Ä—Ç–µ`);
            
            projectsData.forEach((project, index) => {
                console.log(`üè† –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ${index + 1}:`, project);
                
                if (project.coordinates && project.coordinates.coordinates) {
                    let color = '#2563EB';
                    if (project.status === 'active') color = '#2563EB';
                    else if (project.status === 'completed') color = '#059669';
                    else if (project.status === 'suspended') color = '#DC2626';
                    else if (project.status === 'planned') color = '#6B7280';
                    
                    try {
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –ø–æ–ª–∏–≥–æ–Ω–∞
                        let coords = project.coordinates.coordinates[0];
                        if (project.coordinates.type === 'MultiPolygon') {
                            coords = project.coordinates.coordinates[0][0];
                        }
                        
                        const centerLng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                        const centerLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                        
                        console.log(`üéØ –¶–µ–Ω—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞: [${centerLat}, ${centerLng}]`);
                        
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ
                        map.setView([centerLat, centerLng], 15);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                        const marker = L.marker([centerLat, centerLng])
                            .bindPopup(`
                                <div class="p-3">
                                    <h3 class="font-bold text-gray-900">üè¢ ${project.name}</h3>
                                    <p class="text-sm text-gray-700 mt-1">üìç ${project.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p class="text-xs text-gray-600 mt-2">üìä –°—Ç–∞—Ç—É—Å: ${project.status}</p>
                                    <p class="text-xs text-gray-600">üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${project.completion}%</p>
                                </div>
                            `)
                            .addTo(map);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞
                        const polygonCoords = coords.map(coord => [coord[1], coord[0]]);
                        const polygon = L.polygon(polygonCoords, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.2,
                            weight: 2
                        }).bindPopup(`
                            <div class="p-3">
                                <h3 class="font-bold text-gray-900">üèóÔ∏è ${project.name}</h3>
                                <p class="text-sm text-gray-700 mt-1">üìç ${project.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <div class="mt-2 space-y-1">
                                    <p class="text-xs text-gray-600">üìã –°—Ç–∞—Ç—É—Å: ${project.status}</p>
                                    <p class="text-xs text-gray-600">üìà –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${project.completion}%</p>
                                    <p class="text-xs text-gray-600">üë∑ –ü—Ä–æ—Ä–∞–±: ${project.foreman || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</p>
                                    <p class="text-xs text-gray-600">üèõÔ∏è –ö–æ–Ω—Ç—Ä–æ–ª—å: ${project.control_service || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</p>
                                </div>
                            </div>
                        `).addTo(map);
                        
                        console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –∏ –ø–æ–ª–∏–≥–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É');
                    } catch (coordError) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', coordError);
                    }
                } else {
                    console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:', project);
                }
            });
        } else {
            console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ');
            
            // –û—Å—Ç–∞–µ–º—Å—è –Ω–∞ –ú–æ—Å–∫–≤–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –º–∞—Ä–∫–µ—Ä
            const defaultMarker = L.marker([55.7558, 37.6176])
                .bindPopup(`
                    <div class="p-3 text-center">
                        <h3 class="font-bold text-gray-900">üèõÔ∏è –ú–æ—Å–∫–≤–∞</h3>
                        <p class="text-sm text-gray-700">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</p>
                        <p class="text-xs text-gray-500 mt-2">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>
                    </div>
                `)
                .addTo(map);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∫–∞—Ä—Ç
        document.getElementById('map-provider').addEventListener('change', function(e) {
            const provider = e.target.value;
            loadMapProvider(provider);
            console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä: ${mapProviders[provider].name}`);
        });
        
        console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
        
    } catch (error) {
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É:', error);
        document.getElementById('map-loading').innerHTML = `
            <div class="text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold mb-2">–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                <p class="text-sm text-gray-600 mb-2">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                <div class="space-x-2">
                    <button onclick="location.reload()" class="px-4 py-2 bg-primary-blue text-white rounded hover:bg-blue-600">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                    <button onclick="this.parentElement.parentElement.style.display='none'" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
                        –°–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        `;
    }
});

function loadMapProvider(providerKey) {
    const provider = mapProviders[providerKey];
    if (!provider || !map) return;
    
    // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
    if (currentLayer) {
        map.removeLayer(currentLayer);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
    currentLayer = L.tileLayer(provider.url, {
        maxZoom: 18,
        attribution: provider.attribution
    }).addTo(map);
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä: ${provider.name}`);
}
</script>
{% endblock %}