{% extends 'base.html' %}
{% load static %}

{% block title %}Отметка выполненных работ - Прораб{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'moscow-blue': '#003366',
                    'moscow-red': '#DC143C',
                    'moscow-gold': '#FFD700',
                    'moscow-green': '#228B22',
                }
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-6">
    <!-- Заголовок -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl sm:rounded-2xl p-4 sm:p-8 text-white mb-6 sm:mb-8 shadow-xl">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex items-center">
                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white bg-opacity-20 rounded-xl sm:rounded-2xl flex items-center justify-center mr-4 sm:mr-6">
                    <i class="fas fa-tasks text-xl sm:text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2">Перечень работ</h1>
                    <p class="text-blue-100 text-sm sm:text-lg">Отметка выполненных работ и контроль прогресса</p>
                </div>
            </div>
            <div class="flex items-center justify-between lg:justify-end space-x-4">
                <div class="text-center">
                    <div class="text-2xl sm:text-3xl font-bold">{{ today|date:"d" }}</div>
                    <div class="text-blue-100 text-xs sm:text-sm">{{ today|date:"M Y" }}</div>
                </div>
                <a href="{% url 'foreman:dashboard' %}" 
                   class="btn-mobile inline-flex items-center px-4 sm:px-6 py-2 sm:py-3 bg-white bg-opacity-20 rounded-xl text-white hover:bg-opacity-30 transition-all duration-200 backdrop-blur-sm text-sm sm:text-base">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span class="hidden sm:inline">К дашборду</span>
                    <span class="sm:hidden">Назад</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Фильтр по проектам -->
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg border border-gray-100 p-4 sm:p-6 mb-6 sm:mb-8">
        <form method="get" class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
            <label class="text-sm font-medium text-gray-700 flex items-center">
                <i class="fas fa-filter text-blue-500 mr-2"></i>
                Проект:
            </label>
            <select name="project" onchange="this.form.submit()" 
                    class="w-full sm:w-auto px-4 py-2 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                <option value="">Все проекты</option>
                {% for project in foreman_projects %}
                <option value="{{ project.id }}" {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                    {{ project.name }}
                </option>
                {% endfor %}
            </select>
            
            {% if selected_project %}
            <div class="text-sm text-gray-600 mt-2 sm:mt-0">
                Показаны работы для: <strong>{{ selected_project.name }}</strong>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Перечень работ по спецификации -->
    {% if work_specifications %}
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-8 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-list-alt text-indigo-600 mr-3"></i>
                        Перечень работ
                    </h2>
                    <p class="mt-2 text-gray-600">
                        Спецификация выполняемых работ по проектам
                    </p>
                </div>
                <div class="bg-indigo-100 text-indigo-800 px-6 py-3 rounded-xl font-bold text-2xl">
                    {{ work_specifications.count }}
                </div>
            </div>
        </div>
        
        <div class="p-8">
            {% for spec in work_specifications %}
            <div class="mb-8 last:mb-0">
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">{{ spec.name }}</h3>
                            <p class="text-gray-600 flex items-center">
                                <i class="fas fa-building text-blue-500 mr-2"></i>
                                {{ spec.project.name }}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600">{{ spec.total_items_count }}</div>
                            <div class="text-sm text-gray-500">позиций</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table-mobile min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">№</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Наименование работ</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Количество</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Единица</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in spec.items.all %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        {{ item.order }}
                                    </td>
                                    <td class="px-3 sm:px-6 py-4 text-sm text-gray-900">
                                        {{ item.name }}
                                        <div class="sm:hidden text-xs text-gray-500 mt-1">
                                            {{ item.quantity|floatformat:2 }} {{ item.unit }}
                                        </div>
                                    </td>
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 hidden sm:table-cell">
                                        {{ item.quantity|floatformat:2 }}
                                    </td>
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">
                                        {{ item.unit }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Работы доступные для отметки -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-8 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-clipboard-check text-green-600 mr-3"></i>
                        Работы к выполнению
                    </h2>
                    <p class="mt-2 text-gray-600">
                        Доступно для отметки на сегодня ({{ today|date:"d.m.Y" }})
                    </p>
                </div>
                <div class="bg-green-100 text-green-800 px-6 py-3 rounded-xl font-bold text-2xl">
                    {{ available_works.count }}
                </div>
            </div>
        </div>
        <div class="p-8">
            {% if available_works %}
                <div class="space-y-6">
                    {% for work in available_works %}
                        <div class="bg-gray-50 border border-gray-200 rounded-xl sm:rounded-2xl p-4 sm:p-6 hover:shadow-lg transition-all duration-300 hover:bg-white" id="work-{{ work.id }}">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between space-y-4 lg:space-y-0">
                                <div class="flex-1">
                                    <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 mb-3">
                                        <h3 class="text-lg sm:text-xl font-bold text-gray-900">{{ work.name }}</h3>
                                        {% if work.is_delayed %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-red-100 text-red-700 animate-pulse w-fit">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Просрочено
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <p class="text-base sm:text-lg text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-building text-blue-500 mr-2"></i>
                                        {{ work.project.name }}
                                    </p>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-calendar-alt text-green-500 flex-shrink-0"></i>
                                            <div class="min-w-0">
                                                <div class="text-sm text-gray-500">Плановые сроки</div>
                                                <div class="font-medium text-gray-900 text-sm sm:text-base truncate">{{ work.planned_start_date|date:"d.m.Y" }} - {{ work.planned_end_date|date:"d.m.Y" }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-ruler-combined text-purple-500 flex-shrink-0"></i>
                                            <div class="min-w-0">
                                                <div class="text-sm text-gray-500">Объём работ</div>
                                                <div class="font-medium text-gray-900 text-sm sm:text-base">{{ work.volume }} {{ work.unit }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2 sm:col-span-2 lg:col-span-1">
                                            <i class="fas fa-info-circle text-blue-500 flex-shrink-0"></i>
                                            <div class="min-w-0">
                                                <div class="text-sm text-gray-500">Статус</div>
                                                <div class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-bold
                                                    {% if work.status == 'not_started' %}
                                                    bg-gray-100 text-gray-700
                                                    {% elif work.status == 'in_progress' %}
                                                    bg-yellow-100 text-yellow-700
                                                    {% endif %}">
                                                    {{ work.get_status_display }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="lg:ml-6 flex-shrink-0 w-full lg:w-auto">
                                    <button onclick="markWorkCompleted({{ work.id }}, '{{ work.name|escapejs }}')"
                                            class="btn-mobile w-full lg:w-auto inline-flex items-center justify-center px-4 sm:px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-medium rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                                        <i class="fas fa-check mr-2"></i>
                                        <span class="hidden sm:inline">Отметить выполненной</span>
                                        <span class="sm:hidden">Выполнено</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-500 text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">Отлично! Всё выполнено</h3>
                    <p class="text-gray-600 text-lg max-w-md mx-auto leading-relaxed">
                        На сегодня нет работ, доступных для отметки. Все запланированные работы выполнены в срок.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Работы ожидающие верификации -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 px-8 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-hourglass-half text-yellow-600 mr-3"></i>
                        Ожидают проверки
                    </h2>
                    <p class="mt-2 text-gray-600">
                        Отмечено как выполненное, ожидаем подтверждения
                    </p>
                </div>
                <div class="bg-yellow-100 text-yellow-800 px-6 py-3 rounded-xl font-bold text-2xl">
                    {{ pending_verification.count }}
                </div>
            </div>
        </div>
        <div class="p-8">
            {% if pending_verification %}
                <div class="space-y-6">
                    {% for work in pending_verification %}
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400 rounded-2xl p-6 shadow-md">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <h3 class="text-xl font-bold text-gray-900">{{ work.name }}</h3>
                                        <div class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-bold bg-yellow-100 text-yellow-700">
                                            <i class="fas fa-hourglass-half mr-1 animate-pulse"></i>Ожидает проверки
                                        </div>
                                    </div>
                                    
                                    <p class="text-lg text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-building text-blue-500 mr-2"></i>
                                        {{ work.project.name }}
                                    </p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-check-circle text-green-500"></i>
                                            <div>
                                                <div class="text-sm text-gray-500">Отмечено выполненным</div>
                                                <div class="font-medium text-gray-900">{{ work.updated_at|date:"d.m.Y H:i" }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-ruler-combined text-purple-500"></i>
                                            <div>
                                                <div class="text-sm text-gray-500">Объём работ</div>
                                                <div class="font-medium text-gray-900">{{ work.volume }} {{ work.unit }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-clock text-orange-500"></i>
                                            <div>
                                                <div class="text-sm text-gray-500">Статус</div>
                                                <div class="font-medium text-gray-900">Ожидает верификации</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ml-6 flex-shrink-0">
                                    <div class="inline-flex items-center px-6 py-3 bg-green-100 text-green-800 rounded-xl font-bold shadow-md">
                                        <i class="fas fa-check-double mr-2"></i>
                                        Выполнено
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-inbox text-gray-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-3">Нет работ на проверке</h3>
                    <p class="text-gray-600">Все отмеченные работы уже прошли верификацию</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl sm:rounded-2xl p-6 sm:p-8 w-full max-w-md shadow-2xl">
        <div class="modal-mobile">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            
            <h3 class="text-2xl font-bold text-gray-900 mb-2" id="modalTitle">Подтвердить выполнение</h3>
            
            <p class="text-gray-600 mb-8 leading-relaxed" id="modalText">
                Вы уверены, что хотите отметить эту работу как выполненную?
            </p>
            
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="cancelBtn" 
                        class="btn-mobile flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all font-medium">
                    <i class="fas fa-times mr-2"></i>
                    Отмена
                </button>
                
                <button id="confirmBtn" 
                        class="btn-mobile flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all font-medium shadow-lg">
                    <i class="fas fa-check mr-2"></i>
                    Подтвердить
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentWorkId = null;

function markWorkCompleted(workId, workName) {
    currentWorkId = workId;
    
    document.getElementById('modalTitle').textContent = 'Подтвердить выполнение работы';
    document.getElementById('modalText').textContent = `Отметить работу "${workName}" как выполненную?`;
    
    document.getElementById('confirmModal').classList.remove('hidden');
}

document.getElementById('confirmBtn').addEventListener('click', function() {
    if (currentWorkId) {
        // Отправляем AJAX запрос
        fetch('{% url "foreman:mark_work_completed" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
            },
            body: JSON.stringify({
                work_id: currentWorkId,
                notes: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Скрываем работу из списка доступных
                const workElement = document.getElementById(`work-${currentWorkId}`);
                if (workElement) {
                    workElement.style.transition = 'opacity 0.3s ease';
                    workElement.style.opacity = '0.5';
                    
                    setTimeout(() => {
                        workElement.remove();
                        // Обновляем страницу через 2 секунды чтобы показать в секции ожидающих верификации
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }, 500);
                }
                
                // Показываем уведомление об успехе
                showNotification('Работа отмечена как выполненная!', 'success');
            } else {
                showNotification('Ошибка при отметке работы: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Произошла ошибка при отметке работы', 'error');
        });
        
        document.getElementById('confirmModal').classList.add('hidden');
        currentWorkId = null;
    }
});

document.getElementById('cancelBtn').addEventListener('click', function() {
    document.getElementById('confirmModal').classList.add('hidden');
    currentWorkId = null;
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    // Простое уведомление
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md text-white z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Добавляем CSRF токен в мета-теги если его нет
if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
    const csrfToken = getCookie('csrftoken');
    if (csrfToken) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = csrfToken;
        document.head.appendChild(meta);
    }
}
</script>

{% csrf_token %}
{% endblock %}