{% extends 'base.html' %}

{% block title %}–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ä–∞–±–∞ - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º{% endblock %}

{% block content %}
<style>
    .qr-code-container {
        transition: all 0.3s ease;
    }
    .qr-code-container.hidden {
        opacity: 0;
        transform: scale(0.8);
    }
    .countdown {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    .project-selector {
        background: rgba(255, 255, 255, 0.95);
    }
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="mb-8">
    <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-lg shadow-lg">
        <div class="px-6 py-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üë∑‚Äç‚ôÇÔ∏è –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ä–∞–±–∞</h1>
                    <p class="text-orange-100">{{ user.get_full_name|default:user.username }}</p>
                    <p class="text-sm text-orange-200 mt-1">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–≤–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ</p>
                </div>
                <div class="hidden md:block">
                    <i class="fas fa-qrcode text-6xl text-orange-200 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-qrcode text-orange-600 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-800">–í—Å–µ–≥–æ QR-–∫–æ–¥–æ–≤</h4>
                <p class="text-2xl font-bold text-orange-600">{{ stats.total_tokens }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-clock text-yellow-500 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-800">–ê–∫—Ç–∏–≤–Ω—ã—Ö</h4>
                <p class="text-2xl font-bold text-yellow-500">{{ stats.active_tokens }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-800">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</h4>
                <p class="text-2xl font-bold text-green-600">{{ stats.verified_tokens }}</p>
            </div>
        </div>
    </div>
</div>

<!-- –í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR -->
<div class="bg-white rounded-lg shadow-md p-8 mb-6">
    <div class="text-center">
        <div class="mb-6">
            <i class="fas fa-map-marker-alt text-orange-600 text-4xl mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h2>
            <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å, –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞</p>
        </div>

        {% if user_projects %}
            <div class="mb-6">
                <select id="projectSelect" class="project-selector w-full max-w-md mx-auto px-4 py-3 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                    {% for project in user_projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button 
                id="generateQRBtn" 
                class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-4 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="generateQRCode()"
                disabled
            >
                <i class="fas fa-magic mr-2"></i>
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
            </button>

            <div class="mt-6 text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                QR-–∫–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ <span class="font-bold text-red-600">15 —Å–µ–∫—É–Ω–¥</span>
            </div>
        {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <p class="text-yellow-800">–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —Å QR-–∫–æ–¥–æ–º (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="qrCodePanel" class="bg-white rounded-lg shadow-md p-8 qr-code-container hidden">
    <div class="text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-4">üéØ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤!</h3>
        
        <!-- QR-–∫–æ–¥ -->
        <div class="mb-6">
            <img id="qrCodeImage" src="" alt="QR Code" class="mx-auto border-4 border-orange-500 rounded-lg shadow-lg">
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
        <div class="mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4">
            <h4 class="font-semibold text-orange-900 mb-2">–ü—Ä–æ–µ–∫—Ç:</h4>
            <p id="projectName" class="text-orange-800 text-lg">-</p>
        </div>

        <!-- –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ -->
        <div class="mb-6">
            <div class="inline-flex items-center bg-red-600 text-white px-4 py-2 rounded-full">
                <i class="fas fa-hourglass-half mr-2"></i>
                <span class="countdown">–û—Å—Ç–∞–ª–æ—Å—å: </span>
                <span id="countdown" class="countdown ml-1">15</span>
                <span class="countdown"> —Å–µ–∫</span>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ -->
        <div class="bg-gray-50 rounded-lg p-4 text-left mb-4">
            <div class="grid grid-cols-1 gap-2 text-sm">
                <div>
                    <span class="font-semibold text-gray-700">–¢–æ–∫–µ–Ω:</span>
                    <span id="tokenInfo" class="text-gray-600 font-mono ml-2">-</span>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">–°–æ–∑–¥–∞–Ω:</span>
                    <span id="createdInfo" class="text-gray-600 ml-2">-</span>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">–ò—Å—Ç–µ–∫–∞–µ—Ç:</span>
                    <span id="expiresInfo" class="text-gray-600 ml-2">-</span>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞ -->
        <button 
            id="newQRBtn" 
            class="mt-4 bg-green-600 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg transition-colors hidden"
            onclick="generateQRCode()"
        >
            <i class="fas fa-refresh mr-2"></i>
            –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π QR-–∫–æ–¥
        </button>
    </div>
</div>

<script>
    let countdownTimer = null;
    let currentToken = null;

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞
    document.getElementById('projectSelect').addEventListener('change', function() {
        const generateBtn = document.getElementById('generateQRBtn');
        generateBtn.disabled = !this.value;
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
    async function generateQRCode() {
        const projectSelect = document.getElementById('projectSelect');
        const projectId = projectSelect.value;
        
        if (!projectId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç');
            return;
        }

        const btn = document.getElementById('generateQRBtn');
        const originalText = btn.innerHTML;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        btn.disabled = true;

        try {
            const response = await fetch('/foreman/generate-qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    project_id: projectId
                })
            });

            const data = await response.json();

            if (data.success) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º QR-–∫–æ–¥
                displayQRCode(data);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω
                currentToken = data.token;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
                startCountdown(data.expires_in);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è QR-–∫–æ–¥–∞
    function displayQRCode(data) {
        const panel = document.getElementById('qrCodePanel');
        const image = document.getElementById('qrCodeImage');
        const tokenInfo = document.getElementById('tokenInfo');
        const createdInfo = document.getElementById('createdInfo');
        const expiresInfo = document.getElementById('expiresInfo');
        const projectName = document.getElementById('projectName');
        const newQRBtn = document.getElementById('newQRBtn');

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞
        newQRBtn.classList.add('hidden');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        image.src = data.qr_code;
        tokenInfo.textContent = data.token.substring(0, 16) + '...';
        createdInfo.textContent = new Date().toLocaleString('ru-RU');
        expiresInfo.textContent = new Date(data.expires_at).toLocaleString('ru-RU');
        projectName.textContent = data.project_name;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth' });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
    function startCountdown(seconds) {
        let timeLeft = seconds;
        const countdownElement = document.getElementById('countdown');
        const newQRBtn = document.getElementById('newQRBtn');

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (countdownTimer) {
            clearInterval(countdownTimer);
        }

        countdownTimer = setInterval(() => {
            countdownElement.textContent = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(countdownTimer);
                countdownElement.textContent = '0';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞
                newQRBtn.classList.remove('hidden');
                
                // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ —Å–µ—Ä—ã–π
                countdownElement.parentElement.classList.remove('bg-red-600');
                countdownElement.parentElement.classList.add('bg-gray-500');
                countdownElement.parentElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>QR-–∫–æ–¥ –∏—Å—Ç–µ–∫';
            }

            timeLeft--;
        }, 1000);
    }
</script>

{% endblock %}