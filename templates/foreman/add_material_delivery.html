{% extends 'base.html' %}

{% block title %}OCR - Распознавание текста{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-8">
  <!-- Заголовок -->
  <div class="mb-8">
    <div class="flex items-center space-x-4">
      <a href="{% url 'foreman:materials_control' %}" class="text-gray-600 hover:text-gray-900">
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <h1 class="text-2xl font-bold text-gray-900">Распознавание текста из изображений</h1>
    </div>
  </div>

  <!-- Загрузка файла -->
    <!-- Быстрая загрузка -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-2">
      <i class="fas fa-bolt text-primary-blue mr-2"></i>Быстрая загрузка ТТН
      <a href="/ocr-api/demo" target="_blank" class="text-sm text-primary-blue hover:underline ml-4">
        <i class="fas fa-external-link-alt mr-1"></i>Попробовать API для распознавания текста
      </a>
    </h2>
    
    <p class="text-gray-600 mb-4">
      Загрузите изображение или PDF-файл с текстом для распознавания. 
      Поддерживаются форматы: JPG, PNG, PDF.
    </p>

    <!-- Зона загрузки файла -->
    <div id="upload-zone" 
         class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-md py-8 cursor-pointer hover:border-primary-blue transition-colors">
      <i class="fas fa-file-upload text-4xl text-primary-blue mb-2"></i>
      <p class="text-gray-700 font-medium text-center">
        Перетащите PDF/JPG/PNG файл ТТН сюда<br>или выберите файл
      </p>
      <input type="file" id="file-input" name="document" accept=".pdf,image/*" class="hidden">
      <button type="button" id="file-select-btn" 
              class="mt-4 px-6 py-2 bg-primary-blue text-white rounded-md hover:bg-primary-blue/90 transition-colors">
        Выбрать файл
      </button>
      <div id="upload-status" class="mt-4 text-sm"></div>
    </div>

    <!-- Превью файла и результаты -->
    <div id="preview-container" class="mt-6 hidden">
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="mb-4">
          <h3 class="text-lg font-medium text-gray-900">Загруженный файл</h3>
          <div id="preview-content" class="mt-2"></div>
        </div>

        <div class="mt-6">
          <h3 class="text-lg font-medium text-gray-900 mb-2">Распознанный текст</h3>
          <div id="ocr-result" class="bg-white p-4 rounded border">
            <div id="loading-indicator" class="text-center text-gray-600 hidden">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              Распознавание текста...
            </div>
            <pre id="ocr-text" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
          </div>
        </div>

        <div class="mt-4 flex justify-end space-x-4">
          <button type="button" id="copy-btn"
                  class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
            <i class="fas fa-copy mr-2"></i>Копировать текст
          </button>
          <button type="button" id="new-file-btn"
                  class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-primary-blue/90 transition-colors">
            <i class="fas fa-plus mr-2"></i>Загрузить другой файл
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Форма редактирования -->
  <form id="edit-form" method="post" class="hidden bg-white shadow rounded-lg p-6">
    {% csrf_token %}
    
    <!-- Скрытые поля -->
    <input type="hidden" id="form_project_id" name="project_id">
    <input type="hidden" id="transport_document_id" name="transport_document_id">
    <input type="hidden" id="document_photo_id" name="document_photo_id">
    <input type="hidden" id="delivery_id" name="delivery_id">
    <input type="hidden" id="ocr_result_id" name="ocr_result_id">
    
    <h2 class="text-xl font-bold text-gray-900 mb-6">
      <i class="fas fa-edit text-primary-blue mr-2"></i>Редактирование материала
    </h2>
    
    <div class="space-y-6">
      <!-- Проект -->
      <div class="hidden">
        <label for="project_id" class="block text-sm font-medium text-gray-700">
          Проект <span class="text-red-500">*</span>
        </label>
        <select name="project_id" id="project_id" required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Выберите проект...</option>
          {% for project in request.user.projects.all %}
          <option value="{{ project.id }}">{{ project.name }}</option>
          {% endfor %}
        </select>
      </div>
    
      <!-- Тип материала -->
      <div>
        <label for="material_type_id" class="block text-sm font-medium text-gray-700">
          Тип материала <span class="text-red-500">*</span>
        </label>
        <select name="material_type_id" id="material_type_id" required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Выберите материал...</option>
          {% for material_type in material_types %}
          <option value="{{ material_type.id }}" data-unit="{{ material_type.unit }}">
            {{ material_type.name }}
          </option>
          {% endfor %}
        </select>
      </div>

        <!-- Количество и единицы измерения -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700">
              Количество <span class="text-red-500">*</span>
            </label>
            <input type="number" step="0.01" name="quantity" id="quantity" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">
              Единица измерения
            </label>
            <div id="unit-display" 
                 class="mt-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-600">
              Выберите материал
            </div>
          </div>
        </div>

        <!-- ТТН и дата -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="ttn_number" class="block text-sm font-medium text-gray-700">
              Номер ТТН
            </label>
            <input type="text" name="ttn_number" id="ttn_number"
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label for="delivery_date" class="block text-sm font-medium text-gray-700">
              Дата поставки <span class="text-red-500">*</span>
            </label>
            <input type="date" name="delivery_date" id="delivery_date" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
        </div>

        <!-- Поставщик -->
        <div>
          <label for="supplier" class="block text-sm font-medium text-gray-700">
            Поставщик <span class="text-red-500">*</span>
          </label>
          <input type="text" name="supplier" id="supplier" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>

        <!-- Превью документа -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Загруженный документ
          </label>
          <div id="form-preview"></div>
        </div>
      </div>

      <div class="flex justify-end space-x-4 mt-6">
        <button type="button" id="cancel-btn"
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
          Отмена
        </button>
        <button type="submit"
                class="px-4 py-2 bg-primary-blue text-white rounded-md text-sm font-medium hover:bg-primary-blue/90">
          Сохранить
        </button>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const uploadZone = document.getElementById('upload-zone');
  const fileInput = document.getElementById('file-input');
  const fileSelectBtn = document.getElementById('file-select-btn');
  const uploadStatus = document.getElementById('upload-status');
  const previewContainer = document.getElementById('preview-container');
  const previewContent = document.getElementById('preview-content');
  const editBtn = document.getElementById('edit-btn');
  const editForm = document.getElementById('edit-form');
  const cancelBtn = document.getElementById('cancel-btn');
  
  // Set today as default date
  document.getElementById('delivery_date').valueAsDate = new Date();

  // File selection button
  fileSelectBtn.addEventListener('click', () => fileInput.click());

  // Handle drag and drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  uploadZone.addEventListener('dragenter', () => {
    uploadZone.classList.add('border-primary-blue');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('border-primary-blue');
  });

  uploadZone.addEventListener('drop', (e) => {
    uploadZone.classList.remove('border-primary-blue');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  // Handle file selection
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  // Process selected file
  async function handleFile(file) {
    const projectId = document.getElementById('project_id').value;
    
    if (!projectId) {
      showStatus('error', 'Пожалуйста, выберите проект перед загрузкой файла');
      return;
    }

    try {
      showStatus('loading', 'Загрузка файла...');
      
      // Загружаем файл
      const formData = new FormData();
      formData.append('document', file);
      formData.append('project_id', projectId);

      const uploadResponse = await fetch('/api/materials/ttn/upload/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });

      if (!uploadResponse.ok) {
        throw new Error('Ошибка при загрузке файла');
      }

      const uploadData = await uploadResponse.json();
      console.log('Данные после загрузки:', uploadData);

      if (!uploadData.success) {
        throw new Error(uploadData.error || 'Ошибка при загрузке файла');
      }

      // Сохраняем ID документов
      window.transportDocumentId = uploadData.transport_document_id;
      window.documentPhotoId = uploadData.document_photo_id;
      window.deliveryId = uploadData.delivery_id;
      window.ocrResultId = uploadData.ocr_result?.ocr_result_id;

      // Запрашиваем статус OCR
      showStatus('loading', 'Получение результатов распознавания...');
      const statusResponse = await fetch(`/api/materials/ttn/photos/${uploadData.document_photo_id}/status/`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });

      if (!statusResponse.ok) {
        throw new Error('Ошибка при получении статуса OCR');
      }

      const statusData = await statusResponse.json();
      console.log('Статус OCR:', statusData);

      // Прямое автозаполнение полей без кнопки
      const ocrFormData = uploadData.ocr_result?.form_data || {};
      
      if (Object.keys(ocrFormData).length > 0) {
        showStatus('success', 'Документ обработан, поля автоматически заполнены');
        
        // Показываем превью с OCR данными
        showPreviewWithAutoFill(file, statusData.ocr_data || {}, ocrFormData);
        
        // Немедленно автозаполняем форму
        fillFormDirectly(ocrFormData);
        
        // Показываем форму редактирования
        showEditForm();
      } else {
        showStatus('warning', 'Документ обработан, но данные не распознаны');
        showPreview(file, statusData.ocr_data || {});
        showEditForm();
      }

    } catch (error) {
      console.error('Ошибка при обработке файла:', error);
      showStatus('error', error.message);
    }
  }

  // Show status message
  function showStatus(type, message) {
    uploadStatus.textContent = message;
    uploadStatus.className = 'mt-4 text-sm ' + 
      (type === 'error' ? 'text-red-600' : 
       type === 'success' ? 'text-green-600' : 
       'text-blue-600');
  }

  // Format OCR data for display
  function formatOCRData(data) {
    if (typeof data === 'string') {
      return data;
    }
    if (Array.isArray(data)) {
      return data.map(item => item.text || item.content || '').join('\n');
    }
    if (data.text) {
      return data.text;
    }
    if (data.lines) {
      return data.lines.map(line => line.text || line.content || '').join('\n');
    }
    return JSON.stringify(data, null, 2);
  }

  // Прямое автозаполнение формы
  function fillFormDirectly(formData) {
    console.log('🚀 Прямое автозаполнение полей:', formData);

    // Копируем ID проекта
    const projectIdField = document.getElementById('project_id');
    if (projectIdField && projectIdField.value) {
      document.getElementById('form_project_id').value = projectIdField.value;
    }

    // Заполняем скрытые поля
    if (window.transportDocumentId) {
      document.getElementById('transport_document_id').value = window.transportDocumentId;
    }
    if (window.documentPhotoId) {
      document.getElementById('document_photo_id').value = window.documentPhotoId;
    }
    if (window.deliveryId) {
      document.getElementById('delivery_id').value = window.deliveryId;
    }
    if (window.ocrResultId) {
      document.getElementById('ocr_result_id').value = window.ocrResultId;
    }

    // Номер ТТН
    if (formData.ttn_number) {
      const field = document.getElementById('ttn_number');
      field.value = formData.ttn_number;
      highlightAutoFilledField(field, 'Номер ТТН: ' + formData.ttn_number);
    }

    // Дата поставки
    if (formData.delivery_date) {
      const field = document.getElementById('delivery_date');
      field.value = formData.delivery_date;
      highlightAutoFilledField(field, 'Дата поставки: ' + formData.delivery_date);
    }

    // Поставщик
    if (formData.supplier) {
      const field = document.getElementById('supplier');
      field.value = formData.supplier;
      highlightAutoFilledField(field, 'Поставщик: ' + formData.supplier);
    }

    // Количество
    if (formData.quantity) {
      const field = document.getElementById('quantity');
      field.value = formData.quantity;
      highlightAutoFilledField(field, 'Количество: ' + formData.quantity);
    }

    // Автоматический поиск типа материала
    if (formData.material_hint) {
      const materialSelect = document.getElementById('material_type_id');
      if (materialSelect) {
        const materialHint = formData.material_hint.toLowerCase();
        const keywords = ['цемент', 'песок', 'щебень', 'кирпич', 'бетон', 'арматура'];
        
        let bestMatch = null;
        let bestScore = 0;
        
        Array.from(materialSelect.options).forEach(option => {
          if (option.value) {
            const optionText = option.text.toLowerCase();
            
            // Поиск по ключевым словам
            for (const keyword of keywords) {
              if (materialHint.includes(keyword) && optionText.includes(keyword)) {
                const score = keyword.length + 10; // Приоритет ключевым словам
                if (score > bestScore) {
                  bestScore = score;
                  bestMatch = option;
                }
              }
            }
            
            // Общее соответствие
            if (optionText.includes(materialHint) && materialHint.length > 3) {
              const score = materialHint.length;
              if (score > bestScore) {
                bestScore = score;
                bestMatch = option;
              }
            }
          }
        });
        
        if (bestMatch) {
          materialSelect.value = bestMatch.value;
          materialSelect.dispatchEvent(new Event('change'));
          highlightAutoFilledField(materialSelect, 'Тип материала: ' + bestMatch.text);
        }
      }
    }

    // Показываем статистику
    if (formData.ocr_confidence || formData.ocr_service) {
      showAutoFillStats(formData);
    }

    console.log('✅ Автозаполнение завершено');
  }

  // Показываем статистику автозаполнения
  function showAutoFillStats(formData) {
    const autoFilledCount = Object.keys(formData).filter(key => 
      !['ocr_confidence', 'ocr_service'].includes(key) && formData[key]
    ).length;
    
    const statsHtml = `
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
        <div class="flex items-center mb-3">
          <div class="flex-shrink-0">
            <i class="fas fa-magic text-green-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800">
              Автозаполнение завершено
            </h3>
            <p class="text-sm text-green-700 mt-1">
              Заполнено <span class="font-semibold">${autoFilledCount}</span> полей из распознанного документа
            </p>
          </div>
        </div>
        <div class="bg-white rounded p-3">
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-700">${formData.ocr_service || 'OCR Service'}</span>
            <span class="font-semibold text-green-800">
              <i class="fas fa-check-circle mr-1"></i>
              ${formData.ocr_confidence || 0}% точность
            </span>
          </div>
          <p class="text-xs text-gray-600 mt-2">
            <i class="fas fa-edit mr-1"></i>
            Проверьте и отредактируйте поля при необходимости
          </p>
        </div>
      </div>
    `;
    
    const formPreview = document.getElementById('form-preview');
    if (formPreview) {
      const existingStats = formPreview.querySelector('.bg-green-50');
      if (existingStats) existingStats.remove();
      formPreview.insertAdjacentHTML('beforeend', statsHtml);
    }
  }

  // Показ превью с автозаполнением
  function showPreviewWithAutoFill(file, ocrData, formData) {
    let html = '<div class="space-y-4">';
    
    // Превью файла
    if (file.type.startsWith('image/')) {
      html += `<img src="${URL.createObjectURL(file)}" class="h-32 w-auto rounded border">`;
    } else if (file.type === 'application/pdf') {
      html += `
        <div class="flex items-center space-x-2 text-primary-blue">
          <i class="fas fa-file-pdf text-4xl"></i>
          <span class="text-gray-900">${file.name}</span>
        </div>`;
    }

    // Информация о распознавании
    html += `
      <div class="bg-blue-50 p-4 rounded-lg">
        <h3 class="font-medium text-blue-900 flex items-center mb-2">
          <i class="fas fa-robot mr-2"></i>
          Результат распознавания
        </h3>
        <div class="text-sm text-blue-800">
          <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Поля формы автоматически заполнены</p>
        </div>
      </div>
    `;
    
    html += '</div>';
    
    document.getElementById('preview-content').innerHTML = html;
    document.getElementById('preview-container').classList.remove('hidden');
  }

  // Показ формы редактирования
  function showEditForm() {
    const editForm = document.getElementById('edit-form');
    if (editForm) {
      editForm.classList.remove('hidden');
      
      // Плавно прокручиваем к форме
      setTimeout(() => {
        editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }

  // Show file preview (старая функция для случаев без OCR)
  function showPreview(file, ocrData) {
    let html = '<div class="space-y-4">';
    
    // File preview
    if (file.type.startsWith('image/')) {
      html += `<img src="${URL.createObjectURL(file)}" class="h-32 w-auto rounded border">`;
    } else if (file.type === 'application/pdf') {
      html += `
        <div class="flex items-center space-x-2 text-primary-blue">
          <i class="fas fa-file-pdf text-4xl"></i>
          <span class="text-gray-900">${file.name}</span>
        </div>`;
    }

    // OCR results
    html += `
      <div class="bg-gray-50 p-4 rounded-lg space-y-2">
        <h3 class="font-medium text-gray-900">Распознанный текст:</h3>
        <pre class="text-sm text-gray-700 whitespace-pre-wrap bg-white p-3 rounded border">${formatOCRData(ocrData)}</pre>
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <details class="cursor-pointer">
          <summary class="font-medium mb-2">Техническая информация</summary>
          <div class="pl-4 space-y-2">
            <div class="space-y-1">
              <p class="font-medium">ID документов:</p>
              <div class="bg-gray-100 p-2 rounded">
                <div>Transport Document ID: ${window.transportDocumentId || '-'}</div>
                <div>Document Photo ID: ${window.documentPhotoId || '-'}</div>
                <div>Delivery ID: ${window.deliveryId || '-'}</div>
                <div>OCR Result ID: ${window.ocrResultId || '-'}</div>
              </div>
            </div>
            
            <div class="space-y-1">
              <p class="font-medium">Raw OCR данные:</p>
              <pre class="bg-gray-100 p-2 rounded overflow-auto max-h-40">${JSON.stringify(ocrData, null, 2)}</pre>
            </div>
          </div>
        </details>
      </div>`;

    html += '</div>';
    
    previewContent.innerHTML = html;
    previewContainer.classList.remove('hidden');
  }

  // Extract data from OCR text
  function findTTNNumber(text) {
    const patterns = [
      /(?:ттн|накладная|тн)[^\d]*(\d[\d-\/\\]*\d)/i,
      /№\s*([A-Za-zА-Яа-я0-9-\/\\]+)/i,
      /номер:?\s*([A-Za-zА-Яа-я0-9-\/\\]+)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findDate(text) {
    const patterns = [
      /(\d{1,2}[.-]\d{1,2}[.-]\d{2,4})/,
      /(\d{4}[.-]\d{1,2}[.-]\d{1,2})/,
      /от:?\s*(\d{1,2}[.-]\d{1,2}[.-]\d{2,4})/i
    ];
    return findByPatterns(text, patterns);
  }

  function findSupplier(text) {
    const patterns = [
      /поставщик:?\s*([^"\n\r]*)/i,
      /от\s*кого:?\s*([^"\n\r]*)/i,
      /организация:?\s*([^"\n\r]*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findMaterial(text) {
    const patterns = [
      /материал:?\s*([^"\n\r]*)/i,
      /наименование:?\s*([^"\n\r]*)/i,
      /товар:?\s*([^"\n\r]*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findQuantity(text) {
    const patterns = [
      /количество:?\s*(\d+[.,]?\d*)/i,
      /объем:?\s*(\d+[.,]?\d*)/i,
      /масса:?\s*(\d+[.,]?\d*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findUnit(text) {
    const patterns = [
      /(?:шт|кг|тн|м3|куб\.м|л|мл|г|см|м|км)/i
    ];
    const match = text.match(patterns[0]);
    return match ? match[0] : null;
  }

  function findByPatterns(text, patterns) {
    for (const pattern of patterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }
    return null;
  }

  // Show edit form with enhanced OCR data
  async function showEditFormWithOCRData(file, ocrData, formData) {
    console.log('Обработка улучшенных OCR данных:', formData);

    // Copy project ID
    document.getElementById('form_project_id').value = document.getElementById('project_id').value;

    // Fill hidden fields
    document.getElementById('transport_document_id').value = window.transportDocumentId || '';
    document.getElementById('document_photo_id').value = window.documentPhotoId || '';
    document.getElementById('delivery_id').value = window.deliveryId || '';
    document.getElementById('ocr_result_id').value = window.ocrResultId || '';

    // Автозаполняем поля из структурированных данных OCR
    if (formData.ttn_number) {
      const ttnField = document.getElementById('ttn_number');
      ttnField.value = formData.ttn_number;
      highlightAutoFilledField(ttnField, 'Номер ТТН');
    }

    if (formData.delivery_date) {
      const dateField = document.getElementById('delivery_date');
      dateField.value = formData.delivery_date;
      highlightAutoFilledField(dateField, 'Дата поставки');
    }

    if (formData.supplier) {
      const supplierField = document.getElementById('supplier');
      supplierField.value = formData.supplier;
      highlightAutoFilledField(supplierField, 'Поставщик');
    }

    if (formData.quantity) {
      const quantityField = document.getElementById('quantity');
      quantityField.value = formData.quantity;
      highlightAutoFilledField(quantityField, 'Количество');
    }

    // Попытаемся найти соответствующий тип материала
    if (formData.material_hint) {
      const materialSelect = document.getElementById('material_type_id');
      const materialHint = formData.material_hint.toLowerCase();
      
      let bestMatch = null;
      let bestScore = 0;
      
      Array.from(materialSelect.options).forEach(option => {
        if (option.value) {
          const optionText = option.text.toLowerCase();
          
          // Простое соответствие по ключевым словам
          const keywords = ['цемент', 'песок', 'щебень', 'кирпич', 'бетон'];
          
          for (const keyword of keywords) {
            if (materialHint.includes(keyword) && optionText.includes(keyword)) {
              const score = keyword.length;
              if (score > bestScore) {
                bestScore = score;
                bestMatch = option;
              }
            }
          }
          
          // Общее соответствие
          if (optionText.includes(materialHint) || materialHint.includes(optionText)) {
            const score = Math.min(optionText.length, materialHint.length);
            if (score > bestScore) {
              bestScore = score;
              bestMatch = option;
            }
          }
        }
      });
      
      if (bestMatch) {
        materialSelect.value = bestMatch.value;
        materialSelect.dispatchEvent(new Event('change'));
        highlightAutoFilledField(materialSelect, 'Тип материала');
      }
    }

    // Показываем статистику OCR
    if (formData.ocr_confidence || formData.ocr_service) {
      showOCRStats(formData);
    }

    // Show form
    editForm.classList.remove('hidden');
  }
  
  // Подсвечиваем автозаполненные поля
  function highlightAutoFilledField(field, fieldName) {
    field.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
    field.title = `Автоматически заполнено: ${fieldName}`;
    
    // Убираем подсветку через 3 секунды
    setTimeout(() => {
      field.classList.remove('ring-2', 'ring-green-500', 'bg-green-50');
      field.title = '';
    }, 3000);
  }
  
  // Показываем статистику OCR
  function showOCRStats(formData) {
    const statsHtml = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
        <h4 class="text-sm font-medium text-blue-800 mb-2">
          <i class="fas fa-robot mr-2"></i>Статистика распознавания
        </h4>
        <div class="flex justify-between items-center text-sm">
          <span class="text-blue-700">${formData.ocr_service || 'OCR Service'}</span>
          <span class="font-semibold text-blue-800">${formData.ocr_confidence || 0}% точность</span>
        </div>
        <p class="text-xs text-blue-600 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          Поля заполнены автоматически. Проверьте и отредактируйте при необходимости.
        </p>
      </div>
    `;
    
    // Находим место для вставки статистики
    const formPreview = document.getElementById('form-preview');
    if (formPreview) {
      const existingStats = formPreview.querySelector('.bg-blue-50');
      if (existingStats) {
        existingStats.remove();
      }
      formPreview.insertAdjacentHTML('beforeend', statsHtml);
    }
  }
  
  // Оставляем старую функцию для обратной совместимости
  async function showEditForm(file, ocrData) {
    return showEditFormWithOCRData(file, ocrData, {});
  }

  // Handle edit button click
  editBtn.addEventListener('click', () => {
    previewContainer.classList.add('hidden');
    editForm.classList.remove('hidden');
  });

  // Handle cancel button click
  cancelBtn.addEventListener('click', () => {
    editForm.classList.add('hidden');
    previewContainer.classList.remove('hidden');
  });

  // Update unit display when material type changes
  document.getElementById('material_type_id').addEventListener('change', function() {
    const unit = this.options[this.selectedIndex].dataset.unit || 'Не указано';
    document.getElementById('unit-display').textContent = unit;
  });

  // Form validation
  editForm.addEventListener('submit', function(e) {
    const required = ['form_project_id', 'material_type_id', 'quantity', 'supplier', 'delivery_date'];
    const empty = required.filter(id => !document.getElementById(id).value);
    
    if (empty.length > 0) {
      e.preventDefault();
      alert('Пожалуйста, заполните все обязательные поля');
      return;
    }

    const quantity = parseFloat(document.getElementById('quantity').value);
    if (isNaN(quantity) || quantity <= 0) {
      e.preventDefault();
      alert('Количество должно быть больше нуля');
      return;
    }
  });
});
</script>
{% endblock %}
