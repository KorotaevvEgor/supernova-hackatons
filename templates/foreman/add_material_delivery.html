{% extends 'base.html' %}

{% block title %}OCR - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-8">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="mb-8">
    <div class="flex items-center space-x-4">
      <a href="{% url 'foreman:materials_control' %}" class="text-gray-600 hover:text-gray-900">
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <h1 class="text-2xl font-bold text-gray-900">–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
    </div>
  </div>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <!-- –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-2">
      <i class="fas fa-bolt text-primary-blue mr-2"></i>–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¢–¢–ù
      <a href="/ocr-api/demo" target="_blank" class="text-sm text-primary-blue hover:underline ml-4">
        <i class="fas fa-external-link-alt mr-1"></i>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å API –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
      </a>
    </h2>
    
    <p class="text-gray-600 mb-4">
      –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ PDF-—Ñ–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. 
      –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, PDF.
    </p>

    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
    <div id="upload-zone" 
         class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-md py-8 cursor-pointer hover:border-primary-blue transition-colors">
      <i class="fas fa-file-upload text-4xl text-primary-blue mb-2"></i>
      <p class="text-gray-700 font-medium text-center">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PDF/JPG/PNG —Ñ–∞–π–ª –¢–¢–ù —Å—é–¥–∞<br>–∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
      </p>
      <input type="file" id="file-input" name="document" accept=".pdf,image/*" class="hidden">
      <button type="button" id="file-select-btn" 
              class="mt-4 px-6 py-2 bg-primary-blue text-white rounded-md hover:bg-primary-blue/90 transition-colors">
        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
      </button>
      <div id="upload-status" class="mt-4 text-sm"></div>
    </div>

    <!-- –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="preview-container" class="mt-6 hidden">
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="mb-4">
          <h3 class="text-lg font-medium text-gray-900">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</h3>
          <div id="preview-content" class="mt-2"></div>
        </div>

        <div class="mt-6">
          <h3 class="text-lg font-medium text-gray-900 mb-2">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</h3>
          <div id="ocr-result" class="bg-white p-4 rounded border">
            <div id="loading-indicator" class="text-center text-gray-600 hidden">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...
            </div>
            <pre id="ocr-text" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
          </div>
        </div>

        <div class="mt-4 flex justify-end space-x-4">
          <button type="button" id="copy-btn"
                  class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
            <i class="fas fa-copy mr-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
          </button>
          <button type="button" id="new-file-btn"
                  class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-primary-blue/90 transition-colors">
            <i class="fas fa-plus mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <form id="edit-form" method="post" class="hidden bg-white shadow rounded-lg p-6">
    {% csrf_token %}
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
    <input type="hidden" id="form_project_id" name="project_id">
    <input type="hidden" id="transport_document_id" name="transport_document_id">
    <input type="hidden" id="document_photo_id" name="document_photo_id">
    <input type="hidden" id="delivery_id" name="delivery_id">
    <input type="hidden" id="ocr_result_id" name="ocr_result_id">
    
    <h2 class="text-xl font-bold text-gray-900 mb-6">
      <i class="fas fa-edit text-primary-blue mr-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    </h2>
    
    <div class="space-y-6">
      <!-- –ü—Ä–æ–µ–∫—Ç -->
      <div class="hidden">
        <label for="project_id" class="block text-sm font-medium text-gray-700">
          –ü—Ä–æ–µ–∫—Ç <span class="text-red-500">*</span>
        </label>
        <select name="project_id" id="project_id" required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç...</option>
          {% for project in request.user.projects.all %}
          <option value="{{ project.id }}">{{ project.name }}</option>
          {% endfor %}
        </select>
      </div>
    
      <!-- –¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
      <div>
        <label for="material_type_id" class="block text-sm font-medium text-gray-700">
          –¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ <span class="text-red-500">*</span>
        </label>
        <select name="material_type_id" id="material_type_id" required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª...</option>
          {% for material_type in material_types %}
          <option value="{{ material_type.id }}" data-unit="{{ material_type.unit }}">
            {{ material_type.name }}
          </option>
          {% endfor %}
        </select>
      </div>

        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <span class="text-red-500">*</span>
            </label>
            <input type="number" step="0.01" name="quantity" id="quantity" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">
              –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
            </label>
            <div id="unit-display" 
                 class="mt-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-600">
              –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª
            </div>
          </div>
        </div>

        <!-- –¢–¢–ù –∏ –¥–∞—Ç–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="ttn_number" class="block text-sm font-medium text-gray-700">
              –ù–æ–º–µ—Ä –¢–¢–ù
            </label>
            <input type="text" name="ttn_number" id="ttn_number"
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label for="delivery_date" class="block text-sm font-medium text-gray-700">
              –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ <span class="text-red-500">*</span>
            </label>
            <input type="date" name="delivery_date" id="delivery_date" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
        </div>

        <!-- –ü–æ—Å—Ç–∞–≤—â–∏–∫ -->
        <div>
          <label for="supplier" class="block text-sm font-medium text-gray-700">
            –ü–æ—Å—Ç–∞–≤—â–∏–∫ <span class="text-red-500">*</span>
          </label>
          <input type="text" name="supplier" id="supplier" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>

        <!-- –ü—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
          </label>
          <div id="form-preview"></div>
        </div>
      </div>

      <div class="flex justify-end space-x-4 mt-6">
        <button type="button" id="cancel-btn"
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit"
                class="px-4 py-2 bg-primary-blue text-white rounded-md text-sm font-medium hover:bg-primary-blue/90">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const uploadZone = document.getElementById('upload-zone');
  const fileInput = document.getElementById('file-input');
  const fileSelectBtn = document.getElementById('file-select-btn');
  const uploadStatus = document.getElementById('upload-status');
  const previewContainer = document.getElementById('preview-container');
  const previewContent = document.getElementById('preview-content');
  const editBtn = document.getElementById('edit-btn');
  const editForm = document.getElementById('edit-form');
  const cancelBtn = document.getElementById('cancel-btn');
  
  // Set today as default date
  document.getElementById('delivery_date').valueAsDate = new Date();

  // File selection button
  fileSelectBtn.addEventListener('click', () => fileInput.click());

  // Handle drag and drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  uploadZone.addEventListener('dragenter', () => {
    uploadZone.classList.add('border-primary-blue');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('border-primary-blue');
  });

  uploadZone.addEventListener('drop', (e) => {
    uploadZone.classList.remove('border-primary-blue');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  // Handle file selection
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  // Process selected file
  async function handleFile(file) {
    const projectId = document.getElementById('project_id').value;
    
    if (!projectId) {
      showStatus('error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–∞');
      return;
    }

    try {
      showStatus('loading', '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
      const formData = new FormData();
      formData.append('document', file);
      formData.append('project_id', projectId);

      const uploadResponse = await fetch('/api/materials/ttn/upload/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });

      if (!uploadResponse.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
      }

      const uploadData = await uploadResponse.json();
      console.log('–î–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:', uploadData);

      if (!uploadData.success) {
        throw new Error(uploadData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
      window.transportDocumentId = uploadData.transport_document_id;
      window.documentPhotoId = uploadData.document_photo_id;
      window.deliveryId = uploadData.delivery_id;
      window.ocrResultId = uploadData.ocr_result?.ocr_result_id;

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å OCR
      showStatus('loading', '–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...');
      const statusResponse = await fetch(`/api/materials/ttn/photos/${uploadData.document_photo_id}/status/`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });

      if (!statusResponse.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ OCR');
      }

      const statusData = await statusResponse.json();
      console.log('–°—Ç–∞—Ç—É—Å OCR:', statusData);

      // –ü—Ä—è–º–æ–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –±–µ–∑ –∫–Ω–æ–ø–∫–∏
      const ocrFormData = uploadData.ocr_result?.form_data || {};
      
      if (Object.keys(ocrFormData).length > 0) {
        showStatus('success', '–î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å OCR –¥–∞–Ω–Ω—ã–º–∏
        showPreviewWithAutoFill(file, statusData.ocr_data || {}, ocrFormData);
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
        fillFormDirectly(ocrFormData);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        showEditForm();
      } else {
        showStatus('warning', '–î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã');
        showPreview(file, statusData.ocr_data || {});
        showEditForm();
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞:', error);
      showStatus('error', error.message);
    }
  }

  // Show status message
  function showStatus(type, message) {
    uploadStatus.textContent = message;
    uploadStatus.className = 'mt-4 text-sm ' + 
      (type === 'error' ? 'text-red-600' : 
       type === 'success' ? 'text-green-600' : 
       'text-blue-600');
  }

  // Format OCR data for display
  function formatOCRData(data) {
    if (typeof data === 'string') {
      return data;
    }
    if (Array.isArray(data)) {
      return data.map(item => item.text || item.content || '').join('\n');
    }
    if (data.text) {
      return data.text;
    }
    if (data.lines) {
      return data.lines.map(line => line.text || line.content || '').join('\n');
    }
    return JSON.stringify(data, null, 2);
  }

  // –ü—Ä—è–º–æ–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
  function fillFormDirectly(formData) {
    console.log('üöÄ –ü—Ä—è–º–æ–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π:', formData);

    // –ö–æ–ø–∏—Ä—É–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞
    const projectIdField = document.getElementById('project_id');
    if (projectIdField && projectIdField.value) {
      document.getElementById('form_project_id').value = projectIdField.value;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    if (window.transportDocumentId) {
      document.getElementById('transport_document_id').value = window.transportDocumentId;
    }
    if (window.documentPhotoId) {
      document.getElementById('document_photo_id').value = window.documentPhotoId;
    }
    if (window.deliveryId) {
      document.getElementById('delivery_id').value = window.deliveryId;
    }
    if (window.ocrResultId) {
      document.getElementById('ocr_result_id').value = window.ocrResultId;
    }

    // –ù–æ–º–µ—Ä –¢–¢–ù
    if (formData.ttn_number) {
      const field = document.getElementById('ttn_number');
      field.value = formData.ttn_number;
      highlightAutoFilledField(field, '–ù–æ–º–µ—Ä –¢–¢–ù: ' + formData.ttn_number);
    }

    // –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
    if (formData.delivery_date) {
      const field = document.getElementById('delivery_date');
      field.value = formData.delivery_date;
      highlightAutoFilledField(field, '–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏: ' + formData.delivery_date);
    }

    // –ü–æ—Å—Ç–∞–≤—â–∏–∫
    if (formData.supplier) {
      const field = document.getElementById('supplier');
      field.value = formData.supplier;
      highlightAutoFilledField(field, '–ü–æ—Å—Ç–∞–≤—â–∏–∫: ' + formData.supplier);
    }

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
    if (formData.quantity) {
      const field = document.getElementById('quantity');
      field.value = formData.quantity;
      highlightAutoFilledField(field, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + formData.quantity);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ç–∏–ø–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    if (formData.material_hint) {
      const materialSelect = document.getElementById('material_type_id');
      if (materialSelect) {
        const materialHint = formData.material_hint.toLowerCase();
        const keywords = ['—Ü–µ–º–µ–Ω—Ç', '–ø–µ—Å–æ–∫', '—â–µ–±–µ–Ω—å', '–∫–∏—Ä–ø–∏—á', '–±–µ—Ç–æ–Ω', '–∞—Ä–º–∞—Ç—É—Ä–∞'];
        
        let bestMatch = null;
        let bestScore = 0;
        
        Array.from(materialSelect.options).forEach(option => {
          if (option.value) {
            const optionText = option.text.toLowerCase();
            
            // –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            for (const keyword of keywords) {
              if (materialHint.includes(keyword) && optionText.includes(keyword)) {
                const score = keyword.length + 10; // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
                if (score > bestScore) {
                  bestScore = score;
                  bestMatch = option;
                }
              }
            }
            
            // –û–±—â–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
            if (optionText.includes(materialHint) && materialHint.length > 3) {
              const score = materialHint.length;
              if (score > bestScore) {
                bestScore = score;
                bestMatch = option;
              }
            }
          }
        });
        
        if (bestMatch) {
          materialSelect.value = bestMatch.value;
          materialSelect.dispatchEvent(new Event('change'));
          highlightAutoFilledField(materialSelect, '–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + bestMatch.text);
        }
      }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (formData.ocr_confidence || formData.ocr_service) {
      showAutoFillStats(formData);
    }

    console.log('‚úÖ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
  function showAutoFillStats(formData) {
    const autoFilledCount = Object.keys(formData).filter(key => 
      !['ocr_confidence', 'ocr_service'].includes(key) && formData[key]
    ).length;
    
    const statsHtml = `
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
        <div class="flex items-center mb-3">
          <div class="flex-shrink-0">
            <i class="fas fa-magic text-green-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800">
              –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            </h3>
            <p class="text-sm text-green-700 mt-1">
              –ó–∞–ø–æ–ª–Ω–µ–Ω–æ <span class="font-semibold">${autoFilledCount}</span> –ø–æ–ª–µ–π –∏–∑ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            </p>
          </div>
        </div>
        <div class="bg-white rounded p-3">
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-700">${formData.ocr_service || 'OCR Service'}</span>
            <span class="font-semibold text-green-800">
              <i class="fas fa-check-circle mr-1"></i>
              ${formData.ocr_confidence || 0}% —Ç–æ—á–Ω–æ—Å—Ç—å
            </span>
          </div>
          <p class="text-xs text-gray-600 mt-2">
            <i class="fas fa-edit mr-1"></i>
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          </p>
        </div>
      </div>
    `;
    
    const formPreview = document.getElementById('form-preview');
    if (formPreview) {
      const existingStats = formPreview.querySelector('.bg-green-50');
      if (existingStats) existingStats.remove();
      formPreview.insertAdjacentHTML('beforeend', statsHtml);
    }
  }

  // –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
  function showPreviewWithAutoFill(file, ocrData, formData) {
    let html = '<div class="space-y-4">';
    
    // –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞
    if (file.type.startsWith('image/')) {
      html += `<img src="${URL.createObjectURL(file)}" class="h-32 w-auto rounded border">`;
    } else if (file.type === 'application/pdf') {
      html += `
        <div class="flex items-center space-x-2 text-primary-blue">
          <i class="fas fa-file-pdf text-4xl"></i>
          <span class="text-gray-900">${file.name}</span>
        </div>`;
    }

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏
    html += `
      <div class="bg-blue-50 p-4 rounded-lg">
        <h3 class="font-medium text-blue-900 flex items-center mb-2">
          <i class="fas fa-robot mr-2"></i>
          –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        </h3>
        <div class="text-sm text-blue-800">
          <p><i class="fas fa-check-circle text-green-600 mr-2"></i>–ü–æ–ª—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã</p>
        </div>
      </div>
    `;
    
    html += '</div>';
    
    document.getElementById('preview-content').innerHTML = html;
    document.getElementById('preview-container').classList.remove('hidden');
  }

  // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  function showEditForm() {
    const editForm = document.getElementById('edit-form');
    if (editForm) {
      editForm.classList.remove('hidden');
      
      // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
      setTimeout(() => {
        editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }

  // Show file preview (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ OCR)
  function showPreview(file, ocrData) {
    let html = '<div class="space-y-4">';
    
    // File preview
    if (file.type.startsWith('image/')) {
      html += `<img src="${URL.createObjectURL(file)}" class="h-32 w-auto rounded border">`;
    } else if (file.type === 'application/pdf') {
      html += `
        <div class="flex items-center space-x-2 text-primary-blue">
          <i class="fas fa-file-pdf text-4xl"></i>
          <span class="text-gray-900">${file.name}</span>
        </div>`;
    }

    // OCR results
    html += `
      <div class="bg-gray-50 p-4 rounded-lg space-y-2">
        <h3 class="font-medium text-gray-900">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h3>
        <pre class="text-sm text-gray-700 whitespace-pre-wrap bg-white p-3 rounded border">${formatOCRData(ocrData)}</pre>
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <details class="cursor-pointer">
          <summary class="font-medium mb-2">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</summary>
          <div class="pl-4 space-y-2">
            <div class="space-y-1">
              <p class="font-medium">ID –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:</p>
              <div class="bg-gray-100 p-2 rounded">
                <div>Transport Document ID: ${window.transportDocumentId || '-'}</div>
                <div>Document Photo ID: ${window.documentPhotoId || '-'}</div>
                <div>Delivery ID: ${window.deliveryId || '-'}</div>
                <div>OCR Result ID: ${window.ocrResultId || '-'}</div>
              </div>
            </div>
            
            <div class="space-y-1">
              <p class="font-medium">Raw OCR –¥–∞–Ω–Ω—ã–µ:</p>
              <pre class="bg-gray-100 p-2 rounded overflow-auto max-h-40">${JSON.stringify(ocrData, null, 2)}</pre>
            </div>
          </div>
        </details>
      </div>`;

    html += '</div>';
    
    previewContent.innerHTML = html;
    previewContainer.classList.remove('hidden');
  }

  // Extract data from OCR text
  function findTTNNumber(text) {
    const patterns = [
      /(?:—Ç—Ç–Ω|–Ω–∞–∫–ª–∞–¥–Ω–∞—è|—Ç–Ω)[^\d]*(\d[\d-\/\\]*\d)/i,
      /‚Ññ\s*([A-Za-z–ê-–Ø–∞-—è0-9-\/\\]+)/i,
      /–Ω–æ–º–µ—Ä:?\s*([A-Za-z–ê-–Ø–∞-—è0-9-\/\\]+)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findDate(text) {
    const patterns = [
      /(\d{1,2}[.-]\d{1,2}[.-]\d{2,4})/,
      /(\d{4}[.-]\d{1,2}[.-]\d{1,2})/,
      /–æ—Ç:?\s*(\d{1,2}[.-]\d{1,2}[.-]\d{2,4})/i
    ];
    return findByPatterns(text, patterns);
  }

  function findSupplier(text) {
    const patterns = [
      /–ø–æ—Å—Ç–∞–≤—â–∏–∫:?\s*([^"\n\r]*)/i,
      /–æ—Ç\s*–∫–æ–≥–æ:?\s*([^"\n\r]*)/i,
      /–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:?\s*([^"\n\r]*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findMaterial(text) {
    const patterns = [
      /–º–∞—Ç–µ—Ä–∏–∞–ª:?\s*([^"\n\r]*)/i,
      /–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:?\s*([^"\n\r]*)/i,
      /—Ç–æ–≤–∞—Ä:?\s*([^"\n\r]*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findQuantity(text) {
    const patterns = [
      /–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:?\s*(\d+[.,]?\d*)/i,
      /–æ–±—ä–µ–º:?\s*(\d+[.,]?\d*)/i,
      /–º–∞—Å—Å–∞:?\s*(\d+[.,]?\d*)/i
    ];
    return findByPatterns(text, patterns);
  }

  function findUnit(text) {
    const patterns = [
      /(?:—à—Ç|–∫–≥|—Ç–Ω|–º3|–∫—É–±\.–º|–ª|–º–ª|–≥|—Å–º|–º|–∫–º)/i
    ];
    const match = text.match(patterns[0]);
    return match ? match[0] : null;
  }

  function findByPatterns(text, patterns) {
    for (const pattern of patterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }
    return null;
  }

  // Show edit form with enhanced OCR data
  async function showEditFormWithOCRData(file, ocrData, formData) {
    console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–ª—É—á—à–µ–Ω–Ω—ã—Ö OCR –¥–∞–Ω–Ω—ã—Ö:', formData);

    // Copy project ID
    document.getElementById('form_project_id').value = document.getElementById('project_id').value;

    // Fill hidden fields
    document.getElementById('transport_document_id').value = window.transportDocumentId || '';
    document.getElementById('document_photo_id').value = window.documentPhotoId || '';
    document.getElementById('delivery_id').value = window.deliveryId || '';
    document.getElementById('ocr_result_id').value = window.ocrResultId || '';

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö OCR
    if (formData.ttn_number) {
      const ttnField = document.getElementById('ttn_number');
      ttnField.value = formData.ttn_number;
      highlightAutoFilledField(ttnField, '–ù–æ–º–µ—Ä –¢–¢–ù');
    }

    if (formData.delivery_date) {
      const dateField = document.getElementById('delivery_date');
      dateField.value = formData.delivery_date;
      highlightAutoFilledField(dateField, '–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏');
    }

    if (formData.supplier) {
      const supplierField = document.getElementById('supplier');
      supplierField.value = formData.supplier;
      highlightAutoFilledField(supplierField, '–ü–æ—Å—Ç–∞–≤—â–∏–∫');
    }

    if (formData.quantity) {
      const quantityField = document.getElementById('quantity');
      quantityField.value = formData.quantity;
      highlightAutoFilledField(quantityField, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ');
    }

    // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    if (formData.material_hint) {
      const materialSelect = document.getElementById('material_type_id');
      const materialHint = formData.material_hint.toLowerCase();
      
      let bestMatch = null;
      let bestScore = 0;
      
      Array.from(materialSelect.options).forEach(option => {
        if (option.value) {
          const optionText = option.text.toLowerCase();
          
          // –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
          const keywords = ['—Ü–µ–º–µ–Ω—Ç', '–ø–µ—Å–æ–∫', '—â–µ–±–µ–Ω—å', '–∫–∏—Ä–ø–∏—á', '–±–µ—Ç–æ–Ω'];
          
          for (const keyword of keywords) {
            if (materialHint.includes(keyword) && optionText.includes(keyword)) {
              const score = keyword.length;
              if (score > bestScore) {
                bestScore = score;
                bestMatch = option;
              }
            }
          }
          
          // –û–±—â–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
          if (optionText.includes(materialHint) || materialHint.includes(optionText)) {
            const score = Math.min(optionText.length, materialHint.length);
            if (score > bestScore) {
              bestScore = score;
              bestMatch = option;
            }
          }
        }
      });
      
      if (bestMatch) {
        materialSelect.value = bestMatch.value;
        materialSelect.dispatchEvent(new Event('change'));
        highlightAutoFilledField(materialSelect, '–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
      }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É OCR
    if (formData.ocr_confidence || formData.ocr_service) {
      showOCRStats(formData);
    }

    // Show form
    editForm.classList.remove('hidden');
  }
  
  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
  function highlightAutoFilledField(field, fieldName) {
    field.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
    field.title = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ: ${fieldName}`;
    
    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      field.classList.remove('ring-2', 'ring-green-500', 'bg-green-50');
      field.title = '';
    }, 3000);
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É OCR
  function showOCRStats(formData) {
    const statsHtml = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
        <h4 class="text-sm font-medium text-blue-800 mb-2">
          <i class="fas fa-robot mr-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        </h4>
        <div class="flex justify-between items-center text-sm">
          <span class="text-blue-700">${formData.ocr_service || 'OCR Service'}</span>
          <span class="font-semibold text-blue-800">${formData.ocr_confidence || 0}% —Ç–æ—á–Ω–æ—Å—Ç—å</span>
        </div>
        <p class="text-xs text-blue-600 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          –ü–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
        </p>
      </div>
    `;
    
    // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const formPreview = document.getElementById('form-preview');
    if (formPreview) {
      const existingStats = formPreview.querySelector('.bg-blue-50');
      if (existingStats) {
        existingStats.remove();
      }
      formPreview.insertAdjacentHTML('beforeend', statsHtml);
    }
  }
  
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  async function showEditForm(file, ocrData) {
    return showEditFormWithOCRData(file, ocrData, {});
  }

  // Handle edit button click
  editBtn.addEventListener('click', () => {
    previewContainer.classList.add('hidden');
    editForm.classList.remove('hidden');
  });

  // Handle cancel button click
  cancelBtn.addEventListener('click', () => {
    editForm.classList.add('hidden');
    previewContainer.classList.remove('hidden');
  });

  // Update unit display when material type changes
  document.getElementById('material_type_id').addEventListener('change', function() {
    const unit = this.options[this.selectedIndex].dataset.unit || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('unit-display').textContent = unit;
  });

  // Form validation
  editForm.addEventListener('submit', function(e) {
    const required = ['form_project_id', 'material_type_id', 'quantity', 'supplier', 'delivery_date'];
    const empty = required.filter(id => !document.getElementById(id).value);
    
    if (empty.length > 0) {
      e.preventDefault();
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    const quantity = parseFloat(document.getElementById('quantity').value);
    if (isNaN(quantity) || quantity <= 0) {
      e.preventDefault();
      alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
      return;
    }
  });
});
</script>
{% endblock %}
