{% extends 'base.html' %}

{% block title %}{{ violation.title }} - –î–µ—Ç–∞–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è{% endblock %}

{% block extra_head %}
<!-- –†–æ—Å—Å–∏–π—Å–∫–∞—è –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
<script src="{% url 'static' 'js/russian-map.js' %}" defer></script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
#violationMap {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è popup */
.ol-popup {
    position: absolute;
    background-color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    border: 1px solid #ccc;
    bottom: 12px;
    left: -50px;
    min-width: 280px;
}

.ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}

.ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
}

.ol-popup:before {
    border-top-color: #cccccc;
    border-width: 11px;
    left: 48px;
    margin-left: -11px;
}

.ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 2px;
    right: 8px;
    color: #666;
}

.ol-popup-closer:after {
    content: "‚úñ";
}

/* –£–±–∏—Ä–∞–µ–º –∞—Ç—Ä–∏–±—É—Ü–∏—é OpenLayers */
.ol-attribution {
    display: none !important;
}

/* –£–ª—É—á—à–∞–µ–º —Å—Ç–∏–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ */
.ol-zoom {
    top: 10px;
    left: 10px;
}

.ol-zoom button {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    color: #333;
    font-size: 16px;
    font-weight: bold;
    height: 30px;
    width: 30px;
    margin: 1px;
    text-decoration: none;
    text-align: center;
    line-height: 28px;
}

.ol-zoom button:hover {
    background-color: rgba(255, 255, 255, 1);
    color: #000;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="bg-white shadow-sm rounded-lg p-6 mb-8">
    <div class="flex items-start justify-between">
      <div class="flex-1">
        <div class="flex items-center space-x-3 mb-2">
          <h1 class="text-3xl font-bold text-gray-900">{{ violation.title }}</h1>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            {% if violation.status == 'detected' %}bg-orange-100 text-orange-800
            {% elif violation.status == 'notified' %}bg-yellow-100 text-yellow-800
            {% elif violation.status == 'in_correction' %}bg-blue-100 text-blue-800
            {% elif violation.status == 'corrected' %}bg-purple-100 text-purple-800
            {% elif violation.status == 'verified' %}bg-green-100 text-green-800
            {% elif violation.status == 'closed' %}bg-gray-100 text-gray-800
            {% else %}bg-gray-100 text-gray-800
            {% endif %}">
            <i class="fas fa-circle text-xs mr-2"></i>
            {{ violation.get_status_display }}
          </span>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            {% if violation.priority == 'critical' %}bg-red-100 text-red-800
            {% elif violation.priority == 'high' %}bg-orange-100 text-orange-800
            {% elif violation.priority == 'medium' %}bg-yellow-100 text-yellow-800
            {% else %}bg-green-100 text-green-800
            {% endif %}">
            <i class="fas fa-flag text-xs mr-2"></i>
            {{ violation.get_priority_display }} –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
          </span>
        </div>
        
        <div class="flex items-center space-x-6 text-sm text-gray-600">
          <div class="flex items-center">
            <i class="fas fa-building text-blue-500 mr-2"></i>
            <span class="font-medium">{{ violation.project.name }}</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-calendar text-green-500 mr-2"></i>
            <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {{ violation.detected_at|date:"d.m.Y –≤ H:i" }}</span>
          </div>
          {% if violation.is_overdue %}
          <div class="flex items-center text-red-600">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span class="font-medium">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
          </div>
          {% else %}
          <div class="flex items-center text-blue-600">
            <i class="fas fa-clock mr-2"></i>
            <span>–û—Å—Ç–∞–ª–æ—Å—å: {{ violation.days_remaining }} –¥–Ω–µ–π</span>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="flex space-x-2 ml-6">
        <a href="{% url 'inspector:violations_list' %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors">
          <i class="fas fa-arrow-left mr-2"></i>
          –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="xl:col-span-2 space-y-8">
      <!-- –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-file-alt text-blue-500 text-lg mr-3"></i>
          <h2 class="text-xl font-semibold text-gray-900">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è</h2>
        </div>
        <div class="prose max-w-none">
          <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">{{ violation.description }}</p>
        </div>
      </div>

      <!-- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏—è -->
      {% if violation.violation_classifier %}
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-tags text-purple-500 text-lg mr-3"></i>
          <h2 class="text-xl font-semibold text-gray-900">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏—è</h2>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span class="text-sm font-medium text-purple-600">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
              <p class="text-gray-900 font-medium">{{ violation.violation_classifier.get_category_display }}</p>
            </div>
            <div>
              <span class="text-sm font-medium text-purple-600">–¢–∏–ø:</span>
              <p class="text-gray-900 font-medium">{{ violation.violation_classifier.get_violation_type_display }}</p>
            </div>
            <div class="md:col-span-2">
              <span class="text-sm font-medium text-purple-600">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
              <p class="text-gray-900">{{ violation.violation_classifier.name }}</p>
            </div>
            {% if violation.violation_classifier.regulatory_deadline_days %}
            <div>
              <span class="text-sm font-medium text-purple-600">–ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è:</span>
              <p class="text-gray-900 font-medium">{{ violation.violation_classifier.regulatory_deadline_days }} –¥–Ω–µ–π</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-comments text-purple-500 text-lg mr-3"></i>
          <h2 class="text-xl font-semibold text-gray-900">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
        </div>
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        {% if comments.count > 0 %}
        <div class="space-y-4 mb-6">
          <div class="flex items-center mb-4">
            <i class="fas fa-history text-indigo-500 mr-2"></i>
            <h4 class="text-md font-medium text-gray-800">–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ({{ comments.count }})</h4>
          </div>
          
          {% for comment in comments %}
          <div class="relative bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
            <!-- –õ–∏–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ -->
            {% if not forloop.last %}
            <div class="absolute left-6 top-12 w-0.5 h-8 bg-gray-200"></div>
            {% endif %}
            
            <div class="flex items-start space-x-3">
              <!-- –ê–≤–∞—Ç–∞—Ä -->
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-semibold shadow-md">
                {{ comment.author.get_full_name.0|default:comment.author.username.0|upper }}
              </div>
              
              <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                  <div class="flex items-center space-x-2">
                    <span class="text-sm font-semibold text-gray-900">
                      {{ comment.author.get_full_name|default:comment.author.username }}
                    </span>
                    {% if comment.get_author_role_display %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 border border-blue-200">
                      <i class="fas fa-user-tag mr-1"></i>
                      {{ comment.get_author_role_display }}
                    </span>
                    {% endif %}
                  </div>
                  <div class="flex items-center text-xs text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    <time datetime="{{ comment.created_at|date:'c' }}" title="{{ comment.created_at|date:'–¥ F Y –≥. –≤ H:i' }}">
                      {{ comment.created_at|timesince }} –Ω–∞–∑–∞–¥
                    </time>
                  </div>
                </div>
                
                <!-- –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <div class="bg-gray-50 border border-gray-100 rounded-lg p-3 mt-2">
                  <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{{ comment.comment }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comment-slash text-4xl mb-3 text-gray-300"></i>
          <p class="text-sm font-medium">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
          <p class="text-xs text-gray-400 mt-1">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!</p>
        </div>
        {% endif %}
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è - –ü–†–û–°–¢–ê–Ø –í–ï–†–°–ò–Ø -->
        <div class="border-t border-gray-200 pt-6">
          <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              <i class="fas fa-comment-dots text-blue-500 mr-2"></i>
              –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            </h3>
            
            <form method="post" id="comment-form" class="space-y-4">
              {% csrf_token %}
              
              <div>
                <label for="id_comment" class="block text-sm font-medium text-gray-700 mb-2">
                  –í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                </label>
                <textarea 
                  name="comment" 
                  id="id_comment" 
                  rows="4" 
                  maxlength="1000"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                  required></textarea>
                
                {% if comment_form.comment.errors %}
                  <div class="mt-1 text-sm text-red-600">
                    {% for error in comment_form.comment.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="flex justify-end space-x-3">
                <button type="button" onclick="clearCommentForm()" 
                        class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  –û—á–∏—Å—Ç–∏—Ç—å
                </button>
                <button type="submit" 
                        name="add_comment"
                        id="submit-comment-btn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                  <i class="fas fa-paper-plane mr-2"></i>
                  –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã -->
        {% if violation.correction_comment %}
        <div class="mt-6 border-t border-gray-200 pt-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</h3>
          <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center mb-2">
              <i class="fas fa-tools text-blue-500 mr-2"></i>
              <span class="text-sm font-medium text-blue-800">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏</span>
            </div>
            <p class="text-sm text-blue-900">{{ violation.correction_comment }}</p>
          </div>
        </div>
        {% endif %}
        
        {% if violation.inspector_comment %}
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center mb-2">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span class="text-sm font-medium text-green-800">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞</span>
          </div>
          <p class="text-sm text-green-900">{{ violation.inspector_comment }}</p>
        </div>
        {% endif %}
      </div>

      <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
      {% if all_photos %}
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-6">
          <i class="fas fa-camera text-green-500 text-lg mr-3"></i>
          <h2 class="text-xl font-semibold text-gray-900">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ({{ all_photos.count }})</h2>
        </div>
        
        <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è -->
        {% if photos_by_type.violation %}
        <div class="mb-8">
          <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
            –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è ({{ photos_by_type.violation.count }})
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for photo in photos_by_type.violation %}
            <div class="relative group">
              <div class="aspect-w-4 aspect-h-3">
                <img src="{{ photo.photo.url }}" 
                     alt="–§–æ—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è" 
                     class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity shadow-md"
                     onclick="openPhotoModal('{{ photo.photo.url }}', '{{ photo.description|default:'' }}', '–§–æ—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è', '{{ photo.taken_by.get_full_name|default:photo.taken_by.username }}', '{{ photo.taken_at|date:"d.m.Y H:i" }}')">
              </div>
              {% if photo.description %}
              <div class="absolute bottom-2 left-2 right-2 bg-black bg-opacity-75 text-white text-xs p-2 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                {{ photo.description|truncatechars:50 }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è -->
        {% if photos_by_type.correction %}
        <div class="mb-8">
          <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
            <i class="fas fa-tools text-blue-500 mr-2"></i>
            –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è ({{ photos_by_type.correction.count }})
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for photo in photos_by_type.correction %}
            <div class="relative group">
              <div class="aspect-w-4 aspect-h-3">
                <img src="{{ photo.photo.url }}" 
                     alt="–§–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è" 
                     class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity shadow-md"
                     onclick="openPhotoModal('{{ photo.photo.url }}', '{{ photo.description|default:'' }}', '–§–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è', '{{ photo.taken_by.get_full_name|default:photo.taken_by.username }}', '{{ photo.taken_at|date:"d.m.Y H:i" }}')">
              </div>
              {% if photo.description %}
              <div class="absolute bottom-2 left-2 right-2 bg-black bg-opacity-75 text-white text-xs p-2 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                {{ photo.description|truncatechars:50 }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        {% if photos_by_type.verification %}
        <div class="mb-4">
          <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ ({{ photos_by_type.verification.count }})
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for photo in photos_by_type.verification %}
            <div class="relative group">
              <div class="aspect-w-4 aspect-h-3">
                <img src="{{ photo.photo.url }}" 
                     alt="–§–æ—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏" 
                     class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity shadow-md"
                     onclick="openPhotoModal('{{ photo.photo.url }}', '{{ photo.description|default:'' }}', '–§–æ—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏', '{{ photo.taken_by.get_full_name|default:photo.taken_by.username }}', '{{ photo.taken_at|date:"d.m.Y H:i" }}')">
              </div>
              {% if photo.description %}
              <div class="absolute bottom-2 left-2 right-2 bg-black bg-opacity-75 text-white text-xs p-2 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                {{ photo.description|truncatechars:50 }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-info-circle text-blue-500 text-lg mr-3"></i>
          <h2 class="text-lg font-semibold text-gray-900">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        </div>
        <dl class="space-y-4">
          <div class="border-b border-gray-100 pb-3">
            <dt class="text-sm font-medium text-gray-500 mb-1">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</dt>
            <dd class="text-sm text-gray-900 flex items-center">
              <i class="fas fa-user text-blue-400 mr-2"></i>
              {{ violation.inspector.get_full_name|default:violation.inspector.username }}
            </dd>
          </div>
          
          {% if violation.violation_type %}
          <div class="border-b border-gray-100 pb-3">
            <dt class="text-sm font-medium text-gray-500 mb-1">–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è</dt>
            <dd class="text-sm text-gray-900">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                {% if violation.violation_type.severity == 'critical' %}bg-red-100 text-red-800
                {% elif violation.violation_type.severity == 'high' %}bg-orange-100 text-orange-800
                {% elif violation.violation_type.severity == 'medium' %}bg-yellow-100 text-yellow-800
                {% else %}bg-green-100 text-green-800
                {% endif %}">
                {{ violation.violation_type.name }}
              </span>
            </dd>
          </div>
          {% endif %}
          
          <div class="border-b border-gray-100 pb-3">
            <dt class="text-sm font-medium text-gray-500 mb-1">–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è</dt>
            <dd class="text-sm text-gray-900 flex items-center">
              <i class="fas fa-calendar text-green-400 mr-2"></i>
              {{ violation.detected_at|date:"d.m.Y –≤ H:i" }}
            </dd>
          </div>
          
          <div class="border-b border-gray-100 pb-3">
            <dt class="text-sm font-medium text-gray-500 mb-1">–°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è</dt>
            <dd class="text-sm flex items-center
              {% if violation.is_overdue %}text-red-600
              {% elif violation.days_remaining <= 3 %}text-orange-600
              {% else %}text-gray-900
              {% endif %}">
              <i class="fas fa-clock mr-2"></i>
              {{ violation.deadline|date:"d.m.Y" }}
              {% if violation.is_overdue %}
                <span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
              {% else %}
                <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{{ violation.days_remaining }} –¥–Ω.</span>
              {% endif %}
            </dd>
          </div>
          
          {% if violation.assigned_to %}
          <div class="border-b border-gray-100 pb-3">
            <dt class="text-sm font-medium text-gray-500 mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ</dt>
            <dd class="text-sm text-gray-900 flex items-center">
              <i class="fas fa-hard-hat text-orange-400 mr-2"></i>
              {{ violation.assigned_to.get_full_name|default:violation.assigned_to.username }}
            </dd>
          </div>
          {% endif %}
        </dl>
      </div>
      
      <!-- –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-map-marker-alt text-red-500 text-lg mr-3"></i>
          <h2 class="text-lg font-semibold text-gray-900">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è</h2>
        </div>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
        {% if violation.location_description %}
        <div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
          <div class="flex items-center mb-2">
            <i class="fas fa-map-pin text-orange-500 mr-2"></i>
            <span class="text-sm font-medium text-orange-800">–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞</span>
          </div>
          <p class="text-sm text-orange-900">{{ violation.location_description }}</p>
        </div>
        {% endif %}
        
        <!-- –ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞</span>
            <div class="flex space-x-2">
              <select id="map-provider" class="text-sm border border-gray-300 rounded px-3 py-1 bg-white">
                <option value="osm" selected>üó∫Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="satellite">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option>
              </select>
            </div>
          </div>
          <div id="map-loading" class="flex items-center justify-center h-[500px] bg-gray-50 rounded-lg">
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-blue mb-2"></div>
              <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
            </div>
          </div>
          <div id="map" class="h-[500px] rounded-lg" style="display: none;"></div>
        </div>
        
        <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è -->
          {% if violation.location_lat and violation.location_lng %}
          <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center mb-2">
              <i class="fas fa-crosshairs text-red-500 mr-2"></i>
              <span class="text-sm font-medium text-red-800">–ú–µ—Å—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è</span>
            </div>
            <div class="text-xs text-red-700 space-y-1">
              <div>–®–∏—Ä–æ—Ç–∞: {{ violation.location_lat|floatformat:6 }}</div>
              <div>–î–æ–ª–≥–æ—Ç–∞: {{ violation.location_lng|floatformat:6 }}</div>
            </div>
          </div>
          {% endif %}
          
          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
          <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center mb-2">
              <i class="fas fa-building text-blue-500 mr-2"></i>
              <span class="text-sm font-medium text-blue-800">–ü—Ä–æ–µ–∫—Ç</span>
            </div>
            <div class="text-xs text-blue-700 space-y-1">
              <div class="font-medium">{{ violation.project.name }}</div>
              {% if violation.project.address %}
              <div>–ê–¥—Ä–µ—Å: {{ violation.project.address }}</div>
              {% endif %}
              {% if violation.project.foreman %}
              <div>–ü—Ä–æ—Ä–∞–±: {{ violation.project.foreman.get_full_name|default:violation.project.foreman.username }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-history text-indigo-500 text-lg mr-3"></i>
          <h2 class="text-lg font-semibold text-gray-900">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è</h2>
        </div>
        
        <div class="space-y-3">
          <div class="flex items-start">
            <div class="flex-shrink-0 w-2 h-2 mt-2 bg-orange-400 rounded-full"></div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ</div>
              <div class="text-xs text-gray-500">{{ violation.detected_at|date:"d.m.Y H:i" }}</div>
            </div>
          </div>
          
          {% if violation.corrected_at %}
          <div class="flex items-start">
            <div class="flex-shrink-0 w-2 h-2 mt-2 bg-blue-400 rounded-full"></div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ</div>
              <div class="text-xs text-gray-500">{{ violation.corrected_at|date:"d.m.Y H:i" }}</div>
            </div>
          </div>
          {% endif %}
          
          {% if violation.verified_at %}
          <div class="flex items-start">
            <div class="flex-shrink-0 w-2 h-2 mt-2 bg-green-400 rounded-full"></div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
              <div class="text-xs text-gray-500">{{ violation.verified_at|date:"d.m.Y H:i" }}</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ—Ä–∞–±–æ–≤ -->
      {% if can_mark_corrected %}
      <div class="bg-white shadow-sm rounded-lg p-6 border-l-4 border-l-blue-500">
        <div class="flex items-center mb-4">
          <i class="fas fa-tools text-blue-500 text-lg mr-3"></i>
          <h2 class="text-lg font-semibold text-gray-900">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ–µ</h2>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-blue-800 text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            –ü–æ—Å–ª–µ –æ—Ç–º–µ—Ç–∫–∏ –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—É –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.
          </p>
        </div>
        
        <form method="post">
          {% csrf_token %}
          <div class="space-y-4">
            <div>
              <label for="correction_comment" class="block text-sm font-medium text-gray-700 mb-2">
                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              </label>
              <textarea name="correction_comment" id="correction_comment" 
                        rows="3" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="–û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –±—ã–ª–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ..."></textarea>
            </div>
            
            <button type="submit" 
                    name="mark_corrected"
                    class="w-full inline-flex justify-center items-center px-6 py-3 bg-blue-600 text-white text-base font-medium rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-check-circle mr-2"></i>
              –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ–µ
            </button>
          </div>
        </form>
      </div>
      {% endif %}
      
      <!-- –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ -->
      {% if violation.status == 'corrected' and can_verify %}
      <div class="bg-white shadow-sm rounded-lg p-6 border-l-4 border-l-green-500">
        <div class="flex items-center mb-4">
          <i class="fas fa-check-double text-green-500 text-lg mr-3"></i>
          <h2 class="text-lg font-semibold text-gray-900">–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è</h2>
        </div>
        
        <form method="post">
          {% csrf_token %}
          <div class="space-y-4">
            <div>
              <label for="inspector_comment" class="block text-sm font-medium text-gray-700 mb-2">
                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞
              </label>
              <textarea name="inspector_comment" id="inspector_comment" 
                        rows="3" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">{{ violation.inspector_comment }}</textarea>
            </div>
            
            <div class="flex space-x-3">
              <button type="submit" 
                      name="verify_correction" 
                      value="approve"
                      onclick="document.querySelector('input[name=verification_action]').value='approve'"
                      class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-check mr-2"></i>
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
              </button>
              
              <button type="submit" 
                      name="verify_correction" 
                      value="reject"
                      onclick="document.querySelector('input[name=verification_action]').value='reject'"
                      class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-times mr-2"></i>
                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
              </button>
            </div>
            
            <input type="hidden" name="verification_action" value="">
          </div>
        </form>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
  <div class="relative max-w-6xl max-h-full bg-white rounded-lg overflow-hidden shadow-2xl">
    <!-- Modal Header -->
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i id="modalIcon" class="fas fa-camera text-blue-500 text-lg"></i>
          <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h3>
        </div>
        <button onclick="closePhotoModal()" 
                class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="flex">
      <!-- Image -->
      <div class="flex-1 flex items-center justify-center bg-gray-100 p-6">
        <img id="modalImage" src="" alt="" 
             class="max-w-full max-h-96 object-contain rounded-lg shadow-lg">
      </div>
      
      <!-- Info Panel -->
      <div class="w-80 bg-white p-6 border-l border-gray-200">
        <div class="space-y-4">
          <div id="modalDescription" class="hidden">
            <h4 class="text-sm font-medium text-gray-900 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
            <p id="modalDescriptionText" class="text-sm text-gray-600"></p>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-900 mb-2">–î–µ—Ç–∞–ª–∏</h4>
            <dl class="space-y-2">
              <div>
                <dt class="text-xs font-medium text-gray-500">–ê–≤—Ç–æ—Ä</dt>
                <dd id="modalAuthor" class="text-sm text-gray-900"></dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-gray-500">–î–∞—Ç–∞ —Å—ä—ë–º–∫–∏</dt>
                <dd id="modalDate" class="text-sm text-gray-900"></dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// üåç –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í –ù–ê–ß–ê–õ–ï!
function openPhotoModal(imageUrl, description, type, author, date) {
    console.log('üì∏ GLOBAL: Opening photo modal:', { imageUrl, description, type, author, date });
    
    try {
        // Set image
        const modalImage = document.getElementById('modalImage');
        if (modalImage) {
            modalImage.src = imageUrl;
        } else {
            console.error('‚ö†Ô∏è Modal image element not found');
            return;
        }
        
        // Set title and icon based on type
        const titleEl = document.getElementById('modalTitle');
        const iconEl = document.getElementById('modalIcon');
        
        if (titleEl) titleEl.textContent = type || '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
        
        if (iconEl) {
            if (type && type.includes('–Ω–∞—Ä—É—à–µ–Ω–∏—è')) {
                iconEl.className = 'fas fa-exclamation-triangle text-red-500 text-lg';
            } else if (type && type.includes('—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è')) {
                iconEl.className = 'fas fa-tools text-blue-500 text-lg';
            } else if (type && type.includes('–ø—Ä–æ–≤–µ—Ä–∫–∏')) {
                iconEl.className = 'fas fa-check-circle text-green-500 text-lg';
            } else {
                iconEl.className = 'fas fa-camera text-blue-500 text-lg';
            }
        }
        
        // Set description
        const descEl = document.getElementById('modalDescription');
        const descTextEl = document.getElementById('modalDescriptionText');
        if (descEl && descTextEl) {
            if (description && description.trim()) {
                descTextEl.textContent = description;
                descEl.classList.remove('hidden');
            } else {
                descEl.classList.add('hidden');
            }
        }
        
        // Set metadata
        const authorEl = document.getElementById('modalAuthor');
        const dateEl = document.getElementById('modalDate');
        if (authorEl) authorEl.textContent = author || '–ù–µ —É–∫–∞–∑–∞–Ω';
        if (dateEl) dateEl.textContent = date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        // Show modal
        const photoModal = document.getElementById('photoModal');
        if (photoModal) {
            photoModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Photo modal opened successfully');
        } else {
            console.error('‚ö†Ô∏è Photo modal element not found');
        }
        
    } catch (error) {
        console.error('‚ùå Error opening photo modal:', error);
    }
}

function closePhotoModal() {
    console.log('‚ùå GLOBAL: Closing photo modal');
    const photoModal = document.getElementById('photoModal');
    if (photoModal) {
        photoModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

// –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ window –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
window.openPhotoModal = openPhotoModal;
window.closePhotoModal = closePhotoModal;

console.log('üéÜ Photo modal functions declared globally!');
console.log('Functions check:', {
    openPhotoModal: typeof openPhotoModal,
    closePhotoModal: typeof closePhotoModal,
    windowOpenPhotoModal: typeof window.openPhotoModal,
    windowClosePhotoModal: typeof window.closePhotoModal
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ DOMContentLoaded

// üá∫üá∑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –Ω–∞—Ä—É—à–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è...');
    
    let map = null;
    
    try {
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ)
        console.log('üîç DEBUG: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞...');
        console.log('üîç DEBUG: project_coordinates_json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', {{ project_coordinates_json|yesno:"true,false,unknown" }});
        {% if project_coordinates_json %}
        console.log('üîç DEBUG: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ JSON');
        {% endif %}
        
        // –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
        let projectData = {
            id: {{ violation.project.id|default:0 }},
            name: '{{ violation.project.name|escapejs }}',
            address: '{{ violation.project.address|default:"–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω"|escapejs }}',
            status: '{{ violation.project.status|default:"active" }}',
            completion: {{ violation.project.completion_percentage|default:0 }},
            {% if project_coordinates_json %}
            hasCoordinates: true,
            coordinates: null  // –ë—É–¥–µ–º –ø–∞—Ä—Å–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
            {% else %}
            hasCoordinates: false,
            coordinates: null
            {% endif %}
        };
        
        console.log('üìä –ü–µ—Ä–≤–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞:', projectData);
        
        // –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ
        {% if project_coordinates_json %}
        try {
            console.log('üîç –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞...');
            const coordsData = {{ project_coordinates_json|safe }};
            console.log('üó∫Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã:', coordsData.type, coordsData.coordinates[0].length, '—Ç–æ—á–µ–∫');
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
            const coords = coordsData.coordinates[0];
            const firstCoord = coords[0];
            const lastCoord = coords[coords.length - 1];
            console.log(`üìç –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞: [${firstCoord[0]}, ${firstCoord[1]}]`);
            console.log(`üìç –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞: [${lastCoord[0]}, ${lastCoord[1]}]`);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const debugMinLng = Math.min(...coords.map(c => c[0]));
            const debugMaxLng = Math.max(...coords.map(c => c[0]));
            const debugMinLat = Math.min(...coords.map(c => c[1]));
            const debugMaxLat = Math.max(...coords.map(c => c[1]));
            console.log(`üó∫Ô∏è –ì—Ä–∞–Ω–∏—Ü—ã: lng ${debugMinLng.toFixed(6)} - ${debugMaxLng.toFixed(6)}, lat ${debugMinLat.toFixed(6)} - ${debugMaxLat.toFixed(6)}`);
            
            const debugCenterLng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
            const debugCenterLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
            const debugBoundsCenter = [(debugMinLng + debugMaxLng) / 2, (debugMinLat + debugMaxLat) / 2];
            console.log(`üéØ –¶–µ–Ω—Ç—Ä (–∞—Ä–∏—Ñ–º.): [${debugCenterLng.toFixed(6)}, ${debugCenterLat.toFixed(6)}]`);
            console.log(`üéØ –¶–µ–Ω—Ç—Ä (–≥—Ä–∞–Ω–∏—Ü—ã): [${debugBoundsCenter[0].toFixed(6)}, ${debugBoundsCenter[1].toFixed(6)}]`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞
            projectData.coordinates = coordsData.coordinates[0];
            
        } catch (coordsError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞:', coordsError);
            projectData.hasCoordinates = false;
            projectData.coordinates = null;
        }
        {% else %}
        console.warn('‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã');
        {% endif %}
        
        // –î–∞–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞)
        const violationData = {
            id: {{ violation.id|default:0 }},
            title: '{{ violation.title|escapejs }}',
            status: '{{ violation.status|default:"detected" }}',
            priority: '{{ violation.priority|default:"medium" }}',
            detected_at: '{{ violation.detected_at|date:"d.m.Y H:i" }}',
            deadline: '{{ violation.deadline|date:"d.m.Y" }}',
            {% if violation.location_lat and violation.location_lng %}
            hasLocation: true,
            lat: parseFloat('{{ violation.location_lat|floatformat:6 }}') || 0,
            lng: parseFloat('{{ violation.location_lng|floatformat:6 }}') || 0,
            {% else %}
            hasLocation: false,
            lat: 0,
            lng: 0,
            {% endif %}
            locationDescription: '{{ violation.location_description|default:""|escapejs }}'
        };
        
        console.log('üìä –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞:', projectData);
        console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è:', violationData);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã
        window.onMapReady = function(mapInstance) {
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞!');
            console.log('üîç –û–±—ä–µ–∫—Ç –∫–∞—Ä—Ç—ã:', mapInstance);
            console.log('üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã:', Object.getOwnPropertyNames(Object.getPrototypeOf(mapInstance)));
            map = mapInstance;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º loader
            const mapElement = document.getElementById('map');
            const loaderElement = document.getElementById('map-loading');
            if (mapElement && loaderElement) {
                loaderElement.style.display = 'none';
                mapElement.style.display = 'block';
                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞');
            }
            
            let mapCentered = false;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (projectData.hasCoordinates && projectData.coordinates) {
                console.log('üè¢ –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É');
                
                try {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É –ø—Ä–æ–µ–∫—Ç–∞
                    let projectColor = '#2563EB'; // —Å–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (projectData.status === 'active') projectColor = '#059669'; // –∑–µ–ª–µ–Ω—ã–π
                    else if (projectData.status === 'completed') projectColor = '#10B981'; // —Å–∞–ª–∞—Ç–æ–≤—ã–π
                    else if (projectData.status === 'suspended') projectColor = '#DC2626'; // –∫—Ä–∞—Å–Ω—ã–π
                    else if (projectData.status === 'planned') projectColor = '#6B7280'; // —Å–µ—Ä—ã–π
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∏ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–∏–≥–æ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞
                    const coords = projectData.coordinates;
                    const centerLng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                    const centerLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–∏–≥–æ–Ω–∞ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∑—É–º–∞
                    let minLng = Infinity, maxLng = -Infinity;
                    let minLat = Infinity, maxLat = -Infinity;
                    coords.forEach(coord => {
                        minLng = Math.min(minLng, coord[0]);
                        maxLng = Math.max(maxLng, coord[0]);
                        minLat = Math.min(minLat, coord[1]);
                        maxLat = Math.max(maxLat, coord[1]);
                    });
                    
                    const lngSpan = maxLng - minLng;
                    const latSpan = maxLat - minLat;
                    const maxSpan = Math.max(lngSpan, latSpan);
                    
                    // –í—ã–±–∏—Ä–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∑—É–º
                    let optimalZoom = 18;
                    if (maxSpan > 0.001) optimalZoom = 16;
                    else if (maxSpan > 0.005) optimalZoom = 15;
                    else if (maxSpan > 0.01) optimalZoom = 14;
                    else if (maxSpan > 0.02) optimalZoom = 13;
                    
                    console.log(`üéØ –¶–µ–Ω—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞: [${centerLng.toFixed(6)}, ${centerLat.toFixed(6)}], –∑—É–º: ${optimalZoom}`);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
                    map.addPolygon(coords, {
                        title: `–ü—Ä–æ–µ–∫—Ç: ${projectData.name}`,
                        strokeColor: projectColor,
                        fillColor: projectColor + '4D', // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                        strokeWidth: 3, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—â–∏–Ω—É –≥—Ä–∞–Ω–∏—Ü—ã
                        strokeOpacity: 0.8,
                        fillOpacity: 0.3,
                        data: {
                            type: 'project',
                            ...projectData
                        }
                    });
                    
                    console.log('‚úÖ –ü–æ–ª–∏–≥–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è
                    if (!violationData.hasLocation) {
                        console.log(`üéØ –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ: [${centerLng}, ${centerLat}], –∑—É–º: ${optimalZoom}`);
                        
                        // –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fitToExtent –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ö–≤–∞—Ç–∞ –ø–æ–ª–∏–≥–æ–Ω–∞
                        try {
                            console.log(`üéØ –ü—Ä–æ–±—É–µ–º fitToExtent –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–∞...`);
                            console.log(`   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫: ${coords.length}`);
                            console.log(`   –ì—Ä–∞–Ω–∏—Ü—ã: lng ${minLng.toFixed(6)} - ${maxLng.toFixed(6)}, lat ${minLat.toFixed(6)} - ${maxLat.toFixed(6)}`);
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fitToExtent —Å –≤—Å–µ–º–∏ —Ç–æ—á–∫–∞–º–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
                            if (map.fitToExtent && typeof map.fitToExtent === 'function') {
                                console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º fitToExtent...');
                                map.fitToExtent(coords, 100); // 100px –ø–∞–¥–¥–∏–Ω–≥
                                mapCentered = true;
                                console.log('‚úÖ fitToExtent –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                            } else {
                                // –û—Ç–∫–∞—Ç –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—é
                                console.log('‚ö†Ô∏è fitToExtent –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º setCenter');
                                const boundsCenter = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
                                console.log(`   –¶–µ–Ω—Ç—Ä –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º: [${boundsCenter[0]}, ${boundsCenter[1]}]`);
                                
                                map.setCenter([boundsCenter[0], boundsCenter[1]], optimalZoom);
                                mapCentered = true;
                            }
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ –ø–æ–ª–∏–≥–æ–Ω–∞ (–ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º)
                            const markerCenter = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
                            map.addMarker([markerCenter[0], markerCenter[1]], {
                                title: projectData.name,
                                color: projectColor,
                                popup: `
                                    <div class="p-4 min-w-64">
                                        <h3 class="font-bold text-blue-900 mb-2">üè¢ ${projectData.name}</h3>
                                        <p class="text-sm text-gray-700 mb-1">üìç ${projectData.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                                        <p class="text-xs text-gray-600 mb-1">–°—Ç–∞—Ç—É—Å: ${projectData.status}</p>
                                        <p class="text-xs text-gray-600 mb-2">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${projectData.completion}%</p>
                                        <div class="border-t border-gray-200 pt-2 mt-2">
                                            <p class="text-xs text-blue-600">üìç –¶–µ–Ω—Ç—Ä: [${markerCenter[0].toFixed(6)}, ${markerCenter[1].toFixed(6)}]</p>
                                            <p class="text-xs text-green-600">üó∫Ô∏è –†–∞–∑–º–µ—Ä: ${lngSpan.toFixed(6)} √ó ${latSpan.toFixed(6)}</p>
                                            <p class="text-xs text-purple-600">üéØ –¢–æ—á–µ–∫: ${coords.length}</p>
                                        </div>
                                    </div>
                                `,
                                data: projectData
                            });
                            
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–∞');
                            
                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã (–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
                            setTimeout(() => {
                                try {
                                    if (map.map && map.map.updateSize) {
                                        map.map.updateSize();
                                        console.log('üîÑ –†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                                        
                                        // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
                                        if (map.fitToExtent && typeof map.fitToExtent === 'function') {
                                            map.fitToExtent(coords, 50);
                                            console.log('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ fitToExtent –ø–æ—Å–ª–µ updateSize');
                                        }
                                    }
                                } catch (updateError) {
                                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã:', updateError);
                                }
                            }, 1000);
                            
                        } catch (centerError) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã, –æ—Ç–∫–∞—Ç –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –º–µ—Ç–æ–¥—É:', centerError);
                            // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑–µ—Ä–≤ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                            const fallbackCenter = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
                            map.setCenter([fallbackCenter[0], fallbackCenter[1]], 16);
                            mapCentered = true;
                            console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ');
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (violationData.hasLocation) {
                console.log('üö® –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è');
                
                try {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
                    let violationColor = '#DC2626'; // –∫—Ä–∞—Å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (violationData.priority === 'critical') violationColor = '#991B1B'; // —Ç–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                    else if (violationData.priority === 'high') violationColor = '#DC2626'; // –∫—Ä–∞—Å–Ω—ã–π
                    else if (violationData.priority === 'medium') violationColor = '#F59E0B'; // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    else if (violationData.priority === 'low') violationColor = '#FBBF24'; // –∂–µ–ª—Ç—ã–π
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º
                    if (!mapCentered) {
                        console.log(`üöë –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–µ—Å—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è: [${violationData.lng}, ${violationData.lat}]`);
                        map.setCenter([violationData.lng, violationData.lat], 18);
                        mapCentered = true;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è
                    map.addMarker([violationData.lng, violationData.lat], {
                        title: `–ù–∞—Ä—É—à–µ–Ω–∏–µ: ${violationData.title}`,
                        color: violationColor,
                        popup: `
                            <div class="p-3">
                                <h3 class="font-bold text-red-900 mb-2">‚ö†Ô∏è ${violationData.title}</h3>
                                <p class="text-sm text-gray-600 mb-1">üìÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: ${violationData.detected_at}</p>
                                <p class="text-sm text-gray-600 mb-1">üï∞Ô∏è –°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è: ${violationData.deadline}</p>
                                <p class="text-xs text-gray-600 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${violationData.priority}</p>
                                <p class="text-xs text-gray-600 mb-1">–°—Ç–∞—Ç—É—Å: ${violationData.status}</p>
                                ${violationData.locationDescription ? `<p class="text-sm text-gray-600 mt-2">${violationData.locationDescription}</p>` : ''}
                            </div>
                        `,
                        data: {
                            type: 'violation',
                            ...violationData
                        }
                    });
                    
                    console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω');
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è');
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ú–æ—Å–∫–≤—É
                if (!mapCentered) {
                    map.setCenter([37.6176, 55.7558], 10);
                    map.addMarker([37.6176, 55.7558], {
                        title: '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                        color: '#6B7280',
                        popup: `
                            <div class="p-3">
                                <h3 class="font-bold text-gray-900 mb-2">üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ</h3>
                                <p class="text-sm text-gray-700">–î–ª—è –Ω–∞—Ä—É—à–µ–Ω–∏—è "${violationData.title}" –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</p>
                            </div>
                        `
                    });
                }
            }
        };
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        console.log('üó∫Ô∏è –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É...');
        map = createRussianMap('map', {
            center: [37.6176, 55.7558],
            zoom: 10,
            debug: true,
            defaultProvider: 'osm'
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        document.getElementById('map-provider').addEventListener('change', function(e) {
            const provider = e.target.value;
            if (map && map.changeProvider) {
                const success = map.changeProvider(provider);
                console.log(success ? `‚úÖ –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–º–µ–Ω–µ–Ω –Ω–∞: ${provider}` : '‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞');
            }
        });
        
        console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        
    } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        document.getElementById('map-loading').innerHTML = `
            <div class="flex items-center justify-center h-96 bg-red-50">
                <div class="text-center">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h3 class="text-xl font-bold text-red-900 mb-2">–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã</h3>
                    <p class="text-sm text-red-600 mb-4">${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </div>
            </div>
        `;
    }
});

// Smooth scrolling for internal links
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus on textarea if verification form is present
    const textarea = document.getElementById('inspector_comment');
    if (textarea && textarea.closest('form')) {
        textarea.focus();
    }
    
    // –£–ª—É—á—à–µ–Ω–∏—è UX –¥–ª—è —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    const commentTextarea = document.getElementById('id_comment');
    const submitButton = document.getElementById('submit-comment-btn') || document.querySelector('button[name="add_comment"]');
    const clearButton = document.querySelector('button[onclick*="clearCommentForm"]');
    
    console.log('=== COMMENT FORM DEBUG ===');
    console.log('Textarea found:', !!commentTextarea, commentTextarea);
    console.log('Submit button found:', !!submitButton, submitButton);
    console.log('Clear button found:', !!clearButton, clearButton);
    
    if (commentTextarea && submitButton) {
        // –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏
        function updateButtonState() {
            const textValue = commentTextarea.value.trim();
            const shouldEnable = textValue.length > 0;
            
            console.log('üí° Update button state:', { 
                textValue: textValue.substring(0, 20) + '...', 
                textLength: textValue.length,
                shouldEnable, 
                currentlyDisabled: submitButton.disabled 
            });
            
            if (shouldEnable) {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.classList.add('hover:shadow-xl', 'hover:-translate-y-0.5');
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
                console.log('‚úÖ Button ENABLED');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.classList.remove('hover:shadow-xl', 'hover:-translate-y-0.5');
                submitButton.style.opacity = '0.5';
                submitButton.style.cursor = 'not-allowed';
                console.log('‚ùå Button DISABLED');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
        function autoResize() {
            commentTextarea.style.height = 'auto';
            commentTextarea.style.height = Math.min(commentTextarea.scrollHeight, 300) + 'px';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
        function handleTextChange() {
            console.log('üìù Text change event triggered');
            const charCount = commentTextarea.value.length;
            
            autoResize();
            updateButtonState();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
            const counter = document.querySelector('.char-counter');
            const counterDisplay = document.querySelector('.char-counter-display');
            
            console.log('üî¢ Counter elements:', { 
                counter: !!counter, 
                counterDisplay: !!counterDisplay,
                charCount,
                counterText: counter ? counter.textContent : 'not found'
            });
            
            if (counter && counterDisplay) {
                if (charCount === 0) {
                    counter.textContent = '0 —Å–∏–º–≤–æ–ª–æ–≤';
                    counterDisplay.className = 'char-counter-display px-2 py-1 rounded bg-gray-100 text-gray-500';
                } else if (charCount < 10) {
                    counter.textContent = `${charCount} —Å–∏–º–≤. - –Ω–∞–ø–∏—à–∏—Ç–µ –µ—â—ë`;
                    counterDisplay.className = 'char-counter-display px-2 py-1 rounded bg-orange-100 text-orange-600';
                } else if (charCount < 100) {
                    counter.textContent = `${charCount} —Å–∏–º–≤–æ–ª–æ–≤ - –æ—Ç–ª–∏—á–Ω–æ!`;
                    counterDisplay.className = 'char-counter-display px-2 py-1 rounded bg-green-100 text-green-600';
                } else {
                    counter.textContent = `${charCount} —Å–∏–º–≤–æ–ª–æ–≤ - –æ—Ç–ª–∏—á–Ω–æ!`;
                    counterDisplay.className = 'char-counter-display px-2 py-1 rounded bg-blue-100 text-blue-600';
                }
                console.log('‚úÖ Counter updated:', counter.textContent);
            } else {
                console.warn('‚ö†Ô∏è Counter elements not found!');
            }
            
            // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
            if (clearButton) {
                clearButton.style.display = charCount > 0 ? 'inline-flex' : 'none';
            }
        }
        
        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
        const events = ['input', 'keyup', 'keydown', 'change', 'blur', 'focus'];
        events.forEach(eventType => {
            commentTextarea.addEventListener(eventType, function() {
                console.log(`üìù Event: ${eventType}, text length: ${this.value.length}`);
                handleTextChange();
            });
        });
        
        commentTextarea.addEventListener('paste', function() {
            setTimeout(() => {
                console.log('üìã Paste event handled, text length:', this.value.length);
                handleTextChange();
            }, 10);
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏
        window.testCommentButton = function() {
            console.log('üß™ Testing comment button activation...');
            if (commentTextarea) {
                commentTextarea.value = '–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏';
                commentTextarea.dispatchEvent(new Event('input'));
                handleTextChange();
                updateButtonState();
                console.log('Test text added and events fired');
            }
        };
        
        window.forceEnableButton = function() {
            console.log('üí™ Forcing button activation...');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
                console.log('‚úÖ Button force-enabled!');
            }
        };
        
        window.clearComment = function() {
            if (commentTextarea) {
                commentTextarea.value = '';
                handleTextChange();
                updateButtonState();
                console.log('üß° Comment cleared');
            }
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –≤ HTML
        window.clearCommentForm = function() {
            console.log('üßπ Clearing comment form via HTML button...');
            const textarea = document.getElementById('id_comment');
            const button = document.getElementById('submit-comment-btn');
            
            if (textarea) {
                textarea.value = '';
                textarea.focus();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                textarea.dispatchEvent(new Event('input'));
                textarea.dispatchEvent(new Event('change'));
                
                if (button) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                    button.classList.remove('hover:shadow-xl');
                }
                
                console.log('‚úÖ Form cleared successfully');
            } else {
                console.error('‚ùå Textarea not found for clearing');
            }
        };
        
        window.debugCommentForm = function() {
            console.log('üîç Comment form debug info:', {
                textarea: commentTextarea,
                submitButton: submitButton,
                textareaValue: commentTextarea ? commentTextarea.value : 'no textarea',
                buttonDisabled: submitButton ? submitButton.disabled : 'no button',
                buttonClasses: submitButton ? submitButton.className : 'no button'
            });
        };
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        console.log('üéÜ Initial setup...');
        console.log('üìù Available functions: testCommentButton(), forceEnableButton(), clearComment(), debugCommentForm()');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        commentTextarea.value = commentTextarea.value || '';  // –û–±–Ω—É–ª—è–µ–º, –µ—Å–ª–∏ undefined
        handleTextChange(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        autoResize();
        updateButtonState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            console.log('üîç Final button check:', {
                disabled: submitButton.disabled,
                classes: submitButton.className,
                textLength: commentTextarea.value.trim().length
            });
        }, 1000);
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ—Ä–º—É
        const commentForm = commentTextarea.closest('.bg-gradient-to-r');
        if (commentForm) {
            commentForm.addEventListener('click', function(e) {
                if (e.target === commentForm || e.target.closest('.flex.items-center.mb-4')) {
                    commentTextarea.focus();
                }
            });
        }
        
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const form = commentTextarea.closest('form');
        if (form) {
            form.addEventListener('submit', function() {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ
                if (submitButton) {
                    const originalContent = submitButton.innerHTML;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
                    submitButton.disabled = true;
                }
            });
        }
    }
    
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    const comments = document.querySelectorAll('.relative.bg-white.border');
    comments.forEach((comment, index) => {
        comment.style.opacity = '0';
        comment.style.transform = 'translateY(20px)';
        setTimeout(() => {
            comment.style.transition = 'all 0.5s ease';
            comment.style.opacity = '1';
            comment.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    // Close modal on escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closePhotoModal();
        }
    });
    
    // Close modal on background click
    const photoModal = document.getElementById('photoModal');
    if (photoModal) {
        photoModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closePhotoModal();
            }
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    console.log('üñºÔ∏è Modal functions check:', {
        openPhotoModal: typeof openPhotoModal,
        closePhotoModal: typeof closePhotoModal,
        windowOpenPhotoModal: typeof window.openPhotoModal,
        windowClosePhotoModal: typeof window.closePhotoModal,
        functionsWork: !!openPhotoModal && !!closePhotoModal
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    const photoImages = document.querySelectorAll('img[onclick*="openPhotoModal"]');
    console.log('üì∑ Found photo images:', photoImages.length);
    
    photoImages.forEach((img, index) => {
        console.log(`üñºÔ∏è Photo ${index + 1}:`, {
            src: img.src,
            onclick: img.getAttribute('onclick'),
            hasOnclick: img.hasAttribute('onclick')
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        img.addEventListener('click', function(e) {
            console.log('üì∏ Photo clicked:', this.src);
            
            // –ï—Å–ª–∏ onclick –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
            if (window.openPhotoModal && !e.defaultPrevented) {
                // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ onclick –∞—Ç—Ä–∏–±—É—Ç–∞
                const onclickAttr = this.getAttribute('onclick');
                if (onclickAttr) {
                    try {
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ onclick
                        const match = onclickAttr.match(/openPhotoModal\(([^)]+)\)/);
                        if (match) {
                            console.log('üîß Trying manual modal opening');
                            eval(onclickAttr); // –í—ã–ø–æ–ª–Ω—è–µ–º onclick
                        }
                    } catch (error) {
                        console.error('‚ùå Error executing onclick manually:', error);
                    }
                }
            }
        });
    });
    
    // –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    setTimeout(() => {
        console.log('üöë Emergency fallback for comment button...');
        const anyTextarea = document.querySelector('textarea');
        const anySubmitButton = document.getElementById('submit-comment-btn') || document.querySelector('button[name="add_comment"], button[type="submit"]');
        
        if (anyTextarea && anySubmitButton) {
            console.log('üîß Found fallback elements:', { anyTextarea, anySubmitButton });
            
            function emergencyButtonUpdate() {
                const hasText = anyTextarea.value.trim().length > 0;
                anySubmitButton.disabled = !hasText;
                
                if (hasText) {
                    anySubmitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    anySubmitButton.classList.add('hover:shadow-xl');
                    console.log('‚úÖ EMERGENCY: Button enabled');
                } else {
                    anySubmitButton.classList.add('opacity-50', 'cursor-not-allowed');
                    anySubmitButton.classList.remove('hover:shadow-xl');
                    console.log('‚ùå EMERGENCY: Button disabled');
                }
            }
            
            // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            anyTextarea.addEventListener('input', emergencyButtonUpdate);
            anyTextarea.addEventListener('keyup', emergencyButtonUpdate);
            anyTextarea.addEventListener('change', emergencyButtonUpdate);
            
            // –ù–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            emergencyButtonUpdate();
        } else {
            console.error('‚ö†Ô∏è Even fallback elements not found!');
        }
    }, 2000);
    
    // –ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ—Å—Å–∏–π—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã
});
</script>

{% endblock %}
