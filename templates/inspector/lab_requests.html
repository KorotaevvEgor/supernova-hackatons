{% extends 'base.html' %}

{% block title %}Заявки на лабораторные пробы - Инспектор{% endblock %}

{% block content %}
<style>
.glass-effect {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.card-hover {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.priority-urgent {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
  box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
}

.priority-critical {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
  animation: pulse-soft 2s ease-in-out infinite;
}

@keyframes pulse-soft {
  0%, 100% {
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
  }
  50% {
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
  }
}
</style>

<!-- Главный контейнер -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    
    <!-- Геро-секция -->
    <div class="relative overflow-hidden bg-gradient-to-r from-indigo-600 via-indigo-700 to-blue-800 rounded-3xl shadow-2xl">
      <div class="absolute top-0 right-0 w-96 h-96 bg-white opacity-5 rounded-full -mr-48 -mt-48"></div>
      <div class="absolute bottom-0 left-0 w-64 h-64 bg-white opacity-5 rounded-full -ml-32 -mb-32"></div>
      
      <div class="relative px-8 py-12">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-4">
              <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center mr-6">
                <i class="fas fa-vial text-3xl text-white"></i>
              </div>
              <div>
                <h1 class="text-4xl font-bold text-white mb-2">Заявки на лабораторные пробы</h1>
                <p class="text-xl text-indigo-100">Управление заявками на отбор и анализ материалов</p>
              </div>
            </div>
          </div>
          <div class="hidden lg:block">
            <a href="{% url 'inspector:create_lab_request' %}" 
               class="inline-flex items-center px-6 py-3 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-2xl transition-all duration-300 font-semibold shadow-xl hover:shadow-2xl transform hover:scale-105 backdrop-blur-sm">
              <i class="fas fa-plus mr-3 text-lg"></i>
              Создать заявку
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Статистика -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <a href="{% url 'inspector:lab_requests' %}" class="glass-effect rounded-2xl p-6 card-hover cursor-pointer shadow-xl">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-3">
              <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-list-alt text-white text-lg"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total_requests }}</p>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Всего заявок</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-100">
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-chart-bar mr-2"></i>
            Общая статистика
          </div>
        </div>
      </a>
      
      <a href="{% url 'inspector:lab_requests' %}?status=testing" class="glass-effect rounded-2xl p-6 card-hover cursor-pointer shadow-xl {% if stats.testing_count > 0 %}ring-2 ring-indigo-200 animate-pulse{% endif %}">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-3">
              <div class="w-12 h-12 {% if stats.testing_count > 0 %}bg-gradient-to-br from-indigo-500 to-indigo-600{% else %}bg-gray-400{% endif %} rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-flask text-white text-lg {% if stats.testing_count > 0 %}animate-pulse{% endif %}"></i>
              </div>
              <div>
                <p class="text-2xl font-bold {% if stats.testing_count > 0 %}text-indigo-600{% else %}text-gray-900{% endif %}">{{ stats.testing_count }}</p>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Тестирование</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-100">
          <div class="flex items-center text-sm {% if stats.testing_count > 0 %}text-indigo-600{% else %}text-gray-600{% endif %}">
            <i class="fas fa-microscope mr-2"></i>
            {% if stats.testing_count > 0 %}Активные тесты{% else %}Нет тестов{% endif %}
          </div>
        </div>
      </a>
      
      <a href="{% url 'inspector:lab_requests' %}?status=completed" class="glass-effect rounded-2xl p-6 card-hover cursor-pointer shadow-xl {% if stats.completed_count > 0 %}ring-2 ring-blue-200{% endif %}">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-3">
              <div class="w-12 h-12 {% if stats.completed_count > 0 %}bg-gradient-to-br from-blue-500 to-blue-600{% else %}bg-gray-400{% endif %} rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-check-circle text-white text-lg"></i>
              </div>
              <div>
                <p class="text-2xl font-bold {% if stats.completed_count > 0 %}text-blue-600{% else %}text-gray-900{% endif %}">{{ stats.completed_count }}</p>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Завершено</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-100">
          <div class="flex items-center text-sm {% if stats.completed_count > 0 %}text-blue-600{% else %}text-gray-600{% endif %}">
            <i class="fas fa-clipboard-check mr-2"></i>
            {% if stats.completed_count > 0 %}Готовые результаты{% else %}Нет результатов{% endif %}
          </div>
        </div>
      </a>
      
      <div class="glass-effect rounded-2xl p-6 card-hover shadow-xl {% if stats.overdue_count > 0 %}ring-2 ring-red-200 priority-critical{% endif %}">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center mb-3">
              <div class="w-12 h-12 {% if stats.overdue_count > 0 %}bg-white bg-opacity-20{% else %}bg-gray-400{% endif %} rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-exclamation-triangle {% if stats.overdue_count > 0 %}text-white{% else %}text-white{% endif %} text-lg{% if stats.overdue_count > 0 %} animate-pulse{% endif %}"></i>
              </div>
              <div>
                <p class="text-2xl font-bold {% if stats.overdue_count > 0 %}text-white{% else %}text-gray-900{% endif %}">{{ stats.overdue_count }}</p>
                <p class="text-sm font-medium {% if stats.overdue_count > 0 %}text-red-100{% else %}text-gray-600{% endif %} uppercase tracking-wide">Просрочено</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t {% if stats.overdue_count > 0 %}border-red-200{% else %}border-gray-100{% endif %}">
          <div class="flex items-center text-sm {% if stats.overdue_count > 0 %}text-red-100{% else %}text-gray-600{% endif %}">
            <i class="fas fa-clock mr-2"></i>
            {% if stats.overdue_count > 0 %}Требует внимания!{% else %}Отлично{% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Список заявок -->
    <div class="glass-effect rounded-2xl shadow-xl overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-8 py-6">
        <h2 class="text-2xl font-bold text-white flex items-center">
          <i class="fas fa-list mr-3"></i>
          Мои заявки ({{ lab_requests.paginator.count|default:0 }})
        </h2>
        <p class="text-indigo-100 mt-1">Лабораторные исследования</p>
      </div>
      
      {% if lab_requests %}
        <div class="max-h-screen overflow-y-auto">
          {% for request in lab_requests %}
            <div class="p-8 border-b border-gray-100 last:border-b-0 card-hover bg-white cursor-pointer" 
                 onclick="window.location.href='{% url 'inspector:lab_request_detail' request.id %}'">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 mr-4">{{ request.material_type.name }}</h3>
                    <div class="flex items-center gap-3">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if request.status == 'requested' %}bg-slate-100 text-slate-800 border border-slate-200
                        {% elif request.status == 'scheduled' %}bg-blue-100 text-blue-800 border border-blue-200
                        {% elif request.status == 'sampling' %}bg-indigo-100 text-indigo-800 border border-indigo-200
                        {% elif request.status == 'testing' %}bg-indigo-100 text-indigo-800 border border-indigo-200
                        {% elif request.status == 'completed' %}bg-blue-100 text-blue-800 border border-blue-200
                        {% elif request.status == 'cancelled' %}bg-gray-100 text-gray-800 border border-gray-200
                        {% else %}bg-gray-100 text-gray-800 border border-gray-200
                        {% endif %}">
                        <i class="fas fa-circle text-xs mr-1"></i>
                        {{ request.get_status_display }}
                      </span>
                      {% if request.urgency == 'urgent' %}
                        <span class="priority-urgent text-sm px-3 py-1 rounded-full font-semibold">
                          <i class="fas fa-bolt mr-1"></i>
                          Срочно
                        </span>
                      {% elif request.urgency == 'critical' %}
                        <span class="priority-critical text-sm px-3 py-1 rounded-full font-semibold">
                          <i class="fas fa-exclamation-triangle mr-1"></i>
                          Критично
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="bg-gray-50 rounded-xl p-4 mb-4">
                    <p class="text-lg font-medium text-gray-800 mb-2">
                      <i class="fas fa-building mr-2 text-blue-600"></i>{{ request.project.name }}
                    </p>
                    <p class="text-sm text-gray-600">
                      <i class="fas fa-hashtag mr-2 text-gray-400"></i>Заявка #{{ request.id }}
                    </p>
                  </div>
                  
                  <p class="text-gray-700 text-lg leading-relaxed mb-6">{{ request.reason|truncatechars:150 }}</p>
                  
                  <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-50 rounded-xl p-4">
                      <p class="text-sm font-semibold text-blue-800 mb-1">
                        <i class="fas fa-calendar-plus mr-2"></i>Дата создания
                      </p>
                      <p class="text-blue-700">{{ request.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                    {% if request.expected_results_date %}
                    <div class="bg-indigo-50 rounded-xl p-4">
                      <p class="text-sm font-semibold text-indigo-800 mb-1">
                        <i class="fas fa-calendar-check mr-2"></i>Ожидаемо
                      </p>
                      <p class="text-indigo-700">{{ request.expected_results_date|date:"d.m.Y" }}</p>
                    </div>
                    {% endif %}
                    <div class="bg-gray-50 rounded-xl p-4">
                      <p class="text-sm font-semibold text-gray-800 mb-1">
                        <i class="fas fa-weight mr-2"></i>Количество
                      </p>
                      <p class="text-gray-700">{{ request.sample_quantity }}</p>
                    </div>
                  </div>
                  
                  {% if request.is_overdue %}
                    <div class="mt-4 p-3 bg-red-50 border-l-4 border-red-400 rounded">
                      <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <span class="text-red-800 font-semibold">Просрочено - требует внимания!</span>
                      </div>
                    </div>
                  {% endif %}
                </div>
                
                <div class="ml-8">
                  <a href="{% url 'inspector:lab_request_detail' request.id %}" 
                     class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 font-semibold"
                     onclick="event.stopPropagation();">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Подробнее
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        
        <!-- Пагинация -->
        {% if lab_requests.has_other_pages %}
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-700 font-medium">
                Показано {{ lab_requests.start_index }} - {{ lab_requests.end_index }} из {{ lab_requests.paginator.count }}
              </div>
              <div class="flex space-x-3">
                {% if lab_requests.has_previous %}
                  <a href="?page={{ lab_requests.previous_page_number }}" 
                     class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium shadow-sm">
                    <i class="fas fa-chevron-left mr-2"></i>
                    Предыдущая
                  </a>
                {% endif %}
                {% if lab_requests.has_next %}
                  <a href="?page={{ lab_requests.next_page_number }}" 
                     class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium shadow-lg">
                    Следующая
                    <i class="fas fa-chevron-right ml-2"></i>
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% else %}
        <!-- Пустое состояние -->
        <div class="p-16 text-center">
          <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-vial text-4xl text-indigo-500"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-3">Заявок на пробы пока нет</h3>
          <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">Создайте первую заявку на лабораторные исследования</p>
          <a href="{% url 'inspector:create_lab_request' %}" 
             class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded-2xl transition-all duration-300 font-bold shadow-xl hover:shadow-2xl transform hover:scale-105">
            <i class="fas fa-plus mr-3 text-lg"></i>
            Создать первую заявку
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
console.log('🧪 Lab requests list initialized with modern design');
</script>

{% endblock %}
