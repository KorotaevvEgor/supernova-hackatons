{% extends 'base.html' %}
{% load static %}

{% block title %}–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'moscow-blue': '#003366',
                    'moscow-red': '#DC143C', 
                    'moscow-gold': '#FFD700',
                    'moscow-green': '#228B22',
                }
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 mb-6 text-white shadow-xl">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold mb-1">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç</h1>
                    <p class="text-blue-200">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
                </div>
            </div>
            <div>
                <a href="{% url 'projects:project_list' %}" class="inline-flex items-center px-6 py-3 bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-all duration-200 font-medium shadow-lg hover:shadow-xl border border-blue-200">
                    <i class="fas fa-arrow-left mr-2"></i>–ö –ø—Ä–æ–µ–∫—Ç–∞–º
                </a>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-white to-blue-50 p-6 rounded-xl text-center shadow-lg border border-blue-100">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-building text-blue-600"></i>
                </div>
                <div class="text-2xl font-bold text-blue-600">{{ projects_count }}</div>
                <div class="text-sm text-blue-600 font-medium">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
            </div>
            <div class="bg-gradient-to-br from-white to-yellow-50 p-6 rounded-xl text-center shadow-lg border border-yellow-100">
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-tasks text-yellow-600"></i>
                </div>
                <div class="text-2xl font-bold text-yellow-600">{{ total_works }}</div>
                <div class="text-sm text-yellow-600 font-medium">–†–∞–±–æ—Ç –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
            </div>
            <div class="bg-gradient-to-br from-white to-green-50 p-6 rounded-xl text-center shadow-lg border border-green-100">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                <div class="text-2xl font-bold text-green-600" id="verifiedCount">0</div>
                <div class="text-sm text-green-600 font-medium">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
    </div>

    {% if works_to_verify %}
    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6 shadow-lg">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-info-circle text-blue-600 text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
                <p class="text-blue-700">
                    –î–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ –æ–±—ä–µ–∫—Ç–µ. 
                    –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.
                </p>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç -->
    <div class="space-y-4">
        {% for item in works_to_verify %}
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-all duration-300">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-3">
                        <h3 class="text-xl font-semibold text-gray-900">{{ item.work.name }}</h3>
                        
                        <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                        {% if item.priority == 'high' %}
                        <span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-medium">
                            üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        </span>
                        {% endif %}
                        
                        <!-- –î–Ω–∏ —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç—á–µ—Ç–∞ -->
                        {% if item.days_since_reported > 2 %}
                        <span class="px-2 py-1 bg-orange-100 text-orange-600 rounded text-xs font-medium">
                            ‚è∞ {{ item.days_since_reported }} –¥–Ω. –Ω–∞–∑–∞–¥
                        </span>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600"><strong>–ü—Ä–æ–µ–∫—Ç:</strong> 
                                <a href="{% url 'projects:project_detail' item.project.id %}" 
                                   class="text-moscow-blue hover:underline">
                                    {{ item.project.name }}
                                </a>
                            </p>
                            <p class="text-sm text-gray-600"><strong>–¢–∏–ø —Ä–∞–±–æ—Ç:</strong> {{ item.work.work_type.name }}</p>
                            <p class="text-sm text-gray-600"><strong>–û–±—ä–µ–º:</strong> {{ item.work.volume }} {{ item.work.unit }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600"><strong>–ü–ª–∞–Ω–æ–≤–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> 
                                <span class="{% if item.work.is_delayed %}text-red-600 font-medium{% endif %}">
                                    {{ item.work.planned_end_date|date:"d.m.Y" }}
                                </span>
                            </p>
                            <p class="text-sm text-gray-600"><strong>–ü—Ä–æ—Ä–∞–±:</strong> 
                                {{ item.project.foreman.get_full_name|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}
                            </p>
                            <p class="text-sm text-gray-600"><strong>–û—Ç—á–µ—Ç –ø–æ–ª—É—á–µ–Ω:</strong> {{ item.work.updated_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã -->
                    {% if item.work.description %}
                    <div class="bg-gray-50 p-3 rounded mb-3">
                        <p class="text-sm text-gray-700">{{ item.work.description }}</p>
                    </div>
                    {% endif %}
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="ml-6 flex flex-col space-y-3">
                    <a href="{% url 'verification:project_verification' item.project.id %}" 
                       class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 font-medium shadow-lg hover:shadow-xl text-sm text-center">
                        <i class="fas fa-map-marker-alt mr-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    </a>
                    
                    <button onclick="quickVerifyWork({{ item.work.id }})" 
                            class="verification-button inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 font-medium shadow-lg hover:shadow-xl text-sm">
                        <i class="fas fa-check mr-2"></i>–ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg p-12 text-center border border-gray-100">
        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center">
            <i class="fas fa-clipboard-check text-green-600 text-3xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-3">–í—Å–µ —Ä–∞–±–æ—Ç—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã!</h3>
        <p class="text-gray-600 text-lg max-w-md mx-auto leading-relaxed mb-8">
            –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç —Ä–∞–±–æ—Ç, —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.
        </p>
        <div class="flex justify-center space-x-4">
            <a href="{% url 'projects:project_list' %}" 
               class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 font-medium shadow-lg hover:shadow-xl">
                <i class="fas fa-building mr-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º
            </a>
            <a href="{% url 'projects:work_schedule' %}" 
               class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all duration-200 font-medium shadow-lg hover:shadow-xl">
                <i class="fas fa-project-diagram mr-2"></i>–°–µ—Ç–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
let currentLocation = null;

// –ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
async function quickVerifyWork(workId) {
    if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã?\n\n–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.')) {
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
    if (!navigator.geolocation) {
        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                const response = await fetch(`{% url "verification:verify_work" 0 %}`.replace('0', workId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        notes: '–ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
                    window.location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error verifying work:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã');
            }
        },
        (error) => {
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    break;
                case error.TIMEOUT:
                    errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
                    break;
            }
            
            alert('‚ùå ' + errorMessage);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
document.addEventListener('DOMContentLoaded', function() {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
    // –ü–æ–∫–∞ —á—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—á–µ—Ç—á–∏–∫
});
</script>
{% endblock %}