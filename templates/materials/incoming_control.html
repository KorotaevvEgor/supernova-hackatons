{% extends 'base.html' %}
{% load static %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º OCR - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="bg-white shadow-lg rounded-xl border border-gray-100">
    <div class="px-8 py-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-robot text-blue-600 mr-3"></i>
            –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏ —Å OCR
          </h1>
          <p class="mt-2 text-lg text-gray-600">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π
          </p>
          {% if selected_project %}
          <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
              <i class="fas fa-info-circle mr-2"></i>
              –ü–æ—Å—Ç–∞–≤–∫–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: <strong>{{ selected_project.name }}</strong>
            </p>
          </div>
          {% endif %}
        </div>
        <div class="flex items-center space-x-2">
          <div class="px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm font-medium">
            <i class="fas fa-shield-check mr-2"></i>
            AI –ü–æ–¥–¥–µ—Ä–∂–∫–∞
          </div>
          <div class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-xs font-medium">
            <i class="fas fa-cloud mr-1"></i>
            OCR.space AI
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Ü–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-gray-900">–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏</h2>
      <div class="text-sm text-gray-500">–®–∞–≥ <span id="current-step">1</span> –∏–∑ 4</div>
    </div>
    <div class="flex items-center space-x-3">
      <div class="step-indicator active" data-step="1">
        <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold">1</div>
        <span class="text-sm font-medium mt-2">–ó–∞–≥—Ä—É–∑–∫–∞</span>
      </div>
      <div class="flex-1 h-1 bg-gray-200 rounded">
        <div id="progress-bar" class="h-full bg-blue-600 rounded transition-all duration-500" style="width: 25%"></div>
      </div>
      <div class="step-indicator" data-step="2">
        <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-semibold">2</div>
        <span class="text-sm font-medium mt-2">OCR</span>
      </div>
      <div class="flex-1 h-1 bg-gray-200 rounded"></div>
      <div class="step-indicator" data-step="3">
        <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-semibold">3</div>
        <span class="text-sm font-medium mt-2">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
      </div>
      <div class="flex-1 h-1 bg-gray-200 rounded"></div>
      <div class="step-indicator" data-step="4">
        <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-semibold">4</div>
        <span class="text-sm font-medium mt-2">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>
      </div>
    </div>
  </div>

  <!-- –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
  <div id="step-1" class="bg-white rounded-xl shadow-lg p-8">
    <div class="text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">
        <i class="fas fa-cloud-upload-alt text-blue-600 mr-2"></i>
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ—Å—Ç–∞–≤–∫–∏
      </h2>
      <p class="text-gray-600 mb-8">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –¢–¢–ù, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, —Å—á–µ—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã, –ø–∞—Å–ø–æ—Ä—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞</p>
      
      <!-- –û–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ -->
      <div id="upload-zone" class="border-3 border-dashed border-gray-300 rounded-xl p-12 hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer">
        <div class="space-y-4">
          <div class="flex justify-center">
            <i class="fas fa-file-upload text-6xl text-gray-400"></i>
          </div>
          <div>
            <p class="text-xl font-medium text-gray-700">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
            <p class="text-gray-500 mt-2">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
          </div>
          <div class="text-sm text-gray-400">
            JPG, PNG, PDF ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 10MB
          </div>
        </div>
        <input type="file" id="file-input" class="hidden" accept="image/*,.pdf" />
      </div>

      <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
      <div id="file-preview" class="hidden mt-8">
        <div class="bg-gray-50 rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:</h3>
            <button id="remove-file" class="text-red-600 hover:text-red-700">
              <i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
          <div class="flex items-center space-x-4">
            <img id="preview-image" class="w-32 h-32 object-cover rounded-lg border" alt="–ü—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            <div class="flex-1 text-left">
              <p id="file-name" class="font-medium text-gray-900"></p>
              <p id="file-size" class="text-sm text-gray-500"></p>
              <div class="mt-4">
                <button id="start-ocr" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                  <i class="fas fa-robot mr-2"></i>
                  –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –®–∞–≥ 2: OCR –û–±—Ä–∞–±–æ—Ç–∫–∞ -->
  <div id="step-2" class="hidden bg-white rounded-xl shadow-lg p-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-900">
        <i class="fas fa-brain text-blue-600 mr-2"></i>
        –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
      </h2>
      <p class="text-gray-600 mt-2">–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- –ü—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
      <div>
        <h3 class="font-semibold text-gray-900 mb-4">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</h3>
        <div class="border rounded-lg overflow-hidden">
          <img id="processing-preview" class="w-full h-64 object-contain bg-gray-50" alt="–î–æ–∫—É–º–µ–Ω—Ç">
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
      <div>
        <h3 class="font-semibold text-gray-900 mb-4">–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
        <div class="space-y-4">
          <div id="processing-status" class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
              <i class="fas fa-spinner fa-spin text-white text-sm"></i>
            </div>
            <span class="text-gray-700">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OCR —Å–∏—Å—Ç–µ–º—ã...</span>
          </div>
          
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
              <span id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="ocr-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>

          <div id="ocr-results" class="hidden mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center text-green-800">
                <i class="fas fa-check-circle mr-2"></i>
                <span class="font-medium">–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</span>
                <span id="ocr-service-badge" class="ml-3 px-2 py-1 bg-green-200 text-green-700 text-xs rounded-full font-medium">
                  ¬†
                </span>
              </div>
              <button id="download-text-btn" class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition-colors">
                <i class="fas fa-download mr-1"></i>
                –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç
              </button>
            </div>
            <p class="text-sm text-green-600 mt-1">–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π: <span id="fields-count">0</span></p>
            <div id="text-preview" class="mt-3 p-3 bg-white rounded border text-sm font-mono text-gray-700 max-h-32 overflow-y-auto hidden">
              <div class="text-xs text-gray-500 mb-2 font-sans">–ü—Ä–µ–≤—å—é —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤):</div>
              <div id="text-preview-content"></div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è -->
            <div class="mt-4 flex justify-center">
              <button id="view-results-btn" class="hidden bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                <i class="fas fa-eye mr-2"></i>
                –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –®–∞–≥ 3: –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ OCR -->
  <div id="step-3" class="hidden bg-white rounded-xl shadow-lg p-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-900">
        <i class="fas fa-search-plus text-blue-600 mr-2"></i>
        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
      </h2>
      <p class="text-gray-600 mt-2">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
      <div>
        <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-file-image text-blue-600 mr-2"></i>
          –ò—Å—Ö–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        </h3>
        <div class="border rounded-lg overflow-hidden bg-gray-50">
          <img id="results-preview" class="w-full h-80 object-contain" alt="–î–æ–∫—É–º–µ–Ω—Ç">
        </div>
        
        <!-- –û–±—â–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
          <h4 class="font-medium text-blue-900 mb-3">
            <i class="fas fa-chart-line mr-2"></i>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
          </h4>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span>OCR —Å–µ—Ä–≤–∏—Å:</span>
              <span id="result-ocr-service" class="font-medium text-green-700">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>–û–±—â–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</span>
              <span id="result-confidence" class="font-medium">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π:</span>
              <span id="result-fields-count" class="font-medium">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>–¢–µ–∫—Å—Ç–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:</span>
              <span id="result-text-length" class="font-medium">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–æ–ª—è -->
      <div>
        <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
          <i class="fas fa-list-ul text-green-600 mr-2"></i>
          –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–æ–ª—è
        </h3>
        <div id="extracted-fields" class="space-y-3">
          <!-- –ü–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        
        <!-- –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç -->
        <div class="mt-6">
          <h4 class="font-medium text-gray-900 mb-3 flex items-center">
            <i class="fas fa-align-left text-gray-600 mr-2"></i>
            –ü–æ–ª–Ω—ã–π —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            <button id="toggle-full-text" class="ml-2 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded hover:bg-gray-300">
              <i class="fas fa-eye"></i>
              –ü–æ–∫–∞–∑–∞—Ç—å
            </button>
          </h4>
          <div id="full-text-content" class="hidden p-3 bg-gray-50 rounded border font-mono text-sm max-h-64 overflow-y-auto">
            <!-- –¢–µ–∫—Å—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
          </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="mt-8 flex justify-between">
          <button id="back-to-upload" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            –ù–∞–∑–∞–¥
          </button>
          <div class="flex space-x-3">
            <button id="download-results-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-download mr-2"></i>
              –°–∫–∞—á–∞—Ç—å
            </button>
            <button id="continue-to-form" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
              <i class="fas fa-arrow-right mr-2"></i>
              –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –®–∞–≥ 4: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ -->
  <div id="step-4" class="hidden bg-white rounded-xl shadow-lg p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-900">
        <i class="fas fa-edit text-blue-600 mr-2"></i>
        –î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏
      </h2>
      <div class="flex space-x-3">
        <button id="view-ocr-details-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors hidden">
          <i class="fas fa-search mr-2"></i>
          –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å OCR
        </button>
        <button id="auto-fill-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors hidden">
          <i class="fas fa-magic mr-2"></i>
          –ü–µ—Ä–µ–∑–∞–ø–æ–ª–Ω–∏—Ç—å
        </button>
        <button id="test-transport-fill-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors hidden">
          <i class="fas fa-truck mr-2"></i>
          –¢–µ—Å—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
        </button>
        <button id="test-data-fill-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors hidden">
          <i class="fas fa-magic mr-2"></i>
          –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        </button>
        <button id="quick-test-fill-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors hidden">
          <i class="fas fa-bolt mr-2"></i>
          –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
        </button>
        <a href="/materials/" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors inline-flex items-center hidden">
          <i class="fas fa-list mr-2"></i>
          –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –ø–æ—Å—Ç–∞–≤–∫–∏
        </a>
        <a href="/materials/" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium inline-flex items-center">
          <i class="fas fa-arrow-left mr-2"></i>
          –ù–∞–∑–∞–¥
        </a>
        <button id="save-delivery-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
          <i class="fas fa-save mr-2"></i>
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É
        </button>
      </div>
    </div>

    <form id="delivery-form" class="space-y-6">
      {% csrf_token %}
      
      <!-- –ü–û–õ–Ø –í–´–ë–û–†–ê –ü–†–û–ï–ö–¢–ê –ò –ú–ê–¢–ï–†–ò–ê–õ–ê -->
      <div class="bg-green-50 rounded-lg border border-green-200 p-6 mb-6">
        <div class="mb-4">
          <h3 class="text-xl font-bold text-green-900 flex items-center">
            <i class="fas fa-building mr-3"></i>
            –û–±—ä–µ–∫—Ç –∏ –º–∞—Ç–µ—Ä–∏–∞–ª
          </h3>
          <p class="text-green-700 text-sm mt-2">
            –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç (–æ–±—ä–µ–∫—Ç) –∏ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 text-red-600">
              –ü—Ä–æ–µ–∫—Ç (–æ–±—ä–µ–∫—Ç) *
            </label>
            <select name="project" id="project-select" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç...</option>
              {% for project in projects %}
                <option value="{{ project.id }}" {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                  {{ project.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 text-red-600">
              –¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *
            </label>
            <select name="material_type" id="material-type-select" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞...</option>
              {% for material_type in material_types %}
                <option value="{{ material_type.id }}" data-unit="{{ material_type.unit }}">
                  {{ material_type.name }} ({{ material_type.code }})
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      
      <!-- –ü–û–õ–Ø –¢–†–ê–ù–°–ü–û–†–¢–ù–û–ô –ù–ê–ö–õ–ê–î–ù–û–ô -->
      <div class="bg-blue-50 rounded-lg border border-blue-200 p-6">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-900 flex items-center">
            <i class="fas fa-truck mr-3"></i>
            –ü–æ–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
          </h3>
          <p class="text-blue-700 text-sm mt-2">
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–æ–ª—è –∏–∑ OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
            </label>
            <input type="text" name="document_number" id="document-number-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
            </label>
            <input type="date" name="delivery_date" id="delivery-date-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            </label>
            <input type="number" name="quantity" id="quantity-input" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.01">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç
            </label>
            <input type="number" name="package_count" id="package-count-input" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   min="1" step="1">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ü–æ—Å—Ç–∞–≤—â–∏–∫
            </label>
            <input type="text" name="supplier" id="supplier-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
            </label>
            <input type="text" name="supplier_inn" id="supplier-inn-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ì—Ä—É–∑–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å
            </label>
            <input type="text" name="recipient" id="recipient-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –í–æ–¥–∏—Ç–µ–ª—å
            </label>
            <input type="text" name="driver_name" id="driver-name-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            </label>
            <input type="text" name="vehicle_number" id="vehicle-number-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥)
            </label>
            <input type="number" name="cargo_weight" id="cargo-weight-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.01">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –û–±—ä–µ–º (–º¬≥)
            </label>
            <input type="number" name="volume" id="volume-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.01">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ú–∞—Å—Å–∞ –Ω–µ—Ç—Ç–æ (—Ç)
            </label>
            <input type="number" name="cargo_weight_net" id="cargo-weight-net-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.001">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ú–∞—Å—Å–∞ –±—Ä—É—Ç—Ç–æ (—Ç)
            </label>
            <input type="number" name="cargo_weight_gross" id="cargo-weight-gross-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.001">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –û–±—ä–µ–º –≥—Ä—É–∑–∞ (–º¬≥)
            </label>
            <input type="number" name="cargo_volume" id="cargo-volume-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   step="0.01">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –¢–∏–ø –≤–ª–∞–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
            </label>
            <select name="ownership_type" id="ownership-type-input"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
              <option value="0">–ë–µ–∑–≤–æ–∑–º–µ–∑–¥–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</option>
              <option value="1">–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</option>
              <option value="2">–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</option>
              <option value="3">–ê—Ä–µ–Ω–¥–∞</option>
              <option value="4">–õ–∏–∑–∏–Ω–≥</option>
            </select>
          </div>
        </div>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞) -->
        <div class="col-span-full mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            –û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞
          </label>
          <textarea name="description" id="description-input" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≥—Ä—É–∑–∞..."></textarea>
        </div>
      </div>
      </div>

      <!-- OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ) -->
      <input type="hidden" name="ocr_data" id="ocr-data-input">
    </form>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–æ–≤–µ—Ä–∏—è OCR -->
    <div id="ocr-confidence" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
      <h4 class="font-medium text-blue-900 mb-2">
        <i class="fas fa-chart-bar mr-2"></i>
        –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
      </h4>
      <div class="space-y-2">
        <div class="flex justify-between text-sm">
          <span>–û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å:</span>
          <span id="overall-confidence" class="font-medium">0%</span>
        </div>
        <div class="w-full bg-blue-200 rounded-full h-2">
          <div id="confidence-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>
</div>

<style>
.step-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.step-indicator.active .w-10 {
  background-color: #2563eb !important;
  color: white !important;
}

.step-indicator.completed .w-10 {
  background-color: #16a34a !important;
  color: white !important;
}

.drag-over {
  border-color: #2563eb !important;
  background-color: #eff6ff !important;
}

.field-confidence-high {
  border-color: #16a34a;
  background-color: #f0fdf4;
}

.field-confidence-medium {
  border-color: #eab308;
  background-color: #fefce8;
}

.field-confidence-low {
  border-color: #dc2626;
  background-color: #fef2f2;
}
</style>

<script>
// === –†–µ–∞–ª—å–Ω—ã–π OCR v2.1 + –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ - –û–±–Ω–æ–≤–ª–µ–Ω–æ 26.09.2025 ===
let currentStep = 1;
let uploadedFile = null;
let ocrResults = null;

document.addEventListener('DOMContentLoaded', function() {
  setupEventListeners();
  updateStepIndicator();
});

function setupEventListeners() {
  // Drag & Drop
  const uploadZone = document.getElementById('upload-zone');
  const fileInput = document.getElementById('file-input');
  
  uploadZone.addEventListener('click', () => fileInput.click());
  uploadZone.addEventListener('dragover', handleDragOver);
  uploadZone.addEventListener('drop', handleDrop);
  uploadZone.addEventListener('dragleave', handleDragLeave);
  
  fileInput.addEventListener('change', handleFileSelect);
  
  // –ö–Ω–æ–ø–∫–∏
  document.getElementById('remove-file').addEventListener('click', removeFile);
  document.getElementById('start-ocr').addEventListener('click', startOCR);
  document.getElementById('view-ocr-details-btn').addEventListener('click', viewOCRDetailsFromForm);
  document.getElementById('auto-fill-btn').addEventListener('click', autoFillForm);
  document.getElementById('test-transport-fill-btn').addEventListener('click', testTransportWaybillFill);
  document.getElementById('test-data-fill-btn').addEventListener('click', fillTestData);
  document.getElementById('quick-test-fill-btn').addEventListener('click', quickTestFill);
  document.getElementById('save-delivery-btn').addEventListener('click', saveDelivery);
  
  // –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è 4-—à–∞–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  document.getElementById('view-results-btn').addEventListener('click', viewOCRResults);
  document.getElementById('back-to-upload').addEventListener('click', backToUpload);
  document.getElementById('continue-to-form').addEventListener('click', continueToForm);
  document.getElementById('toggle-full-text').addEventListener('click', toggleFullText);
  document.getElementById('download-results-btn').addEventListener('click', downloadOCRText);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
  document.getElementById('material-type-select').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const unit = selectedOption.getAttribute('data-unit');
    console.log('üìã –í—ã–±—Ä–∞–Ω —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞:', selectedOption.text, ', –µ–¥. –∏–∑–º.:', unit);
    
    // –ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    const quantityLabel = document.querySelector('label[for="quantity-input"]');
    if (quantityLabel && unit) {
      quantityLabel.innerHTML = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <span class="text-gray-500">(' + unit + ')</span>';
    }
  });
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
}

function handleFileSelect(e) {
  const files = e.target.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
}

function handleFile(file) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞
  if (!validateFile(file)) return;
  
  uploadedFile = file;
  showFilePreview(file);
}

function validateFile(file) {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  if (!allowedTypes.includes(file.type)) {
    showNotification('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞', 'error');
    return false;
  }
  
  if (file.size > maxSize) {
    showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 10MB)', 'error');
    return false;
  }
  
  return true;
}

function showFilePreview(file) {
  const preview = document.getElementById('file-preview');
  const previewImage = document.getElementById('preview-image');
  const fileName = document.getElementById('file-name');
  const fileSize = document.getElementById('file-size');
  
  fileName.textContent = file.name;
  fileSize.textContent = formatFileSize(file.size);
  
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else if (file.type === 'application/pdf') {
    previewImage.src = '/static/img/pdf-icon.svg'; // –ò–∫–æ–Ω–∫–∞ PDF
    previewImage.alt = 'PDF –¥–æ–∫—É–º–µ–Ω—Ç';
    previewImage.classList.add('bg-gray-100', 'p-4');
  } else {
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –∏–∫–æ–Ω–∫—É
    previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iOCIgeT0iNCIgd2lkdGg9IjM2IiBoZWlnaHQ9IjUyIiByeD0iNCIgZmlsbD0iIzY5NzU4MyIgc3Ryb2tlPSIjMzc0MTUxIiBzdHJva2Utd2lkdGg9IjIiLz4KPHRleHQgeD0iMjAiIHk9IjM0IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGRkZGRkYiPkZJTEU8L3RleHQ+Cjwvc3ZnPg==';
  }
  
  preview.classList.remove('hidden');
}

function removeFile() {
  uploadedFile = null;
  document.getElementById('file-preview').classList.add('hidden');
  document.getElementById('file-input').value = '';
}

function startOCR() {
  if (!uploadedFile) {
    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏', 'error');
    return;
  }
  
  currentStep = 2;
  updateStepIndicator();
  showStep(2);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –≤ —Å–µ–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const processingPreview = document.getElementById('processing-preview');
  if (uploadedFile.type === 'application/pdf') {
    // –î–ª—è PDF –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É
    processingPreview.src = '/static/img/pdf-icon.svg';
    processingPreview.classList.add('bg-gray-100', 'p-8');
  } else {
    // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    const reader = new FileReader();
    reader.onload = (e) => {
      processingPreview.src = e.target.result;
    };
    reader.readAsDataURL(uploadedFile);
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º OCR
  performOCR();
}

async function performOCR() {
  const statusElement = document.getElementById('processing-status');
  const progressElement = document.getElementById('ocr-progress');
  const percentElement = document.getElementById('progress-percent');
  
  try {
    if (!uploadedFile) {
      throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
    }
    
    // –≠—Ç–∞–ø—ã —Ä–µ–∞–ª—å–Ω–æ–≥–æ OCR –ø—Ä–æ—Ü–µ—Å—Å–∞
    const stages = [
      { text: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', progress: 15 },
      { text: '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', progress: 30 },
      { text: '–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', progress: 45 },
      { text: 'OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...', progress: 70 },
      { text: '–ê–Ω–∞–ª–∏–∑ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', progress: 90 },
      { text: '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...', progress: 100 }
    ];
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø
    updateProcessingStatus(stages[0].text, stages[0].progress);
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('ttn', uploadedFile);
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (!csrfToken) {
      const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
      if (cookieValue) {
        csrfToken = cookieValue.split('=')[1];
      }
    }
    if (!csrfToken) {
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (csrfInput) {
        csrfToken = csrfInput.value;
      }
    }
    
    updateProcessingStatus(stages[1].text, stages[1].progress);
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const response = await fetch('/api/materials/ocr/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
      },
      body: formData
    });
    
    updateProcessingStatus(stages[2].text, stages[2].progress);
    await new Promise(resolve => setTimeout(resolve, 500));
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    updateProcessingStatus(stages[3].text, stages[3].progress);
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const result = await response.json();
    
    updateProcessingStatus(stages[4].text, stages[4].progress);
    await new Promise(resolve => setTimeout(resolve, 500));
    
    if (!result.success) {
      throw new Error(result.error || '–û—à–∏–±–∫–∞ OCR –æ–±—Ä–∞–±–æ—Ç–∫–∏');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã OCR
    ocrResults = {
      fields: result.fields || {},
      confidence: result.confidence || 0,
      field_confidences: result.field_confidences || {},
      raw_text: result.raw_text || '',
      ocr_service: result.ocr_service || 'OCR.space'
    };
    
    updateProcessingStatus(stages[5].text, stages[5].progress);
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    document.getElementById('ocr-results').classList.remove('hidden');
    document.getElementById('fields-count').textContent = Object.keys(ocrResults.fields).length;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π OCR —Å–µ—Ä–≤–∏—Å
    const ocrServiceBadge = document.getElementById('ocr-service-badge');
    if (ocrServiceBadge && ocrResults.ocr_service) {
      ocrServiceBadge.innerHTML = `<i class="fas fa-cloud mr-1"></i>${ocrResults.ocr_service}`;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
    if (ocrResults.raw_text) {
      const textPreview = document.getElementById('text-preview');
      const textContent = document.getElementById('text-preview-content');
      textContent.textContent = ocrResults.raw_text.substring(0, 300) + (ocrResults.raw_text.length > 300 ? '...' : '');
      textPreview.classList.remove('hidden');
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      const downloadBtn = document.getElementById('download-text-btn');
      downloadBtn.addEventListener('click', downloadOCRText);
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–µ (–®–∞–≥ 4) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
    console.log('üéÜ OCR –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π');
    
    currentStep = 4;
    updateStepIndicator();
    showStep(4);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ OCR)
    document.getElementById('view-ocr-details-btn').classList.remove('hidden');
    
    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
    setTimeout(() => {
      console.log('üöö –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...');
      
      // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
      testTransportWaybillFill();
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      setTimeout(() => {
        showNotification('‚úÖ –§–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¢–¢–ù. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ!', 'info');
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
        const formEl = document.getElementById('delivery-form');
        if (formEl && typeof formEl.scrollIntoView === 'function') {
          formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 1500);
      
    }, 300);
    
  } catch (error) {
    console.error('OCR Error:', error);
    showNotification(`–û—à–∏–±–∫–∞ OCR: ${error.message}`, 'error');
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–µ—Ä–≤–æ–º—É —à–∞–≥—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
    setTimeout(() => {
      currentStep = 1;
      updateStepIndicator();
      showStep(1);
    }, 2000);
  }
}

function updateProcessingStatus(text, progress) {
  const statusElement = document.getElementById('processing-status');
  const progressElement = document.getElementById('ocr-progress');
  const percentElement = document.getElementById('progress-percent');
  
  statusElement.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
      <i class="fas fa-spinner fa-spin text-white text-sm"></i>
    </div>
    <span class="text-gray-700">${text}</span>
  `;
  
  progressElement.style.width = progress + '%';
  percentElement.textContent = progress + '%';
}

function autoFillForm() {
  if (!ocrResults) {
    console.warn('‚ö†Ô∏è autoFillForm: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö OCR –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
    return { filledCount: 0, error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö OCR' };
  }
  
  const fields = ocrResults.fields || {};
  const form = document.getElementById('delivery-form');
  
  if (!form) {
    console.error('‚ùå autoFillForm: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ñ–æ—Ä–º–∞ delivery-form');
    return { filledCount: 0, error: '–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };
  }
  
  console.log('üîÑ autoFillForm: –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ');
  console.log('üìù OCR fields:', fields);
  
  // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π OCR –∏ —Ñ–æ—Ä–º—ã
  const fieldMapping = {
    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    'quantity': 'quantity',
    'package_count': 'package_count', 
    'delivery_date': 'delivery_date',
    
    // –ü–æ—Å—Ç–∞–≤—â–∏–∫ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    'supplier': 'supplier',
    'document_number': 'document_number',
    'supplier_inn': 'supplier_inn',
    'driver_name': 'driver_name',
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    'vehicle_number': 'vehicle_number',
    'cargo_weight': 'cargo_weight',
    'description': 'description',
    
    // –ü–æ–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
    'recipient': 'recipient',
    'delivery_address': 'delivery_address',
    'volume': 'volume',
    'cargo_weight_net': 'cargo_weight_net',
    'cargo_weight_gross': 'cargo_weight_gross',
    'cargo_volume': 'cargo_volume',
    'ownership_type': 'ownership_type'
  };
  
  let filledCount = 0;
  const filledFields = [];
  
  console.log(`üîç –ù–∞–π–¥–µ–Ω–æ ${Object.keys(fields).length} OCR –ø–æ–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏`);
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
  Object.entries(fields).forEach(([ocrFieldName, ocrValue]) => {
    const formFieldName = fieldMapping[ocrFieldName];
    
    if (!formFieldName) {
      console.log(`üî≥ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ: ${ocrFieldName}`);
      return;
    }
    
    if (!ocrValue || ocrValue.toString().trim() === '') {
      console.log(`üî≥ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ: ${ocrFieldName}`);
      return;
    }
    
    console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: ${ocrFieldName} -> ${formFieldName} = "${ocrValue}"`);
    
    // –ò—â–µ–º –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ
    const input = form.querySelector(`[name="${formFieldName}"]`);
    
    if (input) {
      let value = ocrValue.toString().trim();
      
      console.log(`‚úÖ –ù–∞—à–ª–∏ –ø–æ–ª–µ ${formFieldName}, –∑–∞–ø–æ–ª–Ω—è–µ–º: "${value}"`);
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
      if (formFieldName === 'delivery_date') {
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ 28.09.2025 –≤ 2025-09-28
        const dateMatch = value.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
        if (dateMatch) {
          const day = dateMatch[1].padStart(2, '0');
          const month = dateMatch[2].padStart(2, '0');
          const year = dateMatch[3];
          value = `${year}-${month}-${day}`;
          console.log(`üìÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª–∏ –¥–∞—Ç—É –≤: ${value}`);
        }
      }
      
      if (formFieldName === 'quantity') {
        // –£–¥–∞–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
        value = value.replace(/\s*(—Ç–æ–Ω–Ω|—Ç\.|–∫–≥|—à—Ç|–º¬≥|–º¬≤).*$/i, '');
      }
      
      if (formFieldName === 'cargo_weight') {
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–Ω–Ω –≤ –∫–≥ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (value.includes('—Ç–æ–Ω–Ω') || value.includes('—Ç.')) {
          const tonValue = parseFloat(value.replace(/[^\d,.]/g, '').replace(',', '.'));
          if (!isNaN(tonValue)) {
            value = (tonValue * 1000).toString();
          }
        } else {
          value = value.replace(/\s*(–∫–≥|—Ç\.).*$/i, '');
        }
      }
      
      if (formFieldName === 'ownership_type') {
        // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞
        const numValue = value.replace(/\D/g, '').substring(0, 1);
        if (numValue) value = numValue;
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä–æ–±–Ω—ã—Ö —á–∏—Å–µ–ª (–≤–µ—Å, –æ–±—ä–µ–º)
      if (formFieldName.includes('weight_') || formFieldName === 'volume' || formFieldName === 'cargo_volume') {
        // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É
        value = value.replace(',', '.').replace(/[^\d.]/g, '');
      }
      
      // –û—á–∏—Å—Ç–∫–∞ –æ–±—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
      value = value.trim();
      
      if (value) {
        input.value = value;
        filledCount++;
        filledFields.push({
          name: formFieldName,
          originalValue: ocrValue,
          processedValue: value
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        setTimeout(() => {
          input.classList.add('field-confidence-high');
          input.style.transform = 'scale(1.02)';
          input.style.transition = 'all 0.3s ease';
          
          setTimeout(() => {
            input.classList.remove('field-confidence-high');
            input.style.transform = 'scale(1)';
          }, 1200);
        }, filledCount * 80);
        
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ: ${formFieldName} = "${value}"`);
      } else {
        console.log(`‚ö†Ô∏è –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è: ${formFieldName}`);
      }
    } else {
      console.log(`‚ùå –ù–µ –Ω–∞—à–ª–∏ –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ: ${formFieldName}`);
    }
  });
  
  console.log(`üéÜ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ. –ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ${filledCount} –ø–æ–ª–µ–π`);
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  return {
    filledCount: filledCount,
    filledFields: filledFields,
    success: filledCount > 0
  };
}

function showOCRConfidence() {
  if (!ocrResults) return;
  
  const confidenceSection = document.getElementById('ocr-confidence');
  const confidenceBar = document.getElementById('confidence-bar');
  const overallConfidence = document.getElementById('overall-confidence');
  
  confidenceSection.classList.remove('hidden');
  confidenceBar.style.width = ocrResults.confidence + '%';
  overallConfidence.textContent = ocrResults.confidence + '%';
}

async function saveDelivery() {
  console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏...');
  
  const form = document.getElementById('delivery-form');
  if (!form) {
    console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ñ–æ—Ä–º–∞ delivery-form');
    showNotification('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ñ–æ—Ä–º–∞', 'error');
    return;
  }
  
  const formData = new FormData(form);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  const quantity = formData.get('quantity');
  const delivery_date = formData.get('delivery_date');
  const supplier = formData.get('supplier');
  const description = formData.get('description');
  
  console.log('üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π:', {
    quantity: quantity,
    delivery_date: delivery_date,
    supplier: supplier,
    description: description
  });
  
  if (!quantity || !delivery_date || !supplier) {
    console.warn('‚ö†Ô∏è –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏, –ü–æ—Å—Ç–∞–≤—â–∏–∫', 'error');
    return;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç –∏ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞
  const selectedProject = formData.get('project');
  const selectedMaterialType = formData.get('material_type');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –∏ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤—ã–±—Ä–∞–Ω—ã
  if (!selectedProject || !selectedMaterialType) {
    console.warn('‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç (–æ–±—ä–µ–∫—Ç) –∏ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞', 'error');
    return;
  }
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Django API
  const data = {
    project: parseInt(selectedProject),
    material_type: parseInt(selectedMaterialType),
    quantity: parseFloat(quantity) || 1,
    delivery_date: delivery_date,
    supplier: supplier,
    document_number: formData.get('document_number') || '',
    supplier_inn: formData.get('supplier_inn') || '',
    driver_name: formData.get('driver_name') || '',
    vehicle_number: formData.get('vehicle_number') || '',
    cargo_weight: formData.get('cargo_weight') || '',
    description: description || '',
    ocr_data: ocrResults ? JSON.stringify(ocrResults) : '{}'
  };
  
  console.log('üìé –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è API:', data);
  
  const saveBtn = document.getElementById('save-delivery-btn');
  const originalText = saveBtn.innerHTML;
  
  try {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (!csrfToken) {
      const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
      if (cookieValue) {
        csrfToken = cookieValue.split('=')[1];
      }
    }
    if (!csrfToken) {
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (csrfInput) {
        csrfToken = csrfInput.value;
      }
    }
    
    console.log('üîê CSRF —Ç–æ–∫–µ–Ω:', csrfToken ? '–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω' : '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
    
    if (!csrfToken) {
      console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!');
      showNotification('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω CSRF —Ç–æ–∫–µ–Ω', 'error');
      return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Django API
    console.log('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ /api/materials/delivery/create-with-ocr/');
    
    const response = await fetch('/api/materials/delivery/create-with-ocr/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(data)
    });
    
    console.log('üìä –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok,
      headers: Object.fromEntries(response.headers.entries())
    });
    
    const result = await response.json();
    console.log('üìé –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞:', result);
    
    if (result.success) {
      showNotification('–ü–æ—Å—Ç–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É!', 'success');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ–∑–º–æ–∂–µ–Ω –ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ–±–Ω–æ–≤ (–∏–∑ —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)
      const canRefreshInPlace = window.refreshMaterialDeliveries && typeof window.refreshMaterialDeliveries === 'function';
      
      if (canRefreshInPlace) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        setTimeout(async () => {
          showNotification('–û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...', 'info');
          try {
            await window.refreshMaterialDeliveries();
            showNotification('–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É...', 'warning');
            setTimeout(() => {
              window.location.href = '/materials/';
            }, 1500);
          }
        }, 800);
      } else {
        // –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        setTimeout(() => {
          showNotification('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...', 'info');
        }, 800);
        
        setTimeout(() => {
          showNotification('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...', 'success');
          setTimeout(() => {
            window.location.href = '/materials/';
          }, 2000);
        }, 1000);
      }
    } else {
      throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
    
  } catch (error) {
    console.error('Save Error:', error);
    showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
}

function updateStepIndicator() {
  const progressBar = document.getElementById('progress-bar');
  const currentStepElement = document.getElementById('current-step');
  
  currentStepElement.textContent = currentStep;
  progressBar.style.width = (currentStep * 25) + '%';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —à–∞–≥–æ–≤
  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
    const stepNum = index + 1;
    const circle = indicator.querySelector('.w-10');
    
    if (stepNum < currentStep) {
      indicator.classList.add('completed');
      indicator.classList.remove('active');
      circle.style.backgroundColor = '#16a34a';
      circle.innerHTML = '<i class="fas fa-check text-white"></i>';
    } else if (stepNum === currentStep) {
      indicator.classList.add('active');
      indicator.classList.remove('completed');
    } else {
      indicator.classList.remove('active', 'completed');
    }
  });
}

function showStep(step) {
  document.querySelectorAll('[id^="step-"]').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById(`step-${step}`).classList.remove('hidden');
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}


function downloadOCRText() {
  if (!ocrResults || !ocrResults.raw_text) {
    showNotification('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'error');
    return;
  }
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  const fileName = uploadedFile ? uploadedFile.name.replace(/\.[^/.]+$/, '') : 'document';
  const currentDate = new Date().toISOString().slice(0, 19).replace(/T/, '_').replace(/:/g, '-');
  const fullFileName = `${fileName}_OCR_${currentDate}.txt`;
  
  let textContent = `=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ OCR –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø ===\n`;
  textContent += `–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: ${uploadedFile ? uploadedFile.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
  textContent += `–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${new Date().toLocaleString('ru-RU')}\n`;
  textContent += `OCR —Å–µ—Ä–≤–∏—Å: ${ocrResults.ocr_service || 'OCR.space'}\n`;
  textContent += `–û–±—â–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${ocrResults.confidence}%\n`;
  textContent += `–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π: ${Object.keys(ocrResults.fields).length}\n\n`;
  
  textContent += `=== –ò–ó–í–õ–ï–ß–Å–ù–ù–´–ï –ü–û–õ–Ø ===\n`;
  for (const [field, value] of Object.entries(ocrResults.fields)) {
    const confidence = ocrResults.field_confidences[field] || 0;
    textContent += `${field}: ${value} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidence}%)\n`;
  }
  
  textContent += `\n=== –ü–û–õ–ù–´–ô –†–ê–°–ü–û–ó–ù–ê–ù–ù–´–ô –¢–ï–ö–°–¢ ===\n`;
  textContent += ocrResults.raw_text;
  
  // –°–æ–∑–¥–∞—ë–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
  const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = fullFileName;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification(`–¢–µ–∫—Å—Ç —Å–∫–∞—á–∞–Ω: ${fullFileName}`, 'success');
}

function showNotification(message, type = 'info') {
  const notifications = document.getElementById('notifications');
  const notification = document.createElement('div');
  
  const colors = {
    success: 'bg-green-50 border-green-200 text-green-800',
    error: 'bg-red-50 border-red-200 text-red-800',
    warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
    info: 'bg-blue-50 border-blue-200 text-blue-800'
  };
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-times-circle',
    warning: 'fa-exclamation-triangle',
    info: 'fa-info-circle'
  };
  
  notification.className = `${colors[type]} border rounded-lg p-4 shadow-lg transition-all duration-300 max-w-sm`;
  notification.innerHTML = `
    <div class="flex items-start">
      <i class="fas ${icons[type]} mt-0.5 mr-3"></i>
      <div class="flex-1">
        <p class="font-medium">${message}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-2 opacity-70 hover:opacity-100">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  notifications.appendChild(notification);
  
  // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}

// –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è 4-—à–∞–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞

function viewOCRResults() {
  if (!ocrResults) {
    showNotification('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ OCR –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
    return;
  }
  
  currentStep = 3;
  updateStepIndicator();
  showStep(3);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  const resultsPreview = document.getElementById('results-preview');
  if (uploadedFile) {
    const reader = new FileReader();
    reader.onload = (e) => {
      resultsPreview.src = e.target.result;
    };
    reader.readAsDataURL(uploadedFile);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  document.getElementById('result-ocr-service').textContent = ocrResults.ocr_service || 'OCR.space';
  document.getElementById('result-confidence').textContent = ocrResults.confidence + '%';
  document.getElementById('result-fields-count').textContent = Object.keys(ocrResults.fields).length;
  document.getElementById('result-text-length').textContent = ocrResults.raw_text ? ocrResults.raw_text.length + ' —Å–∏–º–≤–æ–ª–æ–≤' : '0 —Å–∏–º–≤–æ–ª–æ–≤';
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø–æ–ª—è
  displayExtractedFields();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
  const fullTextContent = document.getElementById('full-text-content');
  fullTextContent.textContent = ocrResults.raw_text || '–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω';
}

function displayExtractedFields() {
  const container = document.getElementById('extracted-fields');
  container.innerHTML = '';
  
  if (!ocrResults.fields || Object.keys(ocrResults.fields).length === 0) {
    container.innerHTML = '<div class="text-gray-500 text-sm">–ü–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    return;
  }
  
  // –ù–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  const fieldNames = {
    'delivery_date': '–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏',
    'document_number': '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞',
    'supplier': '–ü–æ—Å—Ç–∞–≤—â–∏–∫',
    'material_type': '–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞',
    'package_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç',
    'quantity': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
    'driver_name': '–í–æ–¥–∏—Ç–µ–ª—å',
    'vehicle_number': '–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
    'supplier_inn': '–ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞',
    'cargo_weight': '–í–µ—Å –≥—Ä—É–∑–∞',
    'description': '–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞',
    
    // –ü–æ–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
    'recipient': '–ì—Ä—É–∑–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å',
    'delivery_address': '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏',
    'volume': '–û–±—ä–µ–º (–º¬≥)',
    'cargo_weight_net': '–ú–∞—Å—Å–∞ –Ω–µ—Ç—Ç–æ (—Ç)',
    'cargo_weight_gross': '–ú–∞—Å—Å–∞ –±—Ä—É—Ç—Ç–æ (—Ç)',
    'cargo_volume': '–û–±—ä–µ–º –≥—Ä—É–∑–∞ (–º¬≥)',
    'ownership_type': '–¢–∏–ø –≤–ª–∞–¥–µ–Ω–∏—è'
  };
  
  Object.entries(ocrResults.fields).forEach(([field, value]) => {
    const confidence = ocrResults.field_confidences[field] || 0;
    const displayName = fieldNames[field] || field;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    let confidenceColor = 'gray';
    if (confidence >= 80) confidenceColor = 'green';
    else if (confidence >= 60) confidenceColor = 'yellow';
    else if (confidence >= 40) confidenceColor = 'orange';
    else confidenceColor = 'red';
    
    const fieldElement = document.createElement('div');
    fieldElement.className = 'p-3 bg-gray-50 rounded-lg border';
    fieldElement.innerHTML = `
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="text-sm font-medium text-gray-900">${displayName}</div>
          <div class="text-sm text-gray-700 mt-1 break-words">${value}</div>
        </div>
        <div class="ml-3 flex flex-col items-end">
          <span class="px-2 py-1 text-xs rounded-full bg-${confidenceColor}-100 text-${confidenceColor}-700 font-medium">
            ${confidence}%
          </span>
        </div>
      </div>
    `;
    
    container.appendChild(fieldElement);
  });
}

function toggleFullText() {
  const fullTextContent = document.getElementById('full-text-content');
  const toggleBtn = document.getElementById('toggle-full-text');
  
  if (fullTextContent.classList.contains('hidden')) {
    fullTextContent.classList.remove('hidden');
    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> –°–∫—Ä—ã—Ç—å';
  } else {
    fullTextContent.classList.add('hidden');
    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å';
  }
}

function backToUpload() {
  currentStep = 1;
  updateStepIndicator();
  showStep(1);
}

function continueToForm() {
  currentStep = 4;
  updateStepIndicator();
  showStep(4);
  showOCRConfidence();
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É OCR –∏–∑ —Ñ–æ—Ä–º—ã
function viewOCRDetailsFromForm() {
  if (!ocrResults) {
    showNotification('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ OCR –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
    return;
  }
  
  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 3 (–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
  viewOCRResults();
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
function testTransportWaybillFill() {
  console.log('üöö –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π...');
  
  // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¢–¢–ù
  const testWaybillData = {
    // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    'document_number': '18674/–ï',
    'delivery_date': '2024-06-10',
    'supplier': '–ì–ë–£ –≥–æ—Ä–æ–¥–∞ –ú–æ—Å–∫–≤—ã –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –¥–æ—Ä–æ–≥–∏',
    'quantity': '198',
    'package_count': '1',
    'driver_name': '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
    'vehicle_number': '–ú777–ú–ú177',
    'supplier_inn': '7736050003',
    
    // –ü–æ–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
    'recipient': '–ì–ë–£ –≥–æ—Ä–æ–¥–∞ –ú–æ—Å–∫–≤—ã –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –¥–æ—Ä–æ–≥–∏',
    'description': '–ë–æ—Ä—Ç–æ–≤–æ–π –∫–∞–º–µ–Ω—å 1000—Ö1300—Ö1150, 198 —à—Ç',
    'volume': '19.8',
    'cargo_weight_net': '19.463',
    'cargo_weight_gross': '19.694',
    'cargo_volume': '8.31',
    'cargo_weight': '19463',
    'ownership_type': '0'
  };
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –∏—Å—Ö–æ–¥–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  if (ocrResults) {
    ocrResults.fields = testWaybillData;
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å OCR –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    ocrResults.ocr_service = (ocrResults.ocr_service || 'OCR') + ' + –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¢–¢–ù';
    ocrResults.confidence = 98; // –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  } else {
    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    ocrResults = {
      fields: testWaybillData,
      confidence: 98,
      raw_text: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è ‚Ññ 18674/–ï - —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ',
      ocr_service: '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¢–¢–ù'
    };
  }
  
  console.log('üìù –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¢–¢–ù:', ocrResults);
  
  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
  const fillResult = autoFillForm();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É OCR
  showOCRConfidence();
  
  if (fillResult && fillResult.success) {
    showNotification(`üöö –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¢–¢–ù –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! –ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ${fillResult.filledCount} –ø–æ–ª–µ–π`, 'success');
  } else {
    showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¢–¢–ù', 'warning');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
function fillTestData() {
  console.log('‚ú® –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...');
  
  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 4 (—Ñ–æ—Ä–º–∞)
  currentStep = 4;
  updateStepIndicator();
  showStep(4);
  
  // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  const testSamples = [
    {
      name: '–°—Ç—Ä–æ–π–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ü–ª—é—Å',
      data: {
        'document_number': '‚Ññ1001-–ú',
        'delivery_date': '2024-12-28',
        'supplier': '–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ü–ª—é—Å"',
        'quantity': '25.5',
        'package_count': '50',
        'supplier_inn': '7736207543',
        'driver_name': '–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π –ò–≤–∞–Ω–æ–≤–∏—á',
        'vehicle_number': '–ö456–ú–í1177',
        'cargo_weight': '25500',
        'description': '–¶–µ–º–µ–Ω—Ç –ú400, –º–µ—à–∫–∏ 50–∫–≥',
        'recipient': '–û–û–û "–°—Ç—Ä–æ–π–ú–æ–Ω—Ç–∞–∂"',
        'volume': '12.5',
        'cargo_weight_net': '25.0',
        'cargo_weight_gross': '25.5',
        'cargo_volume': '12.5',
        'ownership_type': '1'
      }
    },
    {
      name: '–ú–µ—Ç–∞–ª–ª–ö–æ–º–ø–ª–µ–∫—Å',
      data: {
        'document_number': '‚Ññ–ú–ö-5678',
        'delivery_date': '2024-12-27',
        'supplier': '–ó–ê–û "–ú–µ—Ç–∞–ª–ª–ö–æ–º–ø–ª–µ–∫—Å"',
        'quantity': '15.8',
        'package_count': '25',
        'supplier_inn': '7710234567',
        'driver_name': '–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ç—Ä–æ–≤–∏—á',
        'vehicle_number': '–ê123–ê–ö199',
        'cargo_weight': '15800',
        'description': '–ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–°, –¥–∏–∞–º–µ—Ç—Ä 12–º–º',
        'recipient': '–û–û–û "–ú–µ—Ç–∞–ª–ª–°—Ç—Ä–æ–π"',
        'volume': '8.2',
        'cargo_weight_net': '15.5',
        'cargo_weight_gross': '15.8',
        'cargo_volume': '8.2',
        'ownership_type': '2'
      }
    },
    {
      name: '–õ–µ—Å–ü—Ä–æ–º–ö–æ–º–ø–ª–µ–∫—Ç',
      data: {
        'document_number': '‚Ññ7890-–õ',
        'delivery_date': '2024-12-26',
        'supplier': '–û–û–û "–õ–µ—Å–ü—Ä–æ–º–ö–æ–º–ø–ª–µ–∫—Ç"',
        'quantity': '85',
        'package_count': '85',
        'supplier_inn': '7701456789',
        'driver_name': '–°–∏–¥–æ—Ä–æ–≤ –ú–∏—Ö–∞–∏–ª –ù–∏–∫–æ–ª–∞–µ–≤–∏—á',
        'vehicle_number': '–ú789–û–ú177',
        'cargo_weight': '3400',
        'description': '–î–æ—Å–∫–∞ –æ–±—Ä–µ–∑–Ω–∞—è 25x150x6000–º–º',
        'recipient': '–û–û–û "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–µ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"',
        'volume': '7.6',
        'cargo_weight_net': '3.2',
        'cargo_weight_gross': '3.4',
        'cargo_volume': '7.6',
        'ownership_type': '3'
      }
    }
  ];
  
  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü
  const randomSample = testSamples[Math.floor(Math.random() * testSamples.length)];
  
  // –°–æ–∑–¥–∞—ë–º OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  ocrResults = {
    fields: randomSample.data,
    confidence: Math.floor(Math.random() * 20) + 80, // –û—Ç 80 –¥–æ 100%
    raw_text: `–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ${randomSample.name}\n–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${randomSample.data.document_number}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${randomSample.data.quantity}\n–û–ø–∏—Å–∞–Ω–∏–µ: ${randomSample.data.description}`,
    ocr_service: '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ'
  };
  
  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
  autoFillForm();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É OCR
  showOCRConfidence();
  
  showNotification(`‚ú® –ó–∞–ø–æ–ª–Ω–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏: ${randomSample.name}`, 'success');
  
  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
  const formEl = document.getElementById('delivery-form');
  if (formEl && typeof formEl.scrollIntoView === 'function') {
    formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// –§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ - —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å OCR
function quickTestFill() {
  console.log('‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç: —Å–∏–º—É–ª—è—Ü–∏—è OCR —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º...');
  
  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫–æ –≤—Ç–æ—Ä–æ–º—É —à–∞–≥—É (–∏–º–∏—Ç–∞—Ü–∏—è OCR)
  currentStep = 2;
  updateStepIndicator();
  showStep(2);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
  updateProcessingStatus('–°–∏–º—É–ª—è—Ü–∏—è OCR –æ–±—Ä–∞–±–æ—Ç–∫–∏...', 50);
  
  // –°–æ–∑–¥–∞—ë–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  const testOCRData = {
    success: true,
    fields: {
      'document_number': '‚Ññ1234-–°–ú',
      'delivery_date': '2024-12-28',
      'supplier': '–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ú–æ—Å–∫–≤—ã"',
      'quantity': '35.2',
      'package_count': '70',
      'supplier_inn': '7701234567',
      'driver_name': '–ü–µ—Ç—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ê–Ω–¥—Ä–µ–µ–≤–∏—á',
      'vehicle_number': '–ú123–û–ú777',
      'cargo_weight': '35200',
      'description': '–¶–µ–º–µ–Ω—Ç –ú400 –≤ –º–µ—à–∫–∞—Ö –ø–æ 50–∫–≥',
      'recipient': '–û–û–û "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—à–µ–Ω–∏—è"',
      'volume': '14.08',
      'cargo_weight_net': '35.0',
      'cargo_weight_gross': '35.2',
      'cargo_volume': '14.08'
    },
    confidence: 94,
    raw_text: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...',
    ocr_service: '–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç OCR'
  };
  
  // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  setTimeout(() => {
    updateProcessingStatus('OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 100);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã OCR
    ocrResults = testOCRData;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    document.getElementById('ocr-results').classList.remove('hidden');
    document.getElementById('fields-count').textContent = Object.keys(ocrResults.fields).length;
    
    setTimeout(() => {
      console.log('‚ú® –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ñ–æ—Ä–º–µ...');
      
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–µ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      currentStep = 4;
      updateStepIndicator();
      showStep(4);
      showOCRConfidence();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ OCR
      document.getElementById('view-ocr-details-btn').classList.remove('hidden');
      
      // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –ø–∞—É–∑—É
      setTimeout(() => {
        const fillResult = autoFillForm();
        
        if (fillResult && fillResult.success) {
          showNotification(`üöÄ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ó–∞–ø–æ–ª–Ω–µ–Ω–æ ${fillResult.filledCount} –ø–æ–ª–µ–π`, 'success');
          
          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
          setTimeout(() => {
            const formEl = document.getElementById('delivery-form');
            if (formEl && typeof formEl.scrollIntoView === 'function') {
              formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500);
          
        } else {
          showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
        }
      }, 300);
      
    }, 800);
  }, 1500);
}

</script>

<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}