<!-- Модальное окно для отчета о прогрессе проекта -->
<div id="progressModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-chart-line text-primary-blue mr-2"></i>
                    Отчет о прогрессе работ
                </h3>
                <button onclick="closeProgressModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="progressForm" class="space-y-4">
                <input type="hidden" id="progress-project-id" name="project_id">
                
                <div>
                    <label for="progress-date" class="block text-sm font-medium text-gray-700 mb-1">
                        Дата отчета *
                    </label>
                    <input type="date" id="progress-date" name="report_date" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="progress-percentage" class="block text-sm font-medium text-gray-700 mb-1">
                            Общий прогресс (%) *
                        </label>
                        <input type="number" id="progress-percentage" name="progress_percentage" min="0" max="100" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="progress-workers" class="block text-sm font-medium text-gray-700 mb-1">
                            Количество работников
                        </label>
                        <input type="number" id="progress-workers" name="workers_count" min="0"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label for="progress-work-type" class="block text-sm font-medium text-gray-700 mb-1">
                        Выполняемые работы *
                    </label>
                    <select id="progress-work-type" name="work_type" required multiple
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                        <option value="earthwork">Земляные работы</option>
                        <option value="foundation">Фундаментные работы</option>
                        <option value="concrete">Бетонные работы</option>
                        <option value="installation">Монтажные работы</option>
                        <option value="finishing">Отделочные работы</option>
                        <option value="landscaping">Благоустройство</option>
                        <option value="utilities">Инженерные коммуникации</option>
                        <option value="road">Дорожные работы</option>
                        <option value="lighting">Освещение</option>
                        <option value="security">Системы безопасности</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Удерживайте Ctrl (Cmd на Mac) для выбора нескольких вариантов</p>
                </div>
                
                <div>
                    <label for="progress-description" class="block text-sm font-medium text-gray-700 mb-1">
                        Описание выполненных работ *
                    </label>
                    <textarea id="progress-description" name="description" rows="4" required
                        placeholder="Подробно опишите выполненные за период работы..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label for="progress-challenges" class="block text-sm font-medium text-gray-700 mb-1">
                        Проблемы и препятствия
                    </label>
                    <textarea id="progress-challenges" name="challenges" rows="3"
                        placeholder="Опишите возникшие трудности, задержки, нехватку материалов и т.д."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label for="progress-next-steps" class="block text-sm font-medium text-gray-700 mb-1">
                        Планы на следующий период
                    </label>
                    <textarea id="progress-next-steps" name="next_steps" rows="3"
                        placeholder="Опишите планируемые на следующий период работы..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent"></textarea>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="progress-materials-used" class="block text-sm font-medium text-gray-700 mb-1">
                            Использовано материалов
                        </label>
                        <input type="text" id="progress-materials-used" name="materials_used"
                            placeholder="например: бетон 50м³, арматура 5т"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="progress-equipment" class="block text-sm font-medium text-gray-700 mb-1">
                            Используемая техника
                        </label>
                        <input type="text" id="progress-equipment" name="equipment_used"
                            placeholder="например: экскаватор, кран"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="progress-weather" class="block text-sm font-medium text-gray-700 mb-1">
                            Погодные условия
                        </label>
                        <select id="progress-weather" name="weather_conditions"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                            <option value="">Не указано</option>
                            <option value="sunny">Солнечно</option>
                            <option value="cloudy">Облачно</option>
                            <option value="rainy">Дождь</option>
                            <option value="snowy">Снег</option>
                            <option value="windy">Ветрено</option>
                            <option value="foggy">Туман</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="progress-photos" class="block text-sm font-medium text-gray-700 mb-1">
                        Фото отчет
                    </label>
                    <input type="file" id="progress-photos" name="photos" multiple accept="image/*"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Загрузите фотографии выполненных работ</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="progress-safety" name="safety_compliance" class="h-4 w-4 text-primary-blue focus:ring-primary-blue border-gray-300 rounded">
                        <label for="progress-safety" class="ml-2 block text-sm text-gray-700">
                            Соблюдены требования техники безопасности
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="progress-quality" name="quality_control" class="h-4 w-4 text-primary-blue focus:ring-primary-blue border-gray-300 rounded">
                        <label for="progress-quality" class="ml-2 block text-sm text-gray-700">
                            Проведен контроль качества работ
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeProgressModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue">
                        Отменить
                    </button>
                    <button type="submit" 
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-blue hover:bg-primary-blue/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Отправить отчет
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function closeProgressModal() {
    document.getElementById('progressModal').classList.add('hidden');
    document.getElementById('progressForm').reset();
}

// Устанавливаем текущую дату при открытии модала
document.getElementById('progressModal').addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('progress-date').value = today;
});

// Устанавливаем текущую дату при загрузке страницы
window.addEventListener('load', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('progress-date').value = today;
});

document.getElementById('progressForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Получаем выбранные типы работ
    const workTypes = Array.from(document.getElementById('progress-work-type').selectedOptions)
                          .map(option => option.value);
    formData.set('work_types', JSON.stringify(workTypes));
    
    try {
        const response = await fetch('/api/progress-reports/', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Отчет о прогрессе успешно отправлен!');
            closeProgressModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Ошибка отправки отчета: ' + (error.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('Ошибка: ' + error.message);
    }
});
</script>